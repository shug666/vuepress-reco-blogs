---
title: 应用启动耗时统计
date: 2024-11-23
tags:
 - android
categories: 
 - android
sticky: 
   true
---

## 方式一：Displayed日志

```shell
11-23 10:19:29.119  1152  1240 I ActivityTaskManager: Displayed com.android.settings/.Settings$NetworkDashboardActivity for user 0: +668ms
```

那么我们要统计计时，其实只要弄清楚这个日志的时间怎么计算出来的。跟踪源码，全局搜索Displayed发现

**ActivityMetricsLogger#logAppDisplayed**

```java
private void logAppDisplayed(TransitionInfoSnapshot info) {
	if (info.type != TYPE_TRANSITION_WARM_LAUNCH && info.type != TYPE_TRANSITION_COLD_LAUNCH) {
		return;
	}

	EventLog.writeEvent(WM_ACTIVITY_LAUNCH_TIME,
			info.userId, info.activityRecordIdHashCode, info.launchedActivityShortComponentName,
			info.windowsDrawnDelayMs);

	StringBuilder sb = mStringBuilder;
	sb.setLength(0);
	sb.append("Displayed ");
	sb.append(info.launchedActivityShortComponentName);
	sb.append(": ");
	TimeUtils.formatDuration(info.windowsDrawnDelayMs, sb);
	Log.i(TAG, sb.toString());
}
```

可以看到重点就是这个时间**info.windowsDrawnDelayMs**，那么这个数据是怎么来的呢？

![在这里插入图片描述](https://raw.githubusercontent.com/shug666/image/main/imagesf0c305550c894958bcda1ce590463c2d.png)



## 方式二：doFrame

![](https://raw.githubusercontent.com/shug666/image/main/images9a158aba4b755abeec57f49bc7ac0f55.png)

怎么确认5是首帧的绘制，startingWindow算不算首帧？

1 -> launcher 点击

2,3,4都是在ActivityThread中执行，在doFrame前进行合成

![](https://i-blog.csdnimg.cn/blog_migrate/81ab8dc13c14baa21d21062c86bd5541.png)

renderThread启动, AttachCurrentThread初始化JNIenv ，建立native java通讯

## 方式三：wm日志

过滤`wm_`日志

```shell
03-07 16:19:40.172  1000  1874  6684 I wm_create_activity: [0,192420576,20,com.UCMobile/com.uc.browser.InnerUCMobile,NULL,NULL,NULL,268435456]
03-07 16:19:40.176  1000  1874  6684 I wm_pause_activity: [0,94051834,com.UCMobile/.main.UCMobile,userLeaving=true,resumeTopActivity]
03-07 16:19:40.191  1000  1874  6684 I wm_finish_activity: [0,94051834,20,com.UCMobile/.main.UCMobile,app-request]
03-07 16:19:40.194 10245 13316 13316 I wm_on_create_called: [0,94051834,com.UCMobile.main.UCMobile,performCreate,171]
03-07 16:19:40.266  1000  1874  3389 I wm_add_to_stopping: [0,94051834,com.UCMobile/.main.UCMobile,completeFinishing]
03-07 16:19:40.269  1000  1874  3389 I wm_add_to_stopping: [0,36426290,com.miui.home/.launcher.Launcher,makeInvisible]
03-07 16:19:40.273  1000  1874  3389 I wm_restart_activity: [0,192420576,20,com.UCMobile/com.uc.browser.InnerUCMobile]
03-07 16:19:40.276  1000  1874  3389 I wm_set_resumed_activity: [0,com.UCMobile/com.uc.browser.InnerUCMobile,minimalResumeActivityLocked - onActivityStateChanged]
03-07 16:19:40.283  1000  1874  1988 I wm_destroy_activity: [0,94051834,20,com.UCMobile/.main.UCMobile,finish-imm:idle]
03-07 16:19:40.305  1000  1874  3389 I wm_requested_orientation: [1,com.UCMobile]
03-07 16:19:40.373 10245 13316 13316 I wm_on_create_called: [0,192420576,com.uc.browser.InnerUCMobile,performCreate,79]
03-07 16:19:40.398 10245 13316 13316 I wm_on_start_called: [0,192420576,com.uc.browser.InnerUCMobile,handleStartActivity,18]
03-07 16:19:40.414 10245 13316 13316 I wm_on_resume_called: [0,192420576,com.uc.browser.InnerUCMobile,RESUME_ACTIVITY,14]
03-07 16:19:40.502 10245 13316 13316 I wm_on_top_resumed_gained_called: [192420576,com.uc.browser.InnerUCMobile,topStateChangedWhenResumed]
03-07 16:19:40.508 10245 13316 13316 I wm_on_destroy_called: [0,94051834,com.UCMobile.main.UCMobile,performDestroy,6]
03-07 16:19:40.663  1000  1874  1985 I wm_activity_launch_time: [0,192420576,com.UCMobile/com.uc.browser.InnerUCMobile,1042]
```

`wm_activity_launch_time` 看到了一个时间，怎么确定这个时间是首页展示的时间。

![](https://raw.githubusercontent.com/shug666/image/main/images049dba08ccb0f7f72793bd267f6caf73.png)

```java
int calculateDelay(long timestampNs) {
    // Shouldn't take more than 25 days to launch an app, so int is fine here.return (int) TimeUnit.NANOSECONDS.toMillis(timestampNs - mTransitionStartTimeNs);
}

//mTransitionStartTimeNs 在activitystarter.startResolvedActivity中赋值，即点击桌面图标的时候 （表示图标动画开启）？
//这里可以确定
```

![](https://raw.githubusercontent.com/shug666/image/main/images26479e1aaea495cd5da54d31b2141df2.png)

![](https://raw.githubusercontent.com/shug666/image/main/imagesc10b2efd1809c280f94803803eb14547.png)

在notifyWindowDrawn -> done中的trace，可以侧面印证在 5：doFrame中绘制的UC首帧, 并且跟evets\[ wm\_activity\_launch\_time\]统计的时间只差6ms

![](https://raw.githubusercontent.com/shug666/image/main/images221bd4f20244443492e251cf1b4db043.png)

## 方式三: am start

`adb shell am start -W com.android.settings/.Settings$NetworkDashboardActivity`

```shell
Starting: Intent { act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER] cmp=com.android.settings/.Settings }
Status: ok
LaunchState: WARM
Activity: com.android.settings/.Settings$NetworkDashboardActivity
TotalTime: 671
WaitTime: 675
Complete
```

  

https://blog.csdn.net/qq_31302233/article/details/142526353

本文转自 [https://blog.csdn.net/congqingbin/article/details/129429201](https://blog.csdn.net/congqingbin/article/details/129429201)，如有侵权，请联系删除。