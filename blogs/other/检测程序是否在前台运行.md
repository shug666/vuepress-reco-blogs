---
title: android 栈顶Activity和发送keycode按键
date: 2022-10-25
tags:
 - android
categories: 
 - android
sticky: 
   true
---

## 检测程序是否在前台运行

```java
ActivityManager mActivityManager = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);
List<ActivityManager.RunningTaskInfo> rti = mActivityManager.getRunningTasks(1);
String pname = rti.get(0).topActivity.getPackageName();
//或者
//String activity_name = mAm.getRunningTasks(1).get(0).topActivity.getClassName();
```

adb命令查看当前栈顶的Activity

```sh
dumpsys activity | grep "mFoc"
```

## Android代码中发送Keycode按键

有时候在代码中需要模拟一些用户操作的按键，例如TV 中遥控器的按键，一些测试脚本的编写。再比如android手机中虚拟按键，以及悬浮窗中的返回功能，等等。都是模拟发送按键来操作。

这里介绍三种方法，来实现用代码模拟发送按键。目前我都是在系统中（有系统签名和shareuid）测试的。如果第三方app想要调用使用，不知权限是否够。

### 1.调用input 命令

使用过串口的都明白，如果需要debug 模拟按键，会使用 input keyevent 的方法。这个使用android runtime 模拟执行命令。值得一提的是，有些情况下有人想在代码里调用 adb shell xxx也可以用类似的方式：

```java
try{
       String keyCommand = "input keyevent " + KeyEvent.KEYCODE_1;
       Runtime runtime = Runtime.getRuntime();
       Process proc = runtime.exec(keyCommand);
} catch(IOException e){
}
```

### 2.在线程中使用Instrumentation

这个方法必须要在线程中执行才有效：

```java
import android.app.Instrumentation;
 
sendKeyCode(KeyEvent.KEYCODE_DPAD_UP);
 
private void sendKeyCode(final int keyCode){
	new Thread() {
		public void run() {
            try {
                Instrumentation inst = new Instrumentation();
                inst.sendKeyDownUpSync(keyCode);
            } catch (Exception e) {
                e.printStackTrace();
            }
         }
    }.start();
 }
```

### 3.调用InputManager api

（android 系统虚拟按键就是使用这种方法）InputManager.getInstance().injectInputEvent 为隐藏方法，如果不是在系统中使用，则需要使用反射，或者将源码导入app，使其编译不报错。

```java
long now = SystemClock.uptimeMillis();
 
KeyEvent down = new KeyEvent(now, now, KeyEvent.ACTION_DOWN, KeyEvent.KEYCODE_1, 0);
InputManager.getInstance().injectInputEvent(down,     
           InputManager.INJECT_INPUT_EVENT_MODE_ASYNC);
 
KeyEvent up = new KeyEvent(now, now, KeyEvent.ACTION_UP, KeyEvent.KEYCODE_1, 0);
InputManager.getInstance().injectInputEvent(up, 
          InputManager.INJECT_INPUT_EVENT_MODE_ASYNC);
```