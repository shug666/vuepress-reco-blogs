---
title: android 应用列表和卸载应用
date: 2022-12-07
tags:
 - android
categories: 
 - android
sticky: 
   true
---

##  应用列表

 获取手机上已安装应用列表，将获取到的信息用集合返回，可以自己定义是否过滤系统应用，Appinfo是一个实体类，包含应用的名称 包名 图标icon等等

```java
 /**
     * 获取手机已安装应用列表
     * @param ctx
     * @param isFilterSystem 是否过滤系统应用
     * @return
     */
    public static ArrayList<AppInfo> getAllAppInfo(Context ctx,boolean isFilterSystem) {
        ArrayList<AppInfo> appBeanList = new ArrayList<>();
        AppInfo bean = null;
 
        PackageManager packageManager = ctx.getPackageManager();
        List<PackageInfo> list = packageManager.getInstalledPackages(0);
        for (PackageInfo p : list) {
            bean = new AppInfo();
            bean.setIcon(p.applicationInfo.loadIcon(packageManager));
            bean.setLabel(packageManager.getApplicationLabel(p.applicationInfo).toString());
            bean.setPackage_name(p.applicationInfo.packageName);
            int flags = p.applicationInfo.flags;
            // 判断是否是属于系统的apk
            if ((flags & ApplicationInfo.FLAG_SYSTEM) != 0&&isFilterSystem) {
//                bean.setSystem(true);
            } else {
                appBeanList.add(bean);
            }
        }
        return appBeanList;
    }
```

```java
public class AppInfo {
    public int uid;
    public String label;//应用名称
    public String package_name;//应用包名
    public Drawable icon;//应用icon
    
    public AppInfo() {
        uid = 0;
        label = "";
        package_name = "";
        icon = null;
    }
 
    public int getUid() {
        return uid;
    }
 
    public void setUid(int uid) {
        this.uid = uid;
    }
 
    public String getLabel() {
        return label;
    }
 
    public void setLabel(String label) {
        this.label = label;
    }
 
    public String getPackage_name() {
        return package_name;
    }
 
    public void setPackage_name(String package_name) {
        this.package_name = package_name;
    }
 
    public Drawable getIcon() {
        return icon;
    }
 
    public void setIcon(Drawable icon) {
        this.icon = icon;
    }
}
```

## 卸载APP的三种方法

### 方法一

直接使用Intent卸载

```java
Uri uri = Uri.fromParts("package", "com.example.demo", null);
Intent intent = new Intent(Intent.ACTION_DELETE, uri);
```

这是最简单的方式，调用卸载方法系统会弹出卸载APP对话框，点击确定就会立即卸载，不需要额外权限

### 方法二

使用PackageManager静默卸载，谷歌认为该方法是不安全的行为，因此该接口是@hide的，不是公开的接口，调用此接口需要有系统签名和相应的系统级权限

具体来说就是需要
`<uses-permission android:name="android.permission.DELETE_PACKAGES"/>`权限，但`<uses-permission android:name="android.permission.DELETE_PACKAGES"/>` 是系统级权限，普通APP根本无法获取到，如果在AndroidManifest.xml强行加入该权限编译也无法通过，唯一的办法就是使用APK反编译工具在Android Studio之外修改权限，比如用apktool反编译工具先把apk文件解压出来，用编辑器在AndroidManifest.xml中加入上面的两个权限，然后在用工具apktool重新打包

获得`<uses-permission android:name="android.permission.DELETE_PACKAGES"/>`权限后，定义PackageDeleteObserver实现类，实现packageDeleted方法

```java
private class PackageDeleteObserver extends IPackageDeleteObserver.Stub {  
    private int position;  
    private int mFlag;  

    public PackageDeleteObserver(int index, int flag) {  
        position = index;  
        mFlag = flag;// 0卸载1个包，1卸载N个包 N>1  
    }  

    @Override  
    public void packageDeleted(String arg0, int arg1)  
            throws RemoteException {  
        // TODO Auto-generated method stub 
        Message msg;  
        msg = mHandle.obtainMessage();  
        msg.what = FLAG_DELETE_VIRUS;  
        msg.arg1 = position;  
        msg.arg2 = mFlag;  
        msg.sendToTarget();  
    }  
}  
```

获取PackageManager 对象，调用deletePackage方法

```java
PackageManager pkgManager = mContext.getPackageManager();  
PackageDeleteObserver observer = new PackageDeleteObserver(currVirus, 1);  
pkgManager.deletePackage(pakName, observer, 0);  
```

最后，还需要进行系统签名才能使用

对apk进行系统签名：

```
java -jar signapk.jar platform.x509.pem platform.pk8 test.apk test_signed.apk1
```

将签名之后的文件 push到手机中，需要root权限

### 方法三

通过pm命令方式实现静默卸载，该方法直接对Android系统执行卸载命令，需要root权限

```java
//pm命令可以通过adb在shell中执行，同样，我们可以通过代码来执行 
public static String execCommand(String... command) {
    Process process = null;
    InputStream errIs = null;
    InputStream inIs = null;
    String result = "";
    try {
        process = new ProcessBuilder().command(command).start();
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        int read = -1;
        errIs = process.getErrorStream();
        while ((read = errIs.read()) != -1) {
            baos.write(read);
        }
        inIs = process.getInputStream();
        while ((read = inIs.read()) != -1) {
            baos.write(read);
        }
        result = new String(baos.toByteArray());
        if (inIs != null)
            inIs.close();
        if (errIs != null)
            errIs.close();
        process.destroy();
    } catch (IOException e) {

        result = e.getMessage();
    }
    return result;
}
```

执行卸载命令

```java
execCommand("pm","uninstall", "packageName");
```

编译生成apk时，要在manifest文件下添加Android:sharedUserId=”android.uid.system”

```xml
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"  
     package="com.xieyuan.mhfilemanager"  
     android:versionCode="1"  
     android:versionName="1.0"  
     android:installLocation="internalOnly"  
     android:sharedUserId="android.uid.system" >  
```

