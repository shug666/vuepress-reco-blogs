---
title: 配置遥控器
date: 2022-08-19
---

## 2853R配置遥控器

直接在RTD2853R\customer\IR目录下创建相应的.config文件，然后编译脚本source build.sh ，需注意的是在要编译的脚本里面指定.config文件，目前已经适配过的IR协议有：NEC、KONKA、SONY、三星

<a data-fancybox title="image-20220817175130793" href="https://raw.githubusercontent.com/shug666/image/master/images/image-20220817175130793.png">![image-20220817175130793](https://raw.githubusercontent.com/shug666/image/master/images/image-20220817175130793.png)</a>

.config文由三部分组成，

- 第一个列是protocol，遥控器的协议。
- 第二列是按键的码值，
- 第三列是keycode，也就是我们要上报的值

<a data-fancybox title="image-20220817174302882" href="https://cdn.jsdelivr.net/gh/shug666/image/images/image-20220817174302882.png">![image-20220817174302882](https://cdn.jsdelivr.net/gh/shug666/image/images/image-20220817174302882.png)</a>

## 查看和设置协议的方式

在配置遥控器之前，需要设置对应的协议，目前已经配置过的遥控器协议有NEC、KONKA,C03.	

在串口下

```sh
cat /sys/venus_ir/ir_protocol
```

<a data-fancybox title="img" href="https://cdn.jsdelivr.net/gh/shug666/image/images/wps2.jpg">![img](https://cdn.jsdelivr.net/gh/shug666/image/images/wps2.jpg)</a>

同时也可以设置需要的遥控协议，比如

**无权限时需要输入su命令**

```sh
echo 1 > /sys/venus_ir/ir_protocol
```

## 查看遥控器码值

串口下输入：

```sh
echo 1 >/sys/venus_ir/ir_decode_debug
echo 8 > /proc/sys/kernel/printk
```

按下遥控按键，看到如下**REG_IR_RP** = [A45BFB04] 就是 得到的ir 键值。

<a data-fancybox title="img" href="https://cdn.jsdelivr.net/gh/shug666/image/images/wps3.jpg">![img](https://cdn.jsdelivr.net/gh/shug666/image/images/wps3.jpg)</a>

## 编译时的操作

在main_process.sh脚本中的set_IR_Protocol方法里

```sh
cp -f ${ir_config_file} ${ir_bin_tool}/customer/ir_table.config
rm -rf "${ir_bin_tool}/out/" && mkdir -p ${ir_bin_tool}/out/
make -C ${ir_bin_tool} ir_table_bin

perl ${toptech_config_path}/scripts/generate_ir_c.pl ${ir_config_file}  ${toptech_config_path}/tmp/${config_remote_name}.c || exit 1;
cp -f ${toptech_config_path}/tmp/${config_remote_name}.c ${root_path}/kernel/linux/linux-4.14/drivers/rtk_kdriver/ir/ir_table/ir_table_default.c
```

1. 将RTD2853R\customer\IR目录下的xxx.config文件拷贝到kernel/android/R/vendor/realtek/tool/image_file_creator/ir_bin_tool/customer/ir_table.config，并清空\ir_bin_tool\out目录（先删除再创建）
2. 在ir_bin_tool目录下执行make ir_table_bin命令会在ir_bin_tool/out产生ir_table.bin文件,同时也会拷贝到kernel/android/R/vendor/realtek/common/ATV/data/factory_ro目录下
3. 在ir_bin_tool 路径下cmd: make ir_def_table, 自动产生/kernel/linux/linux-4.14/drivers/rtk_kdriver/ir/ir_table/ir_table_default.c文件。（脚本中调用了generate_ir_c.pl将xxx.config生成xxx.c并拷贝到/kernel/linux/linux-4.14/drivers/rtk_kdriver/ir/ir_table/ir_table_default.c）

> 注意：IR的默认协议取决于ir_table.config文件最上面的协议，脚本在编译时候会解析该协议，写入到000Bootparam.h，所以我们在有不同协议的ir_table.config文件里面需要根据需要调整码值位置。

## 根据按键码值判断协议

1 代表ir 协议，也就是nec 码，0xf40b（0b 是码值，f4按位或0b ==ff）头码低高八位反码，头码低八位反码，这个应该也适用于三星码

10 ir协议，konka码，0x四个0，加上头码低八位，加上码值，因为konka 码目前只配过这一次，目前只能找到这个规律。

## 按键复用问题

复用的配置文件_tv_keys.xml放在customers/IR/下面。文件里面修改的话key ir 填入遥控器的名字。

Linkedname表示需要复用的这个按键的实际码值。Key name代表的是需要被复用成的按键。例如

<a data-fancybox title="img" href="https://cdn.jsdelivr.net/gh/shug666/image/images/wps1.jpg">![img](https://cdn.jsdelivr.net/gh/shug666/image/images/wps1.jpg)</a>

linkedName = KEYCODE_MEDIA_PLAY_PAUSE代表这个按键的实际keycode 是这个播放暂停键。Key name =KEYCODE_TIMESHIFT.代表这个播放暂停按键要复用时移按键。

目前已经复用的按键都在xml 注释中体现出来了，如果没有体现出来的，那么需要改代码了，这个就建议让RD协助添加这部分。

## 2851添加遥控器按键流程

**1.在\RTD2853R\customer\IR\xxx.config 中添加未定义的keycode**

```c
 示例：1,0XB9469F00,KEY_ZERO_FACTORY
```

**2.在\RTD2853R\kernel\linux\linux-4.14\include\uapi\linux\input-event-codes.h文件中添加示例：**

```c
#define KEY_ZERO_FACTORY   0x393
```

(**添加这个 值时建议按照顺序添加，方便以后添加按键以及进行代码维护)**

<a data-fancybox title="image-20220819114747152" href="https://cdn.jsdelivr.net/gh/shug666/image/images/image-20220819114747152.png">![image-20220819114747152](https://cdn.jsdelivr.net/gh/shug666/image/images/image-20220819114747152.png)</a>



**3.在\RTD2853R\kernel\android\R\device\realtek\common\keylayout\venus_IR_input.kl 中添加一个Key值  keycode**

```c
 示例：key 915 ZERO_FACTORY
```

<a data-fancybox title="image-20220819114505445" href="https://cdn.jsdelivr.net/gh/shug666/image/images/image-20220819114505445.png">![image-20220819114505445](https://cdn.jsdelivr.net/gh/shug666/image/images/image-20220819114505445.png)</a>

> 注:venus_IR_input.kl文件是一个映射文件，是标准 linux 与android 的键值映射文件，可以有很多个。如 0x393 是在 input-event-codes.h 中定义的，kernel 层传到 android 中的值就是 915(0x393 的十进制)。

**4.在\RTD2853R\kernel\android\R\frameworks\native\include\input\InputEventLabels.h 文件的**

```c
static const InputEventLabel KEYCODES[] = {}数组中添加 keylable.如：
DEFINE_KEYCODE(ZERO_FACTORY)
```

**5.在Z:\RTD2853R\kernel\android\R\frameworks\native\include\android\keycodes.h文件中enum{}中添加 keycode.**

```c
示例： enum{
	AKEYCODE_ZERO_FACTORY=461,
}
```

**注：(添加这个值时建议按照顺序添加，方便以后添加按键以及进行代码维护)**

**此处keycodes.h 里的值即是上面keylable定义在数组中的位 置(index)**

> 这个文件映射的是Android中的键值，这个键值和InputEventLabel.h文件中数组添加的键名有一个映射关系，Android也是借此实现了从Linux键值到Android键值的映射
>
> 修改这个文件很简单，只要在enum中添加如下值就好了

**6.在 \RTD2853R\kernel\android\R\frameworks\base\core\java\android\view\KeyEvent.java中**

```java
public class KeyEvent extends InputEvent implements Parcelable {}类中去添加变量

示例：public static final int KEYCODE_ZERO_FACTORY = 461;
```

***\*注：\**修改public static final int TOPTECH_ADD_END = KEYCODE_ZERO_FACTORY;**

> Andriod借此文件把键值从c语言转到java语言。
>
> 变量名字与keycodes.h中比较少了开头的A，键值保持不变。

**7.在\RTD2853R\kernel\android\R\frameworks\base\core\res\res\values\attrs.xml文件中**

```xml
<attr>标签中添加示例：
<enum name="KEYCODE_ZERO_FACTORY" value="461" />
```

**8.两种方式测试：**

（1）在AS的任一demo中MainActicity中添加onKeyup方法（这种方式便于测试按键）

```java
示例：public boolean onKeyUp(int keyCode, KeyEvent event) {
        boolean result = true;
        if (keyCode ==461) {
        Log.d("zero","------add key successfully..."); 
        return true;
	}
}
```

 **通过adb connect ip(板卡ip，在串口ifconfig)命令连接板卡，在AS中直接安装到TV平台**

 （2）\RTD2853R\kernel\android\R\external\replicaisland\src\com\replica\replicaisland\MainMenuActivity.java

在 MainMenuActivity 代码的 onKeyup()方法中添加打印，方便测试添加按键是否成功。(也可以在其他活动中添加打印，注意导包)

```java
示例： public boolean onKeyUp(int keyCode, KeyEvent event) {
     // TODO Auto-generated method stub
    switch (keyCode) { 
        case KeyEvent.KEYCODE_ZERO_FACTORY:{

            Log.d("zero","------add key successfully..."); 

        return true; 
    }
}
```

**9.PhoneWindowManager 添加按键功能**

接下来就是处理自己的功能了，此时按键已经通过 onKeyEvent()拿到，如果你想全局处理，可以在 PhoneWindowManager 的

interceptKeyBeforeQueueing 方法添加功能，如:

![img](https://raw.githubusercontent.com/shug666/image/main/images/a2090e03b7dd4c1a8d110d3e36b72475.png)

**10.添加完成后需要在\RTD2853R\kernel\android\R目录下使用*make update-api*命令对current.txt（/kernel/android/R/frameworks/base/api/current.txt目录下文件）进行更新。**

可用git status 查看文件修改(不更新编译时会报错)

**注意：提交代码时需要提交current.txt****

**11.用对应客户脚本编译代码（脚本里的遥控器编号需与\RTD2853R\customer\IR下编写的对应），编译无误后将系统烧到板子上**

在串口中输入 ***\*logcat -s "tag值"\**** 查看打印结果。结果正确表示添加按键成功

 

## 注意事项

编译build.sh的时候会提示下面三个命令，每次提示错误后，依次执行编译即可

执行make命令如果报错找不到命令则要执行source build/envsetup.sh，然后输入lunch命令

[可参考build/envsetup.sh 简介](https://blog.csdn.net/a567890k/article/details/79412382)

make api-stubs-docs-non-updatable-update-current-api

make api-stubs-docs-update-current-api

make test-api-stubs-docs-update-current-api







使用git clone克隆时可以先使用武汉地址拉下来，然后修改.git/config文件为深圳地址然后pull命令更新这样更节省时间

武汉地址ssh://git@162.168.0.245/RTD2853R

深圳地址ssh://git@58.250.251.47:20111RTD2853R



