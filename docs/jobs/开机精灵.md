---
title: 开机精灵
date: 2022-08-14
---

## Android初探开机引导

做开机引导，主要要做到的效果就是**只有第一次使用的时候会打开，只打开一次，当执行完开机引导的流程之后，之后开机都不会再展示**

要实现开机引导，那么就一定是系统应用，按照原理来说，需要两个步骤，第一，需要引导页的优先级比LAUNCHER高。第二，需要流程完毕之后执行某些操作让应用下次不会启动。

> LAUNCHER
>
> 使用这个种类来让一个 Activity 作为应用程序的启动项

### 1. 设置应用的优先级

可以设置android:priority属性，系统会判断启动priority优先级高的。

```xml
<activity
    android:name=".MainActivity"
    android:label="@string/app_name"
    android:launchMode="singleTask" >
    <!--设置priority属性让自己的优先级比默认Launcher高-->
    <intent-filter android:priority="2">
        <action android:name="android.intent.action.MAIN" />

        <category android:name="android.intent.category.DEFAULT" />
        <!--设置android.intent.category.HOME属性让自己成为一个Launcher-->
        <category android:name="android.intent.category.HOME" />
        <category android:name="android.intent.category.SETUP_WIZARD" />
    </intent-filter>
</activity>
```

这样配置之后，其它应用的优先级如果没有设置的话默认就是0，这样就会优先打开引导页。

> android.intent.category.HOME
>
> HOME Activity 是设备启动（登陆屏幕）时显示的第一个 Activity 。通过指定 Intent Filter 为 HOME 种类而不指定动作的话，你正在将其设为本地 home 画面的替代。

> android.intent.category.SETUP_WIZARD
>
> 谷歌的开机向导的应用是com.google.android.setupwizard`应用，可以运行在launcher之前的apk
>
> [packages\apps\Provision\DefaultActivity,这部分内容见超链接](https://www.jianshu.com/p/f31ad1b86f42)
>
> 需将`Provision`内置到`/system/product/priv-app/`目录下，这是因为不在这个目录下的应用设置`android:priority`属性会被重置为0

### 2. 禁用HOME键及锁屏

自己可以在引导页中写自己想要做的逻辑。当执行完所有逻辑之后，需要配置

```java
 Settings.Secure.putInt(getContentResolver(), Settings.Secure.USER_SETUP_COMPLETE, 0);
 int state = PackageManager.COMPONENT_ENABLED_STATE_DISABLED_USER;
 setApplicationEnabledSetting(this, "com.android.mc.rtk", state, SYNCHRONOUS);
```

**1.使HOME失效**

`Settings.Secure.USER_SETUP_COMPLETE`：当导航app未设置完成时HOME键是不起作用的，原因就是状态控制了

**2.禁用app**

`PackageManager.COMPONENT_ENABLED_STATE_DISABLED_USER`：由用户禁用app，所以是可以重新启用的，只能setApplicationEnabledSetting()方法使用

`setApplicationEnabledSetting("com.android.mc.rtk", state, SYNCHRONOUS`)方法：是PackageManager提供的禁用app的方法，一般只能用来禁用自己，不能禁用其他app，否则会报错误，因为系统会判断禁用的应用uid和当前应用的uid是否一致，如果不一致，就会报错。

### 3.开机引导完成后

```java
private void finishSetup() {
    // 添加持久设置以允许其他应用程序知道设备已配置。
    Settings.Global.putInt(getContentResolver(), Settings.Global.DEVICE_PROVISIONED, 1);
    //这个标记位标识当前用户已经走完引导流程，如果不设置这个值，Home键、锁屏等将不可用
    Settings.Secure.putInt(getContentResolver(), Settings.Secure.USER_SETUP_COMPLETE, 1);
    
    // 从PackageManager中禁用该Activity。
    pm.setComponentEnabledSetting(name, PackageManager.COMPONENT_ENABLED_STATE_DISABLED,
                PackageManager.DONT_KILL_APP);
}
```

启用或者禁用四大组件()

```java
pm.setComponentEnabledSetting(name, state, DONT_KILL_APP | SYNCHRONOUS);
```

>  componentName：组件名称 
>
>  newState：组件新的状态，可以设置三个值，分别是如下： 
>
>  不可用状态：COMPONENT_ENABLED_STATE_DISABLED 
>
>  可用状态：COMPONENT_ENABLED_STATE_ENABLED 
>
>  默认状态：COMPONENT_ENABLED_STATE_DEFAULT 
>
>  flags:行为标签,值可以是DONT_KILL_APP或者0. 0说明杀死包含该组件的app 

## 调试启动开机精灵

```java
1.通过如下命令使能进入开机向导
adb shell
settings put global device_provisioned 0
settings put secure user_setup_complete 0
//开启Provision应用的DefaultActivity
pm enable -n com.android.provision/com.android.provision.DefaultActivity
//或者
//开启Demo的MainActivity
pm enable -n com.toptech.setupwizard/.MainActivity
sync
//重启
reboot

2.查询settings的值
settings get global device_provisioned
settings get secure user_setup_complete

3.通过代码实现
Settings.Global.putInt(mContext.getContentResolver(), Settings.Global.DEVICE_PROVISIONED, 0);
Settings.Secure.putInt(mContext.getContentResolver(), Settings.Secure.USER_SETUP_COMPLETE, 0);
ComponentName name = new ComponentName("com.android.provision", "com.android.provision.DefaultActivity");
mContext.getPackageManager().setComponentEnabledSetting(name,PackageManager.COMPONENT_ENABLED_STATE_ENABLED, PackageManager.DONT_KILL_APP);
```

## 参考链接

[Android初探开机引导](https://www.jianshu.com/p/6f8e62911d3c)

[Android自定义开机引导最强篇](https://www.jianshu.com/p/f31ad1b86f42)

[setComponentEnabledSetting和setApplicationEnabledSetting](https://blog.csdn.net/StudyOfAndroid/article/details/109678471)
