---
title: 系统属性
date: 2022-08-24
---

> 在android 系统中，为统一管理系统的属性，设计了一个统一的属性系统。**每个属性都有一个名称和值**，他们都是字符串格式。属性被大量使用在Android系统中，用来记录**系统设置或进程之间的信息交换**。**属性是在整个系统中全局可见的。每个进程可以get/set属性**。在编译的过程中会将各种系统参数汇总到build.prop 以及system.prop 这两个文件中，主要属性集中在build.prop中。系统在开机后将读取配置信息并构建共享缓冲区，加快查询速度。

系统属性简单来说是用来存储系统中某些键值对数据，具有全局性、存取灵活方便的特点。

## 一 终端prop命令

在终端设备中，可以通过以下命令进行prop调试。

### 1.1 查看prop

```shell
#查看系统所有props
$getprop
...
[persist.sys.timezone]: [Asia/Shanghai]   //时区
[ro.system.build.type]: [userdebug]       //系统编译类型
[vendor.display.lcd_density]: [320]       //屏幕密度
...

#获取时区属性persist.sys.timezone的值
$getprop persist.sys.timezone
Asia/Shanghai

#过滤属性名或属性值含有关键字"timezone"的属性
$getprop | grep timezone
[persist.sys.timezone]: [Asia/Shanghai]

#获取不存在的属性时结果为空
$getprop hello
```

### 1.2 设置prop

```shell
$getprop my.prop.test    //属性my.prop.test为空
$setprop my.prop.test 123    //设置属性my.prop.test为123
$getprop my.prop.test    //获取属性my.prop.test为123
123
```

setprop 可以给属性设置int、bool、string等基本类型

### 1.3 监听prop

显示属性值发生变化的值

```sh
$watchprops
[my.prop.test]: [123456]
```

## 二 get和set prop代码流程

### 2.1 get和set prop代码流程图

涉及的代码路径汇总如下：

```
frameworks\base\core\java\android\os\SystemProperties.java
frameworks\base\core\jni\android_os_SystemProperties.cpp
system\core\base\properties.cpp
system\core\init\main.cpp
system\core\init\init.cpp
system\core\init\property_service.cpp
system\core\property_service\libpropertyinfoparser\property_info_parser.cpp
bionic\libc\include\sys\_system_properties.h
bionic\libc\include\sys\system_properties.h
bionic\libc\bionic\system_property_set.cpp
bionic\libc\bionic\system_property_api.cpp
bionic\libc\system_properties\contexts_serialized.cpp
bionic\libc\system_properties\system_properties.cpp
bionic\libc\system_properties\prop_area.cpp
```

代码流程整体时序图如下：

![img](https://raw.githubusercontent.com/shug666/image/main/images/a3159d07668b4678965a9ede49b5ef3c.jpeg)

系统属性架构设计如下：

![img](https://raw.githubusercontent.com/shug666/image/main/images/7eb0bbd2d4694a09bf43c66c81f33b67.png)

### 2.2 代码流程介绍

[见博客Android 系统属性（SystemProperties）介绍](https://blog.csdn.net/supernova_TOP/article/details/125971945?spm=1001.2014.3001.5502)

##  三 代码中使用属性

### 3.1 java代码中使用prop

在java代码中使用prop需满足以下两点：

- import android.os.Systemproperties;
- 具有system权限：
  1. 在AndroidManifest.xml中，配置android:sharedUserId=“android.uid.system”
  2. 在Android.mk中，配置LOCAL_CERTIFICATE :=platform

 [见博客android:sharedUserId作用](https://blog.csdn.net/Jason_Lee155/article/details/118498580)

Systemproperties部分源码如下：
frameworks\base\core\java\android\os\SystemProperties.java

```java
...
public class SystemProperties {
...
   //获取属性key的值，如果没有该属性则返回默认值def
   public static String get(@NonNull String key, @Nullable String def) {
       if (TRACK_KEY_ACCESS) onKeyAccess(key);
       return native_get(key, def);
   }
...
   //设置属性key的值为val
   public static void set(@NonNull String key, @Nullable String val) {
       if (val != null && !val.startsWith("ro.") && val.length() > PROP_VALUE_MAX) {
           throw new IllegalArgumentException("value of system property '" + key
                   + "' is longer than " + PROP_VALUE_MAX + " characters: " + val);
       }
       if (TRACK_KEY_ACCESS) onKeyAccess(key);
       native_set(key, val);
   }
....
}
```

get和set pro以ActivityManagerService.java代码为例：
frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java

```java
final void finishBooting() {
  ...
  //设置开机完成标志属性sys.boot_completed
  SystemProperties.set("sys.boot_completed", "1");
}
...
private static void maybePruneOldTraces(File tracesDir) {
  ...
  //获取tombstoned.max_anr_count属性值
  final int max = SystemProperties.getInt("tombstoned.max_anr_count", 64);
}
```

获取属性值可以根据值的类型使用合适返回值类型的方法如getInt()、getBoolean()、getLong()，SystemProperties.get()获取的值为String。

### 3.3 特殊属性

#### 3.3.1 ro只读属性

ro即read only这类属性通常是系统默认属性，在系统编译或初始化时设置的。

```sh
$ getprop ro.vendor.build.version.release
10
$ setprop ro.vendor.build.version.release 9
setprop: failed to set property 'ro.vendor.build.version.release' to '9'
```

#### 3.3.2 persist持久属性

设置persist开头的属性，断电后仍能保存，值写入/data/property/proper。其他前缀的属性被设置后，只是保存在内存中而已，并没有保存到磁盘，所有重启后就恢复默认值了。

```sh
$ getprop persist.hello.test  //属性为空
$ setprop persist.hello.test abc //设置属性persist.hello.test值为abc
$ getprop persist.hello.test abc //属性get正常
abc
$reboot //重启设备
$ getprop persist.hello.test //属性为abc
abc
```

#### 3.3.3 ctl 控制属性

属性名称以”ctl.”开头，用来启动和停止服务。每一项服务必须在 init.rc 中定义。init 一旦收到设置 ctl.start 属性的请求，属性服务将使用该属性值作为服务名找到该服务，启动该服务。这项服务的启动结果将会放入 init.svc.<服务名> 属性中。

```sh
$setprop ctl.start xxx //启动某服务
$setprop ctl.stop xxx  //关闭某服务
$setprop ctl.restart xxx  //重启某服务
```

#### 3.3.4 sys.powerctl属性

sys.powerctl属性可控制设备重启关机

```sh
$setprop sys.powerctl shutdown //设备关机
$setprop sys.powerctl reboot //设备重启
```

#### 3.3.5 普通属性

设置其他格式开头的属性，断电后不能保存

```sh
$ getprop hello.test  //属性为空
$ setprop hello.test 123//设置属性persist.hello.test值为abc
$ getprop hello.test 123//属性get正常
123
$reboot //重启设备
$ getprop hello.test //属性为空
```

### 3.4 添加系统默认属性

从前面的介绍中我们知道系统开机时会load *.prop属性配置文件中的属性，因此开机后就有了默认属性。

在customer/default/tt_build.prop 中定义具体的系统属性 (另外，如果是添加以toptech_开头的 系统属性，则还需要去tt_config.mk中去添加一下要配置的系统属性) 

> 在tt_build.prop中添加完成之后，必须要提交(git add tt_build.prop), 否则会被脚本中执行的 git checkout 给清除掉

```sh
# 添加自己的系统默认属性
persist.hello.world=hello
```

> 注意：这里添加的属性前缀必须是在kernel/android/R/device/realtek/common/sepolicy/property_contexts中被定义过的
>
> make android后在out/target/product/xxx/system/build.prop 或out/target/product/xxx/vendor/build.prop可找到添加的属性persist.hello.world，则说明基本添加成功，烧录img验证即可。

然后再去 customer/scripts/init.sh 添加变量

```sh
config_world=hello
```

### 3.5 添加属性前缀

在R/device/realtek/common/sepolicy/property_contexts文件中定义系统属性的前缀，第二列也就相当于赋给这个前缀可使用的权限，当然也不止这一个文件，sepolicy目录下面的基本上都是用来做te规则的，也就是设置权限的

![image-20220824114131243](https://raw.githubusercontent.com/shug666/image/main/images/image-20220824114131243.png)

## 组织结构

系统启动的时候会从几个配置文件中加载属性的默认值，大概有以下几个文件， 在不同Android版本系统上可能不一样：

```
/default.prop 或者是 /prop.default，
/vendor/default.prop
/system/build.prop
/vendor/build.prop
/data/local.prop
/data/property/*
```

系统会按先后顺序依次加载以上文件，后加载的属性将覆盖原先的值。default.prop 的值是通过 build/tools 目录下的 buildinfo.sh 和 vendor_buildinfo.sh 生成的。
