import{_ as t,r as e,o as p,c as o,b as s,d as n,e as c,a as i}from"./app-e8f85126.js";const l={},u=i(`<h2 id="android的权限规则" tabindex="-1"><a class="header-anchor" href="#android的权限规则" aria-hidden="true">#</a> Android的权限规则</h2><h3 id="基于userid的进程级别的安全机制" tabindex="-1"><a class="header-anchor" href="#基于userid的进程级别的安全机制" aria-hidden="true">#</a> 基于UserID的进程级别的安全机制</h3><p>进程有独立的地址空间，进程与进程间默认是不能互相访问的，Android通过为每一个apk分配唯一的linux userID来实现，名称为&quot;app_&quot;加一个数字，比如app_43不同的UserID，运行在不同的进程，所以apk之间默认便不能相互访问。</p><p>Android提供了如下的一种机制，可以使两个apk打破前面讲的这种壁垒。 在AndroidManifest.xml中利用<strong>sharedUserId</strong>属性给不同的package分配相同的userID，通过这样做，两个package可以被当做同一个程序， 系统会分配给两个程序相同的UserID。当然，基于安全考虑，两个apk需要相同的签名，否则没有验证也就没有意义了</p><h3 id="默认apk生成的数据对外是不可见的" tabindex="-1"><a class="header-anchor" href="#默认apk生成的数据对外是不可见的" aria-hidden="true">#</a> 默认apk生成的数据对外是不可见的</h3><p>实现方法是：Android会为程序存储的数据分配该程序的UserID。借助于Linux严格的文件系统访问权限，便实现了apk之间不能相互访问似有数据的机制。 例：我的应用创建的一个文件，默认权限如下，可以看到只有UserID为app_21的程序才能读写该文件</p><h3 id="root权限和system权限" tabindex="-1"><a class="header-anchor" href="#root权限和system权限" aria-hidden="true">#</a> root权限和system权限</h3><ul><li><h5 id="root权限" tabindex="-1"><a class="header-anchor" href="#root权限" aria-hidden="true">#</a> root权限</h5><p>拥有root权限的用户，其uid=0. 拥有系统约定的最高权限。可以访问绝大部分文件</p></li><li><h5 id="system-权限" tabindex="-1"><a class="header-anchor" href="#system-权限" aria-hidden="true">#</a> system 权限</h5><ol><li><p>system/app 下面的apk</p></li><li><p>system/priv-app 下面的apk。</p></li></ol><p>俩者的区别在于：俩者虽然都是系统app，但是system/priv-app 中所具有的权限，要大于system/app</p></li><li><h5 id="特权权限" tabindex="-1"><a class="header-anchor" href="#特权权限" aria-hidden="true">#</a> 特权权限</h5><p>特权应用程序是位于<code>/system/priv-app</code>目录下的系统应用程序 。过去，设备制造商几乎无法控制可对特权应用授予哪些<strong>签名|特许</strong>权限。从 Android 8.0 开始，制造商必须在 <code>/etc/permissions</code> 目录下的系统配置 XML 文件中明确授予特许权限。从 Android 9 开始，实现人员必须明确授予或拒绝授予所有特许权限，否则设备将无法启动。</p></li></ul><p><code>frameworks/base/core/res/AndroidManifest.xml</code> 定义了各种广播,普通权限，危险权限，特权权限：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- Allows notifications to be colorized
     &lt;p&gt;Not for use by third-party applications. @hide --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.USE_COLORIZED_NOTIFICATIONS<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>protectionLevel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>signature|setup<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> //setting 具备的

<span class="token comment">&lt;!-- Allows access to keyguard secure storage.  Only allowed for system processes.
    @hide --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.ACCESS_KEYGUARD_SECURE_STORAGE<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>protectionLevel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>signature<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>  //系统签名

<span class="token comment">&lt;!-- Allows managing (adding, removing) fingerprint templates. Reserved for the system. @hide --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.MANAGE_FINGERPRINT<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>protectionLevel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>signature|privileged<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>  //系统签名且还需要在system/priv-app 下

<span class="token comment">&lt;!-- Allows an app to reset fingerprint attempt counter. Reserved for the system. @hide --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.RESET_FINGERPRINT_LOCKOUT<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>protectionLevel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>signatureorsystem <span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>  //系统签名且还得是系统app(system/priv-app 或system/app)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Android 权限分成四类：</p><ul><li><p>普通权限(normal permission)：也叫正常权限，即使拥有了该类权限，用户的隐私数据被泄露篡改的风险也很小。例如，设置时区的权限就是正常权限。如果应用声明其需要正常权限，系统会自动向应用授予该权限。</p></li><li><p>敏感权限(dangerous permission)：也叫危险权限，运行时权限，跟普通权限相反，一旦某个应该获取了该类权限，用户的隐私数据就面临被泄露篡改的风险。比如 <code>READ_CONTACTS</code> 权限就属于危险权限。如果应用声明其需要危险权限，则用户必须明确向应用授予该权限。</p></li><li><p>签名权限(signature permission)：该类权限只对拥有相同签名的应用开放，比如手机QQ 自定义了一个permission 且在权限标签中加入 android:protectionLevel=”signature”，而访问它的某个数据时，必须要拥有该权限。然后微信和 QQ 发布时采用相同的签名，微信就可以申请访问 QQ 中的此权限，并使用对应权限控制的数据。其他程序即使知道了这个开放数据的接口，也在 Manifest 注册了权限，但由于应用签名不同，还是无法访问的对应的数据。</p></li><li><p>系统签名权限(signatureOrSystem permission)：与 signature permission类似，但它不光要求签名相同，还要求是同类的系统级应用，一般手机厂商开发的预制应用，才会用到该类权限</p></li></ul><h2 id="应用场景1" tabindex="-1"><a class="header-anchor" href="#应用场景1" aria-hidden="true">#</a> 应用场景1：</h2><h5 id="前提-app-系统签过名且放置于system-app-下" tabindex="-1"><a class="header-anchor" href="#前提-app-系统签过名且放置于system-app-下" aria-hidden="true">#</a> 前提：app 系统签过名且放置于system/app/下</h5><h5 id="操作-调用-settings-system-putint" tabindex="-1"><a class="header-anchor" href="#操作-调用-settings-system-putint" aria-hidden="true">#</a> 操作: 调用 Settings.System.putInt</h5><h5 id="现象" tabindex="-1"><a class="header-anchor" href="#现象" aria-hidden="true">#</a> 现象：</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Caused by: java.lang.IllegalArgumentException: You cannot keep your settings <span class="token keyword">in</span> the secure settings.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="解决方案-将app-防止于system-priv-app下" tabindex="-1"><a class="header-anchor" href="#解决方案-将app-防止于system-priv-app下" aria-hidden="true">#</a> 解决方案: 将app 防止于system/priv-app下</h5><h5 id="问题-为什么放置于system-priv-app就解决了问题呢" tabindex="-1"><a class="header-anchor" href="#问题-为什么放置于system-priv-app就解决了问题呢" aria-hidden="true">#</a> 问题： 为什么放置于system/priv-app就解决了问题呢？</h5><p>源码分析:putInt方法最终会调用: enforceRestrictedSystemSettingsMutationForCallingPackage 方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">1858</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">enforceRestrictedSystemSettingsMutationForCallingPackage</span><span class="token punctuation">(</span><span class="token keyword">int</span> operation<span class="token punctuation">,</span>
<span class="token number">1859</span>            <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1860</span>        <span class="token comment">// System/root/shell can mutate whatever secure settings they want.</span>
<span class="token number">1861</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1862</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> appId <span class="token operator">=</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1863</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>appId <span class="token operator">==</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Process</span><span class="token punctuation">.</span><span class="token constant">SYSTEM_UID</span>
<span class="token number">1864</span>                <span class="token operator">||</span> appId <span class="token operator">==</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">SHELL_UID</span>
<span class="token number">1865</span>                <span class="token operator">||</span> appId <span class="token operator">==</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">ROOT_UID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1866</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">1867</span>        <span class="token punctuation">}</span>
<span class="token number">1868</span>
<span class="token number">1869</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>operation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1870</span>            <span class="token keyword">case</span> <span class="token constant">MUTATION_OPERATION_INSERT</span><span class="token operator">:</span>
<span class="token number">1871</span>                <span class="token comment">// Insert updates.</span>
<span class="token number">1872</span>            <span class="token keyword">case</span> <span class="token constant">MUTATION_OPERATION_UPDATE</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token number">1873</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Settings<span class="token punctuation">.</span>System</span><span class="token punctuation">.</span><span class="token constant">PUBLIC_SETTINGS</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1874</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">1875</span>                <span class="token punctuation">}</span>
<span class="token number">1876</span>
<span class="token number">1877</span>                <span class="token comment">// The calling package is already verified.</span>
<span class="token number">1878</span>                <span class="token class-name">PackageInfo</span> packageInfo <span class="token operator">=</span> <span class="token function">getCallingPackageInfoOrThrow</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1879</span>
<span class="token number">1880</span>                <span class="token comment">// Privileged apps can do whatever they want. 只要是特权应用，就可以直接插入数据</span>
<span class="token number">1881</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>privateFlags
<span class="token number">1882</span>                        <span class="token operator">&amp;</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">PRIVATE_FLAG_PRIVILEGED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1883</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">1884</span>                <span class="token punctuation">}</span>
<span class="token number">1885</span>                <span class="token comment">// 检查是否具备插入数据的资格，没得就会抛出异常</span>
<span class="token number">1886</span>                <span class="token function">warnOrThrowForUndesiredSecureSettingsMutationForTargetSdk</span><span class="token punctuation">(</span>
<span class="token number">1887</span>                        packageInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1888</span>            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">18</span>
<span class="token number">1910</span>    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="应用场景2" tabindex="-1"><a class="header-anchor" href="#应用场景2" aria-hidden="true">#</a> 应用场景2：</h2><h5 id="前提-国内-app-采用系统签名-放在-system-priv-app-下-但是没有添加-android-shareduserid-android-uid-system" tabindex="-1"><a class="header-anchor" href="#前提-国内-app-采用系统签名-放在-system-priv-app-下-但是没有添加-android-shareduserid-android-uid-system" aria-hidden="true">#</a> 前提：国内 app 采用系统签名，放在/system/priv-app/下，但是没有添加 android:sharedUserId=&quot;android.uid.system</h5><h5 id="操作-app本身是一个service-需要有读写权限" tabindex="-1"><a class="header-anchor" href="#操作-app本身是一个service-需要有读写权限" aria-hidden="true">#</a> 操作：app本身是一个service，需要有读写权限</h5><h5 id="现象-app中直接进行创建-删除文件-报错-提示没得读写权限" tabindex="-1"><a class="header-anchor" href="#现象-app中直接进行创建-删除文件-报错-提示没得读写权限" aria-hidden="true">#</a> 现象：app中直接进行创建/删除文件，报错，提示没得读写权限</h5><h5 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案" aria-hidden="true">#</a> 解决方案:</h5><p><code>Y:\\aosp\\device\\google\\marlin\\default-permissions.xml:</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exceptions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exception</span> <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.verizon.mips.services<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.PROCESS_OUTGOING_CALLS<span class="token punctuation">&quot;</span></span> <span class="token attr-name">fixed</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.READ_PHONE_STATE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">fixed</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.RECEIVE_SMS<span class="token punctuation">&quot;</span></span> <span class="token attr-name">fixed</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exception</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exceptions</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>default-permissions 配置文件会在<strong>第一次开机</strong>的时候加载。所以假如直接更改开发版中的default-permissions。需要格式化开发板，恢复<strong>出厂模式</strong>、</p><h2 id="应用场景3" tabindex="-1"><a class="header-anchor" href="#应用场景3" aria-hidden="true">#</a> 应用场景3:</h2><h5 id="前提-国内-app-采用系统签名-放在-system-priv-app-下-但是没有添加-android-shareduserid-android-uid-system且android-persistent-false" tabindex="-1"><a class="header-anchor" href="#前提-国内-app-采用系统签名-放在-system-priv-app-下-但是没有添加-android-shareduserid-android-uid-system且android-persistent-false" aria-hidden="true">#</a> 前提：国内 app 采用系统签名，放在/system/priv-app/下，但是没有添加 android:sharedUserId=&quot;android.uid.system且<code>android:persistent=&quot;false&quot;</code></h5><h5 id="操作-代码中直接使用startservice启动服务" tabindex="-1"><a class="header-anchor" href="#操作-代码中直接使用startservice启动服务" aria-hidden="true">#</a> 操作: 代码中直接使用startService启动服务</h5><h5 id="现象-1" tabindex="-1"><a class="header-anchor" href="#现象-1" aria-hidden="true">#</a> 现象：</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Not allowed to start <span class="token function">service</span> Intent <span class="token punctuation">{</span> <span class="token assign-left variable">flg</span><span class="token operator">=</span>0x1000000 <span class="token assign-left variable">cmp</span><span class="token operator">=</span>packagename/.servicename <span class="token punctuation">(</span>has extras<span class="token punctuation">)</span> <span class="token punctuation">}</span>: app is <span class="token keyword">in</span> background uid UidRecord<span class="token punctuation">{</span>52db80 u2357s1000 TRNB bg:+2m42s199ms idle procs:3 seq<span class="token punctuation">(</span><span class="token number">0,0</span>,0<span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="问题-app系统签名且置于-system-app-下-但是为啥startservice-还报错呢-且为什么加上android-persistent-true-就ok了呢" tabindex="-1"><a class="header-anchor" href="#问题-app系统签名且置于-system-app-下-但是为啥startservice-还报错呢-且为什么加上android-persistent-true-就ok了呢" aria-hidden="true">#</a> 问题: app系统签名且置于/system/app/下 但是为啥startService 还报错呢？且为什么加上<code>android:persistent=&quot;true&quot;就ok了呢</code></h5><h5 id="解答" tabindex="-1"><a class="header-anchor" href="#解答" aria-hidden="true">#</a> 解答：</h5><p>startService 启动服务流程中，有一个方法appServicesRestrictedInBackgroundLocked</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token keyword">int</span> <span class="token function">appServicesRestrictedInBackgroundLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span> <span class="token keyword">int</span> packageTargetSdk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Persistent app?</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageManagerInt<span class="token punctuation">.</span><span class="token function">isPackagePersistent</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_BACKGROUND_CHECK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;App &quot;</span> <span class="token operator">+</span> uid <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> packageName
                        <span class="token operator">+</span> <span class="token string">&quot; is persistent; not restricted in background&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">APP_START_MODE_NORMAL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Non-persistent but background whitelisted?</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">uidOnBackgroundWhitelist</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_BACKGROUND_CHECK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;App &quot;</span> <span class="token operator">+</span> uid <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> packageName
                        <span class="token operator">+</span> <span class="token string">&quot; on background whitelist; not restricted in background&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">APP_START_MODE_NORMAL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Is this app on the battery whitelist?</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOnDeviceIdleWhitelistLocked</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> <span class="token comment">/*allowExceptIdleToo=*/</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_BACKGROUND_CHECK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;App &quot;</span> <span class="token operator">+</span> uid <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> packageName
                        <span class="token operator">+</span> <span class="token string">&quot; on idle whitelist; not restricted in background&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">APP_START_MODE_NORMAL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// None of the service-policy criteria apply, so we apply the common criteria</span>
        <span class="token keyword">return</span> <span class="token function">appRestrictedInBackgroundLocked</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> packageName<span class="token punctuation">,</span> packageTargetSdk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="应用场景4" tabindex="-1"><a class="header-anchor" href="#应用场景4" aria-hidden="true">#</a> 应用场景4:</h2><h5 id="前提-androidmanifest-中添加android-shareduserid-android-uid-system" tabindex="-1"><a class="header-anchor" href="#前提-androidmanifest-中添加android-shareduserid-android-uid-system" aria-hidden="true">#</a> 前提：AndroidManifest 中添加android:sharedUserId=&quot;android.uid.system&quot;</h5><h5 id="操作-代码中调用安装apk的代码" tabindex="-1"><a class="header-anchor" href="#操作-代码中调用安装apk的代码" aria-hidden="true">#</a> 操作：代码中调用安装apk的代码</h5><h5 id="现象-弹出如下所示的dialog" tabindex="-1"><a class="header-anchor" href="#现象-弹出如下所示的dialog" aria-hidden="true">#</a> 现象：弹出如下所示的dialog</h5><h5 id="问题-为什么会弹出这个框-如何解决这个问题" tabindex="-1"><a class="header-anchor" href="#问题-为什么会弹出这个框-如何解决这个问题" aria-hidden="true">#</a> 问题：为什么会弹出这个框？如何解决这个问题</h5><h5 id="第一个问题解答-activitymanagerservice-checkgranturipermissionlocked" tabindex="-1"><a class="header-anchor" href="#第一个问题解答-activitymanagerservice-checkgranturipermissionlocked" aria-hidden="true">#</a> 第一个问题解答：ActivityManagerService#checkGrantUriPermissionLocked</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>callingAppId <span class="token operator">==</span> <span class="token constant">SYSTEM_UID</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>callingAppId <span class="token operator">==</span> <span class="token constant">ROOT_UID</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token number">9715</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;com.android.settings.files&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>grantUri<span class="token punctuation">.</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">9716</span>                    <span class="token operator">||</span> <span class="token class-name">SystemConfig</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthoriesInPreloadedApks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>
<span class="token number">9717</span>                    grantUri<span class="token punctuation">.</span>uri<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">9718</span>                <span class="token comment">// Exempted authority for</span>
<span class="token number">9719</span>                <span class="token comment">// 1. cropping user photos and sharing a generated license html</span>
<span class="token number">9720</span>                <span class="token comment">//    file in Settings app</span>
<span class="token number">9721</span>                <span class="token comment">// 2. sharing a generated license html file in TvSettings app</span>
<span class="token number">9722</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">9723</span>                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;For security reasons, the system cannot issue a Uri permission&quot;</span>
<span class="token number">9724</span>                        <span class="token operator">+</span> <span class="token string">&quot; grant to &quot;</span> <span class="token operator">+</span> grantUri <span class="token operator">+</span> <span class="token string">&quot;; use startActivityAsCaller() instead&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">9725</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">9726</span>            <span class="token punctuation">}</span>
<span class="token number">9727</span>        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>callUid为SYSTEM_UID，且不满足俩个if 则return -1 ，于是就出现上述的安装失败情况。</p><p>解决方式有俩种:</p><ul><li>去掉android:sharedUserId</li><li>更改SystemConfig.java</li></ul>`,48),r={href:"https://www.jianshu.com/p/4e521bc809c4",target:"_blank",rel:"noopener noreferrer"};function d(k,m){const a=e("ExternalLinkIcon");return p(),o("div",null,[u,s("p",null,[n("本文转自 "),s("a",r,[n("https://www.jianshu.com/p/4e521bc809c4"),c(a)]),n("，如有侵权，请联系删除。")])])}const h=t(l,[["render",d],["__file","quanxianguize.html.vue"]]);export{h as default};
