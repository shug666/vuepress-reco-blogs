import{_ as n,o as s,c as a,a as t}from"./app-e8f85126.js";const o={},e=t(`<h2 id="实现思路" tabindex="-1"><a class="header-anchor" href="#实现思路" aria-hidden="true">#</a> 实现思路</h2><p><code>DisplayContent</code> 是 Android 系统中一个重要的类，它在窗口管理器（Window Manager）中扮演着关键的角色。它用于管理一个显示设备上的窗口和界面元素，并负责处理显示相关的操作。以下是</p><h3 id="displaycontent-的主要作用" tabindex="-1"><a class="header-anchor" href="#displaycontent-的主要作用" aria-hidden="true">#</a> <code>DisplayContent</code> 的主要作用：</h3><ol><li><p><strong>窗口管理：</strong> <code>DisplayContent</code> 负责管理一个显示设备上的所有窗口，包括应用窗口、系统窗口、对话框等。它维护窗口的层级、布局、尺寸和可见性等信息。</p></li><li><p><strong>窗口层级：</strong> 通过 <code>DisplayContent</code>，系统可以确定每个窗口在显示上的层级关系，即哪个窗口位于其他窗口之上或之下。</p></li><li><p><strong>窗口布局和尺寸：</strong> <code>DisplayContent</code> 确保窗口在显示上正确布局，并根据窗口的尺寸和位置将其渲染到对应的屏幕区域。</p></li><li><p><strong>窗口状态管理：</strong> 窗口的状态，例如最小化、最大化、活动、非活动等，由 <code>DisplayContent</code> 进行管理和维护。</p></li><li><p><strong>窗口交互：</strong> 通过 <code>DisplayContent</code>，系统可以响应用户与窗口的交互操作，例如拖动、缩放、点击等。</p></li><li><p><strong>窗口动画：</strong> <code>DisplayContent</code> 负责处理窗口之间的动画效果，如窗口打开、关闭、切换等动画。</p></li><li><p><strong>多显示设备支持：</strong> 在多显示设备环境下，每个显示设备都有一个对应的 <code>DisplayContent</code> 实例，用于管理该设备上的窗口和显示操作。</p></li><li><p><strong>系统级界面管理：</strong> 系统级的界面元素，如状态栏、导航栏等，也由 <code>DisplayContent</code> 进行管理。</p></li><li><p><strong>界面刷新：</strong> <code>DisplayContent</code> 负责将窗口的内容绘制到显示设备上，以实现界面的刷新和呈现。</p></li><li><p><strong>显示设备属性：</strong> 通过 <code>DisplayContent</code>，系统可以获取和管理显示设备的属性，如分辨率、方向、DPI等。</p></li></ol><p><code>DisplayRotation</code> 是 Android 系统中的一个类，它用于管理显示设备的旋转操作。在移动设备中，用户可以旋转设备以适应不同的屏幕方向，例如从竖直方向切换到水平方向。<code>DisplayRotation</code> 负责跟踪显示设备的旋转状态，并通知系统和应用程序相应的变化。以下是</p><h3 id="displayrotation-的主要作用" tabindex="-1"><a class="header-anchor" href="#displayrotation-的主要作用" aria-hidden="true">#</a> <code>DisplayRotation</code> 的主要作用：</h3><ol><li><p><strong>屏幕旋转管理：</strong> <code>DisplayRotation</code> 跟踪用户旋转设备时的操作，包括从横屏切换到竖屏或反之。它记录当前的屏幕方向以及可能的旋转偏好。</p></li><li><p><strong>应用程序适应：</strong> 应用程序可以根据设备的旋转状态调整其用户界面，以确保在不同方向下都能够正确显示和布局。<code>DisplayRotation</code> 通知应用程序关于设备旋转的信息，从而使应用能够适应不同的方向。</p></li><li><p><strong>系统界面适应：</strong> 系统级的界面元素，如状态栏和导航栏，也需要根据屏幕方向进行调整。<code>DisplayRotation</code> 负责确保这些界面元素在旋转时的正确呈现。</p></li><li><p><strong>触摸事件映射：</strong> 屏幕旋转可能会影响触摸事件的坐标映射。<code>DisplayRotation</code> 确保触摸事件在旋转时正确映射到屏幕坐标。</p></li><li><p><strong>显示内容旋转：</strong> 一些应用或界面元素可能需要以特定的方向显示其内容。<code>DisplayRotation</code> 通过通知应用程序或界面元素的旋转状态，帮助它们调整内容的显示方向。</p></li><li><p><strong>用户体验：</strong> 通过管理设备的旋转，<code>DisplayRotation</code> 提供了更好的用户体验，使用户可以根据实际需要调整屏幕方向，而不会影响应用的正常运行。</p></li><li><p><strong>多显示设备支持：</strong> 在多显示设备环境下，每个显示设备可能有不同的旋转状态。<code>DisplayRotation</code> 确保每个显示设备都可以独立进行旋转。</p></li></ol><p>综上理解：屏幕旋转时候，窗口画面横竖屏主要是由DisplayRotation与DisplayContent来控制</p><h2 id="实现步骤" tabindex="-1"><a class="header-anchor" href="#实现步骤" aria-hidden="true">#</a> 实现步骤</h2><h3 id="updateorientation" tabindex="-1"><a class="header-anchor" href="#updateorientation" aria-hidden="true">#</a> updateOrientation</h3><p><strong>找到 DisplayContent中的<code>updateOrientation(boolean forceUpdate)</code>的函数发现<code>orientation = getOrientation();</code></strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">updateOrientation</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> orientation <span class="token operator">=</span> <span class="token function">getOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// The last orientation source is valid only after getOrientation.</span>
        <span class="token keyword">final</span> <span class="token class-name">WindowContainer</span> orientationSource <span class="token operator">=</span> <span class="token function">getLastOrientationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r <span class="token operator">=</span>
                orientationSource <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> orientationSource<span class="token punctuation">.</span><span class="token function">asActivityRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Task</span> task <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> orientation <span class="token operator">!=</span> task<span class="token punctuation">.</span>mLastReportedRequestedOrientation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                task<span class="token punctuation">.</span>mLastReportedRequestedOrientation <span class="token operator">=</span> orientation<span class="token punctuation">;</span>
                mAtmService<span class="token punctuation">.</span><span class="token function">getTaskChangeNotificationController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">notifyTaskRequestedOrientationChanged</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>mTaskId<span class="token punctuation">,</span> orientation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Currently there is no use case from non-activity.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">handleTopActivityLaunchingInDifferentOrientation</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* checkOpening */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Display orientation should be deferred until the top fixed rotation is finished.</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mDisplayRotation<span class="token punctuation">.</span><span class="token function">updateOrientation</span><span class="token punctuation">(</span>orientation<span class="token punctuation">,</span> forceUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="getorientation" tabindex="-1"><a class="header-anchor" href="#getorientation" aria-hidden="true">#</a> getOrientation</h3><p><strong>getOrientation该方法用于获取显示设备的方向,我们获取当前应用包名<code>mDisplayPolicy.mFocusedApp</code>，来判断截取返回的应用显示方向，<code>SCREEN_ORIENTATION_UNSPECIFIED=-1</code>代表方向未指定，允许系统根据传感器或其他因素来决定方向。</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token keyword">int</span> <span class="token function">getOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLastOrientationSource <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">handlesOrientationChangeFromDescendant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Return SCREEN_ORIENTATION_UNSPECIFIED so that Display respect sensor rotation</span>
            <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">WM_DEBUG_ORIENTATION</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Display id=%d is ignoring all orientation requests, return %d&quot;</span><span class="token punctuation">,</span>
                    mDisplayId<span class="token punctuation">,</span> <span class="token constant">SCREEN_ORIENTATION_UNSPECIFIED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">SCREEN_ORIENTATION_UNSPECIFIED</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mWmService<span class="token punctuation">.</span>mDisplayFrozen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mWmService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">.</span><span class="token function">isKeyguardLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Use the last orientation the while the display is frozen with the keyguard</span>
                <span class="token comment">// locked. This could be the keyguard forced orientation or from a SHOW_WHEN_LOCKED</span>
                <span class="token comment">// window. We don&#39;t want to check the show when locked window directly though as</span>
                <span class="token comment">// things aren&#39;t stable while the display is frozen, for example the window could be</span>
                <span class="token comment">// momentarily unavailable due to activity relaunch.</span>
                <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">WM_DEBUG_ORIENTATION</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;Display id=%d is frozen while keyguard locked, return %d&quot;</span><span class="token punctuation">,</span>
                        mDisplayId<span class="token punctuation">,</span> <span class="token function">getLastOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">getLastOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//luoming add</span>
        <span class="token class-name">String</span> pkgName <span class="token operator">=</span> mDisplayPolicy<span class="token punctuation">.</span>mFocusedApp<span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;getOrientation: pkgName=&quot;</span><span class="token operator">+</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isSnapCamera <span class="token operator">=</span> <span class="token string">&quot;com.tencent.android.qqdownloader&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">&quot;com.ss.android.ugc.aweme&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">&quot;com.created.ota&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//根据包名过滤某个应用</span>
        <span class="token keyword">int</span> orientation <span class="token operator">=</span> <span class="token constant">SCREEN_ORIENTATION_UNSPECIFIED</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSnapCamera<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           orientation <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getOrientation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//end</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>orientation <span class="token operator">==</span> <span class="token constant">SCREEN_ORIENTATION_UNSET</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Return SCREEN_ORIENTATION_UNSPECIFIED so that Display respect sensor rotation</span>
            <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">WM_DEBUG_ORIENTATION</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;No app or window is requesting an orientation, return %d for display id=%d&quot;</span><span class="token punctuation">,</span>
                    <span class="token constant">SCREEN_ORIENTATION_UNSPECIFIED</span><span class="token punctuation">,</span> mDisplayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">SCREEN_ORIENTATION_UNSPECIFIED</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> orientation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="以下是这些常量的解释" tabindex="-1"><a class="header-anchor" href="#以下是这些常量的解释" aria-hidden="true">#</a> 以下是这些常量的解释：</h3><p>SCREEN_ORIENTATION_UNSET：方向未设置，通常用于指示方向未被显式设置。</p><p>SCREEN_ORIENTATION_UNSPECIFIED：方向未指定，允许系统根据传感器或其他因素来决定方向。</p><p>SCREEN_ORIENTATION_LANDSCAPE：横向模式，用于表示横屏方向。</p><p>SCREEN_ORIENTATION_PORTRAIT：纵向模式，用于表示竖屏方向。</p><p>SCREEN_ORIENTATION_USER：用户首选方向，根据用户的首选设置来决定方向。</p><p>SCREEN_ORIENTATION_BEHIND：方向跟随上一个活动，通常用于在多个活动之间保持一致的方向。</p><p>SCREEN_ORIENTATION_SENSOR：根据传感器来决定方向，自动适应设备的物理方向。</p><p>其他常量（SCREEN_ORIENTATION_NOSENSOR、SCREEN_ORIENTATION_SENSOR_LANDSCAPE 等）是对方向的不同设置，例如强制横屏或纵屏，强制使用传感器等。</p><p>这些常量可以在 Android 应用程序中用于设置活动或窗口的默认方向，以确保应用在不同方向下都能正常显示。应用程序可以在清单文件或代码中设置方向，以适应不同的使用场景。</p><p><strong>注意：一定要过滤应用如果全部应用都根据重感横竖屏的话，那些强制横屏的游戏也会被竖屏，但是触摸就无效了</strong></p>`,26),p=[e];function i(c,l){return s(),a("div",null,p)}const r=n(o,[["render",i],["__file","Androidqiangzhiyingyonghengshupingfangxiang.html.vue"]]);export{r as default};
