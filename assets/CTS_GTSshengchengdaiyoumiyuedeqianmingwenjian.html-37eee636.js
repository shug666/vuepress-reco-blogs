import{_ as e,r as i,o as t,c as p,b as a,d as n,e as o,a as r}from"./app-e8f85126.js";const d={},l=r(`<h2 id="cts-gts测试项" tabindex="-1"><a class="header-anchor" href="#cts-gts测试项" aria-hidden="true">#</a> CTS/GTS测试项</h2><p>前言：测试的Android版本是14</p><h2 id="一、测试命令" tabindex="-1"><a class="header-anchor" href="#一、测试命令" aria-hidden="true">#</a> 一、测试命令</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>run gts <span class="token parameter variable">-m</span> GtsApexSignatureVerificationTest <span class="token parameter variable">-t</span> android.appsecurity.cts.ApexSignatureVerificationTest<span class="token comment">#testApexPubKeyIsNotWellKnownKey</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>测试fail，测试报告如下：</p><p><img src="https://img-blog.csdnimg.cn/direct/0771959677a74c1a95b3d399dfea0ca2.png" alt="测试报告"></p><h2 id="二、错误原因" tabindex="-1"><a class="header-anchor" href="#二、错误原因" aria-hidden="true">#</a> 二、错误原因</h2><p>这个报错是因为使用的是 Google 的公共签名，而不是带有密钥进行的签名，所以我们需要重新进行一次签名，生成带有密钥的签名文件，并且将签名文件放入项目代码里，然后重新编译代码</p><h2 id="三、生成签名文件和进行替换的方法" tabindex="-1"><a class="header-anchor" href="#三、生成签名文件和进行替换的方法" aria-hidden="true">#</a> 三、生成签名文件和进行替换的方法</h2><p>在测试报告中一共有9个报错，其中有4个用常规的方法进行签名，然后将生成的签名文件替换进去就可以</p><ol><li>com.android.uwb</li><li>com.android.rkpd</li><li>com.android.wifi</li><li>com.android.virt</li></ol><p><strong>1. 生成签名文件</strong></p><p>在Android代码的根目录中执行以下三步</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>openssl genrsa <span class="token parameter variable">-out</span> com.android.runtime.pem <span class="token number">4096</span>
./external/avb/avbtool.py extract_public_key <span class="token parameter variable">--key</span> com.android.runtime.pem <span class="token parameter variable">--output</span> com.android.runtime.avbpubkey
openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-newkey</span> rsa:4096 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">999999</span> <span class="token parameter variable">-keyout</span> key.pem <span class="token parameter variable">-out</span> com.android.runtime.x509.pem
openssl pkcs8 <span class="token parameter variable">-topk8</span> <span class="token parameter variable">-inform</span> PEM <span class="token parameter variable">-outform</span> DER <span class="token parameter variable">-in</span> key.pem <span class="token parameter variable">-out</span> com.android.runtime.pk8 <span class="token parameter variable">-nocrypt</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(1) 执行第一步会生成com.android.uwb.pem文件</p><p>(2) 执行第二步会生成com.android.uwb.avbpubkey文件</p><p>(3) 执行第三步的时候，按照提示回车，需要输入公司等相关的信息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token string">&#39;/C=CH/ST=GX/L=NN/O=ThunderSoft/OU=ThunderSoft/CN=ThunderSoft/emailAddress=thundersoft@thundersoft.com&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ps: 这里是以com.android.uwb为例，其他3个rkpd、wifi和virt也都如法炮制</p><p><strong>2. 将生成的签名文件替换进源代码里</strong></p><p>这个时候已经生成了com.android.uwb的四个签名文件</p><p>com.android.uwb.pem</p><p>com.android.uwb.avbpubkey</p><p>com.android.uwb.pk8</p><p>com.android.uwb.x509.pem</p><p>在源代码中使用find命令搜索，可以搜索到Google的公共签名文件的所在目录–com.android.uwb.x509.pem</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>//com.android.uwb的签名文件放进以下目录
QSSI14/packages/modules/Uwb/apex
QSSI14/packages/modules/Uwb/service/ServiceUwbResources/resources-certs

//com.android.rkpd的签名文件放进以下目录
QSSI14/packages/modules/RemoteKeyProvisioning/apex

//com.android.wifi的签名文件放进以下目录
QSSI14/packages/modules/Wifi/apex

//com.android.virt的签名文件放进以下目录
QSSI14/packages/modules/Virtualization/apex

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个目录下，将生成的四个签名文件替换进去即可重新编译复测</p><p>做完之后删除所有生成的新文件，特别是需要rm key.pem</p><h2 id="四、com-android-vndk" tabindex="-1"><a class="header-anchor" href="#四、com-android-vndk" aria-hidden="true">#</a> 四、com.android.vndk</h2><p>接下来还剩下com.android.vndk的签名文件要进行签名：</p><p>com.android.vndk.v31</p><p>com.android.vndk.v30</p><p>com.android.vndk.v33</p><p>com.android.vndk.v32</p><p>com.android.vndk.v34</p><p>根据官方文档的指示来进行操作</p><p>QSSI14/packages/modules/vndk/apex/README.md</p><p>这 里 是 README.md 文 档 的 内 容：</p><p>#Add a new VNDK APEX</p><p>In this document we add a new VNDK APEX for version 30. When you follow this doc<br> with different versions,</p><p>change “30” to what you’re adding. (eg. 31)</p><ol><li>Add a new definition in <code>Android.bp</code></li></ol><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code>apex_vndk <span class="token punctuation">{</span>
<span class="token target symbol">name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30&quot;</span>,
<span class="token target symbol">manifest</span><span class="token punctuation">:</span> <span class="token string">&quot;apex_manifest.v30.json&quot;</span>,
<span class="token target symbol">key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.key&quot;</span>,
<span class="token target symbol">certificate</span><span class="token punctuation">:</span> <span class="token string">&quot;:com.android.vndk.v30.certificate&quot;</span>,
<span class="token target symbol">vndk_version</span><span class="token punctuation">:</span> <span class="token string">&quot;30&quot;</span>,
<span class="token target symbol">system_ext_specific</span><span class="token punctuation">:</span> true,
<span class="token target symbol">file_contexts</span><span class="token punctuation">:</span> <span class="token string">&quot;:com.android.vndk-file_contexts&quot;</span>,
<span class="token punctuation">}</span>
apex_key <span class="token punctuation">{</span>
<span class="token target symbol">name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.key&quot;</span>,
<span class="token target symbol">public_key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.pubkey&quot;</span>,
<span class="token target symbol">private_key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.pem&quot;</span>,
<span class="token punctuation">}</span>
android_app_certificate <span class="token punctuation">{</span>
<span class="token target symbol">name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.certificate&quot;</span>,s
<span class="token target symbol">certificate</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30&quot;</span>,
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>Add <code>apex_manifest.v30.json</code></li></ol><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;com.android.vndk.v30&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>Add keys/ceritificate</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>openssl genrsa <span class="token parameter variable">-out</span> com.android.vndk.v30.pem <span class="token number">4096</span>
avbtool extract_public_key <span class="token parameter variable">--key</span> com.android.vndk.v30.pem <span class="token parameter variable">--output</span> com.android.vndk.v30.pubkey
openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-newkey</span> rsa:4096 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">999999</span> <span class="token parameter variable">-keyout</span> key.pem <span class="token parameter variable">-out</span> com.android.vndk.v30.x509.pem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>具体操作步骤：</strong></p><p>以 com.android.vndk.v30 为例 <strong>第一步：先修改 Android.bp 文件</strong></p><p>QSSI14/packages/modules/vndk/apex/Android.bp</p><p>在 Android.bp 文件中添加以下参数：</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code>apex_vndk <span class="token punctuation">{</span>
<span class="token target symbol">name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30&quot;</span>,
<span class="token target symbol">manifest</span><span class="token punctuation">:</span> <span class="token string">&quot;apex_manifest.v30.json&quot;</span>,
<span class="token target symbol">key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.key&quot;</span>,
<span class="token target symbol">certificate</span><span class="token punctuation">:</span> <span class="token string">&quot;:com.android.vndk.v30.certificate&quot;</span>,
<span class="token target symbol">vndk_version</span><span class="token punctuation">:</span> <span class="token string">&quot;30&quot;</span>,
<span class="token target symbol">system_ext_specific</span><span class="token punctuation">:</span> true,
<span class="token target symbol">file_contexts</span><span class="token punctuation">:</span> <span class="token string">&quot;:com.android.vndk-file_contexts&quot;</span>,
<span class="token punctuation">}</span>
apex_key <span class="token punctuation">{</span>
<span class="token target symbol">name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.key&quot;</span>,
<span class="token target symbol">public_key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.pubkey&quot;</span>,
<span class="token target symbol">private_key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.pem&quot;</span>,
<span class="token punctuation">}</span>
android_app_certificate <span class="token punctuation">{</span>
<span class="token target symbol">name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30.certificate&quot;</span>,
<span class="token target symbol">certificate</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.vndk.v30&quot;</span>,
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第二步：</strong></p><p>新建一个文件----apex_manifest.v30.json</p><p>放到 QSSI14/packages/modules/vndk/apex 目录下</p><p>里面的内容是：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>  

<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;com.android.vndk.v30&quot;</span><span class="token punctuation">,</span>  

<span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token number">1</span>  

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第三步：</strong></p><p>生成签名文件，也放到 QSSI14/packages/modules/vndk/apex 目录下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>openssl genrsa <span class="token parameter variable">-out</span> com.android.vndk.v30.pem <span class="token number">4096</span>
./UM.9.14/external/avb/avbtool extract_public_key <span class="token parameter variable">--key</span> com.android.vndk.v30.pem <span class="token parameter variable">--output</span> com.android.vndk.v30.pubkey
openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-newkey</span> rsa:4096 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">999999</span> <span class="token parameter variable">-keyout</span> key.pem <span class="token parameter variable">-out</span> com.android.vndk.v30.x509.pem
//注意，执行第三步后会提示你填写相关的参数
openssl pkcs8 <span class="token parameter variable">-topk8</span> <span class="token parameter variable">-inform</span> PEM <span class="token parameter variable">-outform</span> DER <span class="token parameter variable">-in</span> key.pem <span class="token parameter variable">-out</span> com.android.vndk.v30.pk8 <span class="token parameter variable">-nocrypt</span> <span class="token string">&#39;/C=CH/ST=GX/L=NN/O=CSDN/OU=CSDN/CN=CSDN/emailAddress=csdn@csdn.com&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>生成的 key.pem 可以删除，无需放进 apex 的目录</p><p>ps：在还没替换 vndk 的签名之前，报错的是 v30,v31,v32,v33,v34</p><p>但是只需生成和替换 v30,v31,v32,v33 的就可以</p><p>在 QSSI14/prebuilts/vndk 也是只看到有 v29,v30,v31,v32,v33,没有看到 v34 的文件夹</p><p>在 Android.bp 文件中也不需要将 v34 的参数添加进去</p><p>因此，无需对com.android.vndk.v34进行签名</p>`,67),c={href:"https://blog.csdn.net/weixin_44956894/article/details/138655101",target:"_blank",rel:"noopener noreferrer"};function u(v,m){const s=i("ExternalLinkIcon");return t(),p("div",null,[l,a("p",null,[n("本文转自 "),a("a",c,[n("https://blog.csdn.net/weixin_44956894/article/details/138655101"),o(s)]),n("，如有侵权，请联系删除。")])])}const b=e(d,[["render",u],["__file","CTS_GTSshengchengdaiyoumiyuedeqianmingwenjian.html.vue"]]);export{b as default};
