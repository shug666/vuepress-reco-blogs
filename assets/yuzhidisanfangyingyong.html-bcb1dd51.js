import{_ as n,o as s,c as a,a as p}from"./app-e8f85126.js";const e={},t=p(`<p>系统开机时会进行应用的加载(或者说安装)，所以我们大体上来说就是需要把要内置的apk放到指定目录就行。最常见的应该是下面四个</p><ol><li>system/app/ ：该目录下存放的是一些系统级的应用，该目录下的应用能获取到比较高的权限，应用不可卸载，如Phone、Contacts等</li><li>system/priv-app/ ：该目录是从Android 4.4开始出现的目录，它存放的是一些系统核心应用，能获取到比system/app/下应用更高的权限，应用不可卸载，如:Setting、SystemUI等。</li><li>vendor/app/ ：该目录存放制造商的一些应用，应用不可卸载。</li><li>data/app/：该目录下存放的一些第三方应用，应用可卸载。用户手动安装的应用就是放在这个目录下</li></ol><p>更多的可以看具体的代码，也可以自行添加。 源码是在<code>frameworks\\base\\services\\core\\java\\com\\android\\server\\pm\\PackageManagerService.java</code>实例化时通过<code>scanDirTracedLI</code>方法进行扫描安装，可通过查看串口查看相关日志<code>logcat -s PackageManage</code>r。</p><p><img src="https://raw.githubusercontent.com/shug666/image/main/images/image-20230103134804209.png" alt="image-20230103134804209"></p><h2 id="android-预置第三方应用" tabindex="-1"><a class="header-anchor" href="#android-预置第三方应用" aria-hidden="true">#</a> Android 预置第三方应用</h2><p>Android 8.0及以上平台预置第三方apk，踩了不少坑，这里做一下笔录。</p><p>正常情况预置apk到Data目录很简单，但是这里会遇到一个问题，</p><ol><li>如果在不改变apk签名的情况下预置到Data目录，编译后可以看到out 目录下确实是有这个apk，但是刷机系统跑起来后会因为签名校验不过（android 7.0之后增加的APK Signature Scheme v2签名方案），导致这个apk自动被系统删除。</li><li>如果将apk的签名改为系统签名预置到data目录，编译后刷机都可以正常运行，但是一般apk都有在线升级的功能，一旦apk有新版本了会因为apk签名被改变导致升级不了</li></ol><p><strong>实现方案</strong></p><p>将第三方应用预置到一个目录，比如/system/pre_install、系统第一次起来时，将这个目录下的所有apk文件拷贝到data/app下或者通过pm脚本安装目录下的所有apk。</p><h3 id="将第三方应用预置到系统目录" tabindex="-1"><a class="header-anchor" href="#将第三方应用预置到系统目录" aria-hidden="true">#</a> <strong>将第三方应用预置到系统目录</strong></h3><p>有两种方式实现</p><div class="language-handlebars line-numbers-mode" data-ext="handlebars"><pre class="language-handlebars"><code>1.通过编写Android.mk 将apk 文件拷贝到指定系统编译目录
2.直接将目录下的所有apk 文件拷贝到系统编译目录
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>方式1: 属于常规操作，缺点是每新增一个第三方apk文件，都需要重新修改Android.mk文件</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code>LOCAL_PATH <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">call</span> my-dir<span class="token punctuation">)</span>

<span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>CLEAR_VARS<span class="token punctuation">)</span>

LOCAL_MODULE_TAGS <span class="token operator">:=</span> optional
LOCAL_MODULE <span class="token operator">:=</span> RunningMyCountry
LOCAL_SRC_FILES <span class="token operator">:=</span> RunningMyCountry.apk
LOCAL_MODULE_CLASS <span class="token operator">:=</span> APPS
LOCAL_PRIVILEGED_MODULE <span class="token operator">:=</span> true
LOCAL_MODULE_PATH <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span>TARGET_OUT<span class="token punctuation">)</span>/pre_install
LOCAL_MODULE_SUFFIX <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span>COMMON_ANDROID_PACKAGE_SUFFIX<span class="token punctuation">)</span>
LOCAL_CERTIFICATE <span class="token operator">:=</span> PRESIGNED

<span class="token keyword">include</span> <span class="token variable">$</span><span class="token punctuation">(</span>BUILD_PREBUILT<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>方式2: 这种方式简单快捷，后续新增apk 也很方便，新增一个目录preintall/prethirdapk、并将apk文件全部放置其中，然后加入编译选项</p><p><code>/device.mk</code></p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code>PRODUCT_COPY_FILES <span class="token operator">+=</span> \\
    <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">call</span> find-copy-subdir-files,*,device/amlogic/<span class="token variable">$</span><span class="token punctuation">(</span>PRODUCT_DIR<span class="token punctuation">)</span>/preinstall/prethirdapk/,/<span class="token variable">$</span><span class="token punctuation">(</span>TARGET_COPY_OUT_VENDOR<span class="token punctuation">)</span>/preinstall<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意</strong>：直接拷贝apk文件，系统编译时会报错<code>Prebuilt apk found in PRODUCT_COPY_FILES: preinstallApk, use BUILD_PREBUILT instead!</code></p><p><code>vim build/make/core/Makefile +28</code>，屏蔽check-product-copy-files即可</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>@@ -28,7 +28,6 @@ product_copy_files_ignored :<span class="token operator">=</span>
 <span class="token variable"><span class="token variable">$(</span>foreach cf,<span class="token punctuation">$(</span>unique_product_copy_files_pairs<span class="token punctuation">)</span>, <span class="token punctuation">\\</span>
     <span class="token punctuation">$(</span>eval _src :<span class="token operator">=</span> <span class="token punctuation">$(</span>call word-colon,1,<span class="token punctuation">$(</span>cf<span class="token punctuation">)</span><span class="token variable">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">\\</span>
     <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">eval</span> _dest :<span class="token operator">=</span> <span class="token punctuation">$(</span>call word-colon,2,<span class="token punctuation">$(</span>cf<span class="token punctuation">)</span><span class="token variable">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">\\</span>
-    <span class="token variable"><span class="token variable">$(</span>call check-product-copy-files,<span class="token punctuation">$(</span>cf<span class="token punctuation">)</span>,<span class="token punctuation">$(</span>_dest<span class="token punctuation">)</span><span class="token variable">)</span></span> <span class="token punctuation">\\</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="第三方应用预装到系统" tabindex="-1"><a class="header-anchor" href="#第三方应用预装到系统" aria-hidden="true">#</a> <strong>第三方应用预装到系统</strong></h3><div class="language-handlebars line-numbers-mode" data-ext="handlebars"><pre class="language-handlebars"><code>1.系统第一次起来时，将这个目录下的所有apk文件拷贝到data/app下，系统自动解析
2.系统第一次起来时，通过pm脚本安装目录下的所有apk
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>两种方式大同小异，略有点不同</p><h4 id="_1-将目录下的apk-直接拷贝到-data-apk-android-9-0会报错" tabindex="-1"><a class="header-anchor" href="#_1-将目录下的apk-直接拷贝到-data-apk-android-9-0会报错" aria-hidden="true">#</a> <strong>1.将目录下的apk 直接拷贝到/data/apk，Android 9.0会报错</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token string">&quot;Application package &quot;</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName
                                <span class="token operator">+</span> <span class="token string">&quot; not found; ignoring.&quot;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改如下（解析data app时，去掉SCAN_REQUIRE_KNOWN 标记）：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//第一次开机去掉SCAN_REQUIRE_KNOWN</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isFirstBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>sAppInstallDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>sAppInstallDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scanFlags<span class="token operator">|</span><span class="token constant">SCAN_REQUIRE_KNOWN</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-增加pm-preinstall-命令" tabindex="-1"><a class="header-anchor" href="#_2-增加pm-preinstall-命令" aria-hidden="true">#</a> <strong>2.增加pm preinstall 命令</strong></h4><hr><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>pm<span class="token operator">/</span><span class="token class-name">PackageManagerShellCommand</span><span class="token punctuation">.</span>java
<span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>pm<span class="token operator">/</span><span class="token class-name">PackageManagerShellCommand</span><span class="token punctuation">.</span>java
@@ <span class="token operator">-</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">7</span> @@ <span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span></span><span class="token class-name">IAccountManager</span></span><span class="token punctuation">;</span>
 <span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">ActivityManager</span></span><span class="token punctuation">;</span>
 <span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">ActivityManagerInternal</span></span><span class="token punctuation">;</span>
 <span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">Application</span></span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">PackageInstallObserver</span></span><span class="token punctuation">;</span>
 <span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ComponentName</span></span><span class="token punctuation">;</span>
 <span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
 <span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">IIntentReceiver</span></span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">156</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">157</span><span class="token punctuation">,</span><span class="token number">8</span> @@ <span class="token keyword">class</span> <span class="token class-name">PackageManagerShellCommand</span> <span class="token keyword">extends</span> <span class="token class-name">ShellCommand</span> <span class="token punctuation">{</span>
                     <span class="token keyword">return</span> <span class="token function">runQueryIntentReceivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">case</span> <span class="token string">&quot;install&quot;</span><span class="token operator">:</span>
                     <span class="token keyword">return</span> <span class="token function">runInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                <span class="token keyword">case</span> <span class="token string">&quot;preinstall&quot;</span><span class="token operator">:</span>
<span class="token operator">+</span>                    <span class="token keyword">return</span> <span class="token function">preInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">case</span> <span class="token string">&quot;install-abandon&quot;</span><span class="token operator">:</span>
                 <span class="token keyword">case</span> <span class="token string">&quot;install-destroy&quot;</span><span class="token operator">:</span>
                     <span class="token keyword">return</span> <span class="token function">runInstallAbandon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">898</span><span class="token punctuation">,</span><span class="token number">11</span> <span class="token operator">+</span><span class="token number">901</span><span class="token punctuation">,</span><span class="token number">60</span> @@ <span class="token keyword">class</span> <span class="token class-name">PackageManagerShellCommand</span> <span class="token keyword">extends</span> <span class="token class-name">ShellCommand</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

<span class="token operator">+</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">preInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>        <span class="token keyword">final</span> <span class="token class-name">PrintWriter</span> pw <span class="token operator">=</span> <span class="token function">getOutPrintWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token function">getNextArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;preInstall path: &quot;</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>            pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error: no package specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>        <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">File</span> apkFilePath <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>            <span class="token keyword">final</span> <span class="token class-name">String</span> inPath <span class="token operator">=</span> apkFilePath<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token class-name">SessionParams</span> sessionParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionParams</span><span class="token punctuation">(</span><span class="token class-name">SessionParams</span><span class="token punctuation">.</span><span class="token constant">MODE_FULL_INSTALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token class-name">InstallParams</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstallParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            params<span class="token punctuation">.</span>sessionParams <span class="token operator">=</span> sessionParams<span class="token punctuation">;</span>
<span class="token operator">+</span>            pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;preInstall pkg: &quot;</span> <span class="token operator">+</span> inPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token function">setParamsSize</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> inPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> sessionId <span class="token operator">=</span> <span class="token function">doCreateSession</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>sessionParams<span class="token punctuation">,</span>
<span class="token operator">+</span>                    params<span class="token punctuation">.</span>installerPackageName<span class="token punctuation">,</span> params<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token keyword">boolean</span> abandonSession <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>inPath <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span>sessionParams<span class="token punctuation">.</span>sizeBytes <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                    pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error: must either specify a package size or an APK file : &quot;</span><span class="token operator">+</span>inPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                <span class="token punctuation">}</span>
<span class="token operator">+</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">doWriteSplit</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">,</span> inPath<span class="token punctuation">,</span> params<span class="token punctuation">.</span>sessionParams<span class="token punctuation">.</span>sizeBytes<span class="token punctuation">,</span> <span class="token string">&quot;base.apk&quot;</span><span class="token punctuation">,</span>
<span class="token operator">+</span>                        <span class="token boolean">false</span> <span class="token comment">/*logSuccess*/</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PackageInstaller</span><span class="token punctuation">.</span><span class="token constant">STATUS_SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                    pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;doWriteSplit Error :&quot;</span><span class="token operator">+</span>inPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                <span class="token punctuation">}</span>
<span class="token operator">+</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">doCommitSession</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*logSuccess*/</span><span class="token punctuation">)</span>
<span class="token operator">+</span>                        <span class="token operator">!=</span> <span class="token class-name">PackageInstaller</span><span class="token punctuation">.</span><span class="token constant">STATUS_SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                    pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;doCommitSession Error :&quot;</span><span class="token operator">+</span>inPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                <span class="token punctuation">}</span>
<span class="token operator">+</span>                abandonSession <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;preInstall : &quot;</span> <span class="token operator">+</span> inPath<span class="token operator">+</span> <span class="token string">&quot; Success!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>abandonSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                        <span class="token function">doAbandonSession</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*logSuccess*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>                    <span class="token punctuation">}</span>
<span class="token operator">+</span>                <span class="token punctuation">}</span>
<span class="token operator">+</span>            <span class="token punctuation">}</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
<span class="token operator">+</span>        pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;preInstall path: &quot;</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">&quot; ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>由于开机执行shell脚本中的pm命令无效果，也无提示信息，因此本次使用的是第一种方法。</strong></p><h3 id="在init-rc中定义一个服务" tabindex="-1"><a class="header-anchor" href="#在init-rc中定义一个服务" aria-hidden="true">#</a> 在init.rc中定义一个服务</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#for install apps</span>
<span class="token comment">#开机时系统会执行该脚本</span>

<span class="token function">service</span> preinstall /system/bin/sh /system/etc/installApps.sh
    class main
    user root
    group root system
    disabled
    oneshot
    seclabel u:r:shell:s0
 
on property:persist.tv.first_boot<span class="token operator">=</span><span class="token number">1</span>
   start preinstall
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="准备一个脚本" tabindex="-1"><a class="header-anchor" href="#准备一个脚本" aria-hidden="true">#</a> 准备一个脚本</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#！/system/bin/sh</span>
<span class="token comment">#在第一次开机的时候执行脚本将apk拷贝到data目录，**记得给这些apk文件赋予权限**</span>

<span class="token builtin class-name">local</span> <span class="token assign-left variable">install_path</span><span class="token operator">=</span>/system/pre_install
<span class="token builtin class-name">local</span> <span class="token assign-left variable">data_path</span><span class="token operator">=</span>/data/app
<span class="token function-name function">installApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-d</span> <span class="token variable">$data_path</span>/<span class="token variable">$1</span>/ <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
    <span class="token function">cp</span> <span class="token parameter variable">-rf</span> <span class="token variable">$install_path</span>/<span class="token variable">$1</span> <span class="token variable">$data_path</span>/
    <span class="token function">chmod</span> <span class="token number">777</span> <span class="token variable">$data_path</span>/<span class="token variable">$1</span>
    <span class="token function">chmod</span> <span class="token number">777</span> <span class="token variable">$data_path</span>/<span class="token variable">$1</span>/*
  <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

installApp WormWars
installApp CrazyPop
installApp GalaFight
installApp ShootBall
installApp RunningMyCountry
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="将脚本拷贝到system-etc目录下" tabindex="-1"><a class="header-anchor" href="#将脚本拷贝到system-etc目录下" aria-hidden="true">#</a> 将脚本拷贝到system/etc目录下</h3><p>在android.mk文件中定义，将脚本拷贝到板载的system/分区目录下，如product.mk中</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>PRODUCT_COPY_FILES <span class="token operator">+=</span> <span class="token punctuation">\\</span>
    <span class="token variable"><span class="token variable">$(</span>LOCAL_PATH<span class="token variable">)</span></span>/installApps.sh:system/etc/installApps.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="在systemserver中去启动" tabindex="-1"><a class="header-anchor" href="#在systemserver中去启动" aria-hidden="true">#</a> 在SystemServer中去启动</h3><p>在SystemServer中去启动这个服务,使得系统第一次开机的时候启动这个服务，不需要重复创建**（由于init.rc服务启动时间过早，而/data分区还未挂载导致文件拷贝失败的情况）**</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Reading configuration...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//.............</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;persist.tv.first_boot_flag&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		   <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;persist.tv.first_boot&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		   <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;persist.tv.first_boot&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    	<span class="token comment">//.............</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="取消-data-app目录的限制" tabindex="-1"><a class="header-anchor" href="#取消-data-app目录的限制" aria-hidden="true">#</a> 取消/data/app目录的限制</h3><p><code>PackageManagerService.java</code>中判断是否是第一次预置apk</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//SCAN_REQUIRE_KNOWN的限制</span>
<span class="token comment">//scanDirTracedLI(sAppInstallDir, 0, scanFlags|SCAN_REQUIRE_KNOWN, 0);</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;persist.tv.first_boot_flag&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>sAppInstallDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>sAppInstallDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scanFlags<span class="token operator">|</span><span class="token constant">SCAN_REQUIRE_KNOWN</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//....................</span>

<span class="token keyword">final</span> <span class="token keyword">long</span> dataScanTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemScanTime <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> dataPackagesCount <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemPackagesCount<span class="token punctuation">;</span>
<span class="token comment">//判断应用是否全部已安装完成</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;persist.tv.first_boot_flag&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dataPackagesCount <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;persist.tv.first_boot_flag&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="signature-scheme-v2签名方式apk预装失败" tabindex="-1"><a class="header-anchor" href="#signature-scheme-v2签名方式apk预装失败" aria-hidden="true">#</a> Signature Scheme v2签名方式APK预装失败</h3><p>Android 7.0 引入一项新的应用签名方案 APK Signature Scheme v2，它能提供更快的应用安装时间和更多针对未授权 APK 文件更改的保护。在默认情况下，Android Studio 2.2 和 Android Plugin for Gradle 2.2 会使用 APK Signature Scheme v2 和传统签名方案来签署您的应用。</p><p>在Android7.0以及之后的版本上预置APK时，如果APK是采用的Signature Scheme v2签名，采用原有的预置应用方式预置APK会失败，经过BUILD_PREBUILT后的apk与原apk是有差异的。Android编译系统会用zipalign对APK进行字节对齐等操作，v2 签名将验证归档中每个文件的已压缩文件内容，如有任何自定义任务篡改 APK 文件或对其进行后处理（无论以任何方式），那么v2 签名会有作废的风险</p><p>在预装apk的时候因为各个合作公司的应用签名方式都有可能不同，那么我们怎么知道要预装的第三方apk是V1还是V2签名呢？ 好在google给我们提供了工具让我们验证，我们打开SDK所在目录，SDK/build-tools/27.0.1/lib 目录下有个apksigner.jar，我们可以用这个工具来验证apk是否为V2签名。 方法为： 1.将apk文件拷贝至SDK/build-tools/27.0.1/lib目录下 2.打开命令行窗口输入java -jar apksigner.jar verify -v MeiTuan.apk ,接着会出现如下信息，V2为true表示apk做了V2签名。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> apksigner.jar verify <span class="token parameter variable">-v</span> MeiTuan.apk 
Verifies
Verified using v1 scheme <span class="token punctuation">(</span>JAR signing<span class="token punctuation">)</span>: <span class="token boolean">true</span>
Verified using v2 scheme <span class="token punctuation">(</span>APK Signature Scheme v2<span class="token punctuation">)</span>: <span class="token boolean">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>解决方案</strong></p><p>在预置APK build的时候不让其走编译流程，在APK的 Android.mk加入下面的Shell拷贝脚本：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>LOCAL_PATH :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>call my-dir<span class="token variable">)</span></span>

include <span class="token variable"><span class="token variable">$(</span>CLEAR_VARS<span class="token variable">)</span></span>

LOCAL_MODULE :<span class="token operator">=</span> RunningMyCountry
<span class="token variable"><span class="token variable">$(</span>shell <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token punctuation">$(</span>TARGET_OUT<span class="token punctuation">)</span>/pre_install/<span class="token punctuation">$(</span>LOCAL_MODULE<span class="token punctuation">)</span><span class="token variable">)</span></span>
<span class="token variable"><span class="token variable">$(</span>shell <span class="token function">cp</span> <span class="token punctuation">$(</span>LOCAL_PATH<span class="token punctuation">)</span>/<span class="token punctuation">$(</span>LOCAL_MODULE<span class="token punctuation">)</span>.apk <span class="token punctuation">$(</span>TARGET_OUT<span class="token punctuation">)</span>/pre_install/<span class="token punctuation">$(</span>LOCAL_MODULE<span class="token punctuation">)</span>/<span class="token punctuation">$(</span>LOCAL_MODULE<span class="token punctuation">)</span>.apk<span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样基本就完成了，亲测没有问题。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>编译到系统中后，将镜像重新刷到机器上，启动系统。</p><p>系统起来后，通过dmsg 查看系统消息，查看脚本是否有执行，参考https://www.codenong.com/cs79041174/</p><p>代码中进行拷贝操作可参考https://blog.csdn.net/csdn_pcb/article/details/85867426</p><p>android /data分区下的目录加密策略读取和设置，参考https://blog.csdn.net/zmlovelx/article/details/125664260?spm=1001.2014.3001.5502</p><p>ANDROID-预制APK的四种方法总结https://blog.csdn.net/longmin96/article/details/125921274</p><p><strong>巨坑，请注意：</strong></p><blockquote><p>一定要先修改源码取消/data/app目录下的限制，</p><p>同时拷贝到/data/app目录下后要给权限否则会解析失败，导致无法安装</p><p>要在SystemServer中去启动脚本，init.rc启动服务过快</p></blockquote><h2 id="补充" tabindex="-1"><a class="header-anchor" href="#补充" aria-hidden="true">#</a> 补充</h2><h2 id="mk语法规则" tabindex="-1"><a class="header-anchor" href="#mk语法规则" aria-hidden="true">#</a> mk语法规则</h2><p>关键的语法规则</p><p><strong>LOCAL_PRIVILEGED_MODULE := true</strong></p><p>（1）决定了其编译后的在ROM中的安装位置 （2）如果不设置或者设置为false，安装位置为system/app；如果设置为true，安装位置为system/priv-app。</p><p><strong>LOCAL_CERTIFICATE := platform</strong></p><div class="language-objectivec line-numbers-mode" data-ext="objectivec"><pre class="language-objectivec"><code>    （<span class="token number">1</span>）用于设置签名
            ① testkey：普通APK，默认情况下使用。当不设置的时候，默认使用这一项。
            ② platform：该APK完成一些系统的核心功能。经过对系统中存在的文件夹的访问测试，这种方式编译出来的APK所在进程的UID为system。
            ③ shared：该APK需要和home<span class="token operator">/</span>contacts进程共享数据。
            ④ media：该APK是media<span class="token operator">/</span>download系统中的一环。
            ⑤ PRESIGNED ：使用原来的签名，就是已经签过名了。
    （<span class="token number">2</span>）Settings<span class="token punctuation">.</span>apk 就是 platform 级别的签名，系统级应用都应该使用这个签名
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>LOCAL_DEX_PREOPT := false</strong></p><p>如果以后对应的APK要进行在线升级，则需要把这个加上。编译时不会进行预优化，保证了APK的完整性。</p><p><strong>LOCAL_PREBUILT_JNI_LIBS :=</strong></p><p>（1）用于加载库 （2）参考</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>LOCAL_PREBUILT_JNI_LIBS :<span class="token operator">=</span> <span class="token punctuation">\\</span>
    lib/armeabi-v7a/libserial_port.so
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>LOCAL_MODULE_PATH := $(TARGET_OUT_DATA_APPS)</strong></p><p>（1）预置apk到/data/app中，即让预置的apk可以卸载。 （2）在5.0 6.0之后的系统中，这样配置即可实现这个功能。安卓9.0有限制，需修改源码，见正文</p><p>像<strong>TARGET_OUT_APPS</strong>这些变量在build/make/core/envsetup.mk里有所定义。</p>`,77),o=[t];function c(l,i){return s(),a("div",null,o)}const u=n(e,[["render",c],["__file","yuzhidisanfangyingyong.html.vue"]]);export{u as default};
