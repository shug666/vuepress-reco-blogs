import{_ as n,o as s,c as a,a as p}from"./app-e8f85126.js";const t={},o=p(`<p>我们都知道，从Android12起，下拉菜单栏控制中心都是黑色的，看起来非常不美观，而且国内的手机系统UI都做的比较美观，大部分的下拉菜单UI背景都是实现了高斯模糊效果，所以客户也会要求实现类似于这样的效果。</p><p>在以前的Android项目中，实现下拉菜单栏的模糊背景就是通过截图的方式进行替换背景，而这种方式下拉菜单背景极易替换不了，就算是在各个地方都适配，还是有概率在复杂场景或者一些测试手法下出现背景是黑的情况，并且这种方式还比较影响性能，毕竟每次都要去截图一次，多做了额外的事。下面我说一种方法百分百不会引起下拉栏背景异常的修改方法，就不管是复杂场景或者特殊测试手法下，背景都是高斯模糊的效果。</p><p>首先讲一下通过截图替换背景的实现方式的思路，就不做详细介绍。</p><h2 id="一-截图方式实现systemui下拉栏的模糊效果" tabindex="-1"><a class="header-anchor" href="#一-截图方式实现systemui下拉栏的模糊效果" aria-hidden="true">#</a> 一，截图方式实现SystemUI下拉栏的模糊效果</h2><p>首先要在文件<code>frameworks/base/packages/SystemUI/res/layout/status\\_bar\\_expanded.xml</code>中定义背景的ImageView</p><p>然后再在NotificationPanelViewController.java中监听下拉事件，实现显示与否模糊效果，其他百度博文都有写如何实现，重点讲解第二种实现方案。</p><h2 id="二-第二种实现systemui下拉栏的模糊效果" tabindex="-1"><a class="header-anchor" href="#二-第二种实现systemui下拉栏的模糊效果" aria-hidden="true">#</a> 二，第二种实现SystemUI下拉栏的模糊效果</h2><p>这种方式其实是Google已经提供给我们的方式，就是发现找到并利用它需要花费一番功夫。非常遗憾，Android Go版本暂不支持此种方式。</p><p>首先，我们要先将下拉菜单栏修改成透明的，如何修改呢，请看文件：</p><p><code>frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/ScrimController.java</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateScrimColor</span><span class="token punctuation">(</span><span class="token class-name">View</span> scrim<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> <span class="token keyword">int</span> tint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        alpha <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scrim <span class="token keyword">instanceof</span> <span class="token class-name">ScrimView</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ScrimView</span> scrimView <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ScrimView</span><span class="token punctuation">)</span> scrim<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tint <span class="token operator">=</span> <span class="token function">getDebugScrimTint</span><span class="token punctuation">(</span>scrimView<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceCounter</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_APP</span><span class="token punctuation">,</span> <span class="token function">getScrimName</span><span class="token punctuation">(</span>scrimView<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_alpha&quot;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>alpha <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceCounter</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_APP</span><span class="token punctuation">,</span> <span class="token function">getScrimName</span><span class="token punctuation">(</span>scrimView<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_tint&quot;</span><span class="token punctuation">,</span>
                    <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">alpha</span><span class="token punctuation">(</span>tint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            scrimView<span class="token punctuation">.</span><span class="token function">setTint</span><span class="token punctuation">(</span>tint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mIsBouncerToGoneTransitionRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                scrimView<span class="token punctuation">.</span><span class="token function">setViewAlpha</span><span class="token punctuation">(</span>alpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            scrim<span class="token punctuation">.</span><span class="token function">setAlpha</span><span class="token punctuation">(</span>alpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">dispatchScrimsVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重点看这个方法，它是设置下拉菜单栏背景scrimView的透明度的，所以我们要做的就是把alpha改为0，那么下拉菜单栏现在就是完全透明的了，修改如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateScrimColor</span><span class="token punctuation">(</span><span class="token class-name">View</span> scrim<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> <span class="token keyword">int</span> tint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">-</span>       alpha <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       alpha <span class="token operator">=</span> <span class="token number">0f</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scrim <span class="token keyword">instanceof</span> <span class="token class-name">ScrimView</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ScrimView</span> scrimView <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ScrimView</span><span class="token punctuation">)</span> scrim<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tint <span class="token operator">=</span> <span class="token function">getDebugScrimTint</span><span class="token punctuation">(</span>scrimView<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceCounter</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_APP</span><span class="token punctuation">,</span> <span class="token function">getScrimName</span><span class="token punctuation">(</span>scrimView<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_alpha&quot;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>alpha <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceCounter</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_APP</span><span class="token punctuation">,</span> <span class="token function">getScrimName</span><span class="token punctuation">(</span>scrimView<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_tint&quot;</span><span class="token punctuation">,</span>
                    <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">alpha</span><span class="token punctuation">(</span>tint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            scrimView<span class="token punctuation">.</span><span class="token function">setTint</span><span class="token punctuation">(</span>tint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mIsBouncerToGoneTransitionRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">-</span>               scrimView<span class="token punctuation">.</span><span class="token function">setViewAlpha</span><span class="token punctuation">(</span>alpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>           <span class="token punctuation">}</span>
<span class="token operator">+</span>           scrimView<span class="token punctuation">.</span><span class="token function">setViewAlpha</span><span class="token punctuation">(</span>alpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            scrim<span class="token punctuation">.</span><span class="token function">setAlpha</span><span class="token punctuation">(</span>alpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">dispatchScrimsVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里直接把所有传过来去设置背景透明度的alpha 都强制为0了，所以现在下拉菜单栏就是完全透明且有一定的模糊效果，这里的模糊效果是文件</p><p><code>frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/NotificationShadeDepthController.kt</code>增加的模糊效果</p><p>主要代码</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">computeBlurAndZoomOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Int<span class="token punctuation">,</span> Float<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> animationRadius <span class="token operator">=</span> MathUtils<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span>shadeAnimation<span class="token punctuation">.</span>radius<span class="token punctuation">,</span>
                blurUtils<span class="token punctuation">.</span>minBlurRadius<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> blurUtils<span class="token punctuation">.</span>maxBlurRadius<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> expansionRadius <span class="token operator">=</span> blurUtils<span class="token punctuation">.</span><span class="token function">blurRadiusOfRatio</span><span class="token punctuation">(</span>
                ShadeInterpolation<span class="token punctuation">.</span><span class="token function">getNotificationScrimAlpha</span><span class="token punctuation">(</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldApplyShadeBlur</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> shadeExpansion <span class="token keyword">else</span> <span class="token number">0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> combinedBlur <span class="token operator">=</span> <span class="token punctuation">(</span>expansionRadius <span class="token operator">*</span> INTERACTION_BLUR_FRACTION <span class="token operator">+</span>
                animationRadius <span class="token operator">*</span> ANIMATION_BLUR_FRACTION<span class="token punctuation">)</span>
        <span class="token keyword">val</span> qsExpandedRatio <span class="token operator">=</span> ShadeInterpolation<span class="token punctuation">.</span><span class="token function">getNotificationScrimAlpha</span><span class="token punctuation">(</span>qsPanelExpansion<span class="token punctuation">)</span> <span class="token operator">*</span>
                shadeExpansion
        combinedBlur <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>combinedBlur<span class="token punctuation">,</span> blurUtils<span class="token punctuation">.</span><span class="token function">blurRadiusOfRatio</span><span class="token punctuation">(</span>qsExpandedRatio<span class="token punctuation">)</span><span class="token punctuation">)</span>
        combinedBlur <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>combinedBlur<span class="token punctuation">,</span> blurUtils<span class="token punctuation">.</span><span class="token function">blurRadiusOfRatio</span><span class="token punctuation">(</span>transitionToFullShadeProgress<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> shadeRadius <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>combinedBlur<span class="token punctuation">,</span> wakeAndUnlockBlurRadius<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>blursDisabledForAppLaunch <span class="token operator">||</span> blursDisabledForUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            shadeRadius <span class="token operator">=</span> <span class="token number">0f</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> zoomOut <span class="token operator">=</span> MathUtils<span class="token punctuation">.</span><span class="token function">saturate</span><span class="token punctuation">(</span>blurUtils<span class="token punctuation">.</span><span class="token function">ratioOfBlurRadius</span><span class="token punctuation">(</span>shadeRadius<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> blur <span class="token operator">=</span> shadeRadius<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>inSplitShade<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            zoomOut <span class="token operator">=</span> <span class="token number">0f</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Make blur be 0 if it is necessary to stop blur effect.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scrimsVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            blur <span class="token operator">=</span> <span class="token number">0</span>
            zoomOut <span class="token operator">=</span> <span class="token number">0f</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blurUtils<span class="token punctuation">.</span><span class="token function">supportsBlursOnWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            blur <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Brightness slider removes blur, but doesn&#39;t affect zooms</span>
        blur <span class="token operator">=</span> <span class="token punctuation">(</span>blur <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1f</span> <span class="token operator">-</span> brightnessMirrorSpring<span class="token punctuation">.</span>ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token function">Pair</span><span class="token punctuation">(</span>blur<span class="token punctuation">,</span> zoomOut<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>blur = (blur * (1f - brightnessMirrorSpring.ratio)).toInt()</code>这个代码就是必要的模糊度，我们就可以根据这个值适当的增加或者减少模糊度，注意这里增加或减少一定要用乘的方式，比如当前我就是用乘</p><p>修改如下：</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blurUtils<span class="token punctuation">.</span><span class="token function">supportsBlursOnWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            blur <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Brightness slider removes blur, but doesn&#39;t affect zooms</span>
<span class="token operator">-</span>       blur <span class="token operator">=</span> <span class="token punctuation">(</span>blur <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1f</span> <span class="token operator">-</span> brightnessMirrorSpring<span class="token punctuation">.</span>ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">+</span>       blur <span class="token operator">=</span> <span class="token punctuation">(</span>blur <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1f</span> <span class="token operator">-</span> brightnessMirrorSpring<span class="token punctuation">.</span>ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token number">2</span>

        <span class="token keyword">return</span> <span class="token function">Pair</span><span class="token punctuation">(</span>blur<span class="token punctuation">,</span> zoomOut<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我乘了2，必须用乘。这样模糊度就增加了。但是还有一个问题，就是当在白色页面时，下拉模糊之后背景是白色的，我们的下拉栏的字体也是白色的，就看的不是很清楚，所以我们需要在当前模糊背景下再增加一个暗黑色，增加在如下文件：</p><p><code>frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/BlurUtils.kt</code></p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> <span class="token function">applyBlur</span><span class="token punctuation">(</span>viewRootImpl<span class="token operator">:</span> ViewRootImpl<span class="token operator">?</span><span class="token punctuation">,</span> radius<span class="token operator">:</span> Int<span class="token punctuation">,</span> opaque<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>viewRootImpl <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>viewRootImpl<span class="token punctuation">.</span>surfaceControl<span class="token punctuation">.</span>isValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token function">createTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportsBlursOnWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                it<span class="token punctuation">.</span><span class="token function">setBackgroundBlurRadius</span><span class="token punctuation">(</span>viewRootImpl<span class="token punctuation">.</span>surfaceControl<span class="token punctuation">,</span> radius<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>earlyWakeupEnabled <span class="token operator">&amp;&amp;</span> lastAppliedBlur <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> radius <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Trace<span class="token punctuation">.</span><span class="token function">asyncTraceForTrackBegin</span><span class="token punctuation">(</span>
                        TRACE_TAG_APP<span class="token punctuation">,</span>
                        TRACK_NAME<span class="token punctuation">,</span>
                        <span class="token string-literal singleline"><span class="token string">&quot;eEarlyWakeup (applyBlur)&quot;</span></span><span class="token punctuation">,</span>
                        <span class="token number">0</span>
                    <span class="token punctuation">)</span>
                    it<span class="token punctuation">.</span><span class="token function">setEarlyWakeupStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    earlyWakeupEnabled <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>earlyWakeupEnabled <span class="token operator">&amp;&amp;</span> lastAppliedBlur <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> radius <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    it<span class="token punctuation">.</span><span class="token function">setEarlyWakeupEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    Trace<span class="token punctuation">.</span><span class="token function">asyncTraceForTrackEnd</span><span class="token punctuation">(</span>TRACE_TAG_APP<span class="token punctuation">,</span> TRACK_NAME<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    earlyWakeupEnabled <span class="token operator">=</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span>
                lastAppliedBlur <span class="token operator">=</span> radius
            <span class="token punctuation">}</span>
            it<span class="token punctuation">.</span><span class="token function">setOpaque</span><span class="token punctuation">(</span>viewRootImpl<span class="token punctuation">.</span>surfaceControl<span class="token punctuation">,</span> opaque<span class="token punctuation">)</span>
            it<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以我，们用代码给viewRootImpl再增加一个暗色的就行，方法如下</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">fun</span> <span class="token function">applyBlur</span><span class="token punctuation">(</span>viewRootImpl<span class="token operator">:</span> ViewRootImpl<span class="token operator">?</span><span class="token punctuation">,</span> radius<span class="token operator">:</span> Int<span class="token punctuation">,</span> opaque<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>viewRootImpl <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>viewRootImpl<span class="token punctuation">.</span>surfaceControl<span class="token punctuation">.</span>isValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token function">createTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportsBlursOnWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                it<span class="token punctuation">.</span><span class="token function">setBackgroundBlurRadius</span><span class="token punctuation">(</span>viewRootImpl<span class="token punctuation">.</span>surfaceControl<span class="token punctuation">,</span> radius<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>earlyWakeupEnabled <span class="token operator">&amp;&amp;</span> lastAppliedBlur <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> radius <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Trace<span class="token punctuation">.</span><span class="token function">asyncTraceForTrackBegin</span><span class="token punctuation">(</span>
                        TRACE_TAG_APP<span class="token punctuation">,</span>
                        TRACK_NAME<span class="token punctuation">,</span>
                        <span class="token string-literal singleline"><span class="token string">&quot;eEarlyWakeup (applyBlur)&quot;</span></span><span class="token punctuation">,</span>
                        <span class="token number">0</span>
                    <span class="token punctuation">)</span>
                    it<span class="token punctuation">.</span><span class="token function">setEarlyWakeupStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    earlyWakeupEnabled <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>earlyWakeupEnabled <span class="token operator">&amp;&amp;</span> lastAppliedBlur <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> radius <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    it<span class="token punctuation">.</span><span class="token function">setEarlyWakeupEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    Trace<span class="token punctuation">.</span><span class="token function">asyncTraceForTrackEnd</span><span class="token punctuation">(</span>TRACE_TAG_APP<span class="token punctuation">,</span> TRACK_NAME<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    earlyWakeupEnabled <span class="token operator">=</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span>
                lastAppliedBlur <span class="token operator">=</span> radius
            <span class="token punctuation">}</span>
            it<span class="token punctuation">.</span><span class="token function">setOpaque</span><span class="token punctuation">(</span>viewRootImpl<span class="token punctuation">.</span>surfaceControl<span class="token punctuation">,</span> opaque<span class="token punctuation">)</span>
<span class="token operator">+</span>           <span class="token keyword">val</span> alpha <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">*</span> <span class="token punctuation">(</span>radius<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">+</span>           <span class="token keyword">val</span> grayColor <span class="token operator">=</span> <span class="token punctuation">(</span>alpha <span class="token operator">shl</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token number">0x101010</span>
<span class="token operator">+</span>           viewRootImpl<span class="token punctuation">.</span>view<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">setBackgroundColor</span><span class="token punctuation">(</span>grayColor<span class="token punctuation">)</span>
            it<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样下拉菜单栏背景模糊效果就大功告成，这里要用radius模糊度来设置这个背景颜色，不能用一个固定的值，否则会有闪屏发生。</p>`,26),e=[o];function c(l,i){return s(),a("div",null,e)}const k=n(t,[["render",c],["__file","SystemUIxialacaidanlangaosimohubeijingxiaoguo.html.vue"]]);export{k as default};
