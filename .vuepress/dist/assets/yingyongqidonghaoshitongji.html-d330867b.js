import{_ as e,r as t,o as p,c as o,b as s,d as n,e as c,a as i}from"./app-e8f85126.js";const l={},u=i(`<h2 id="方式一-displayed日志" tabindex="-1"><a class="header-anchor" href="#方式一-displayed日志" aria-hidden="true">#</a> 方式一：Displayed日志</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">11</span>-23 <span class="token number">10</span>:19:29.119  <span class="token number">1152</span>  <span class="token number">1240</span> I ActivityTaskManager: Displayed com.android.settings/.Settings<span class="token variable">$NetworkDashboardActivity</span> <span class="token keyword">for</span> user <span class="token number">0</span>: +668ms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>那么我们要统计计时，其实只要弄清楚这个日志的时间怎么计算出来的。跟踪源码，全局搜索Displayed发现</p><p><strong>ActivityMetricsLogger#logAppDisplayed</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">logAppDisplayed</span><span class="token punctuation">(</span><span class="token class-name">TransitionInfoSnapshot</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>type <span class="token operator">!=</span> <span class="token constant">TYPE_TRANSITION_WARM_LAUNCH</span> <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span>type <span class="token operator">!=</span> <span class="token constant">TYPE_TRANSITION_COLD_LAUNCH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token constant">WM_ACTIVITY_LAUNCH_TIME</span><span class="token punctuation">,</span>
			info<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> info<span class="token punctuation">.</span>activityRecordIdHashCode<span class="token punctuation">,</span> info<span class="token punctuation">.</span>launchedActivityShortComponentName<span class="token punctuation">,</span>
			info<span class="token punctuation">.</span>windowsDrawnDelayMs<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> mStringBuilder<span class="token punctuation">;</span>
	sb<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;Displayed &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>launchedActivityShortComponentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">TimeUtils</span><span class="token punctuation">.</span><span class="token function">formatDuration</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>windowsDrawnDelayMs<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到重点就是这个时间<strong>info.windowsDrawnDelayMs</strong>，那么这个数据是怎么来的呢？</p><p><img src="https://raw.githubusercontent.com/shug666/image/main/imagesf0c305550c894958bcda1ce590463c2d.png" alt="在这里插入图片描述"></p><h2 id="方式二-doframe" tabindex="-1"><a class="header-anchor" href="#方式二-doframe" aria-hidden="true">#</a> 方式二：doFrame</h2><p><img src="https://raw.githubusercontent.com/shug666/image/main/images9a158aba4b755abeec57f49bc7ac0f55.png" alt=""></p><p>怎么确认5是首帧的绘制，startingWindow算不算首帧？</p><p>1 -&gt; launcher 点击</p><p>2,3,4都是在ActivityThread中执行，在doFrame前进行合成</p><p><img src="https://i-blog.csdnimg.cn/blog_migrate/81ab8dc13c14baa21d21062c86bd5541.png" alt=""></p><p>renderThread启动, AttachCurrentThread初始化JNIenv ，建立native java通讯</p><h2 id="方式三-wm日志" tabindex="-1"><a class="header-anchor" href="#方式三-wm日志" aria-hidden="true">#</a> 方式三：wm日志</h2><p>过滤<code>wm_</code>日志</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>03-07 <span class="token number">16</span>:19:40.172  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">6684</span> I wm_create_activity: <span class="token punctuation">[</span><span class="token number">0,192420576</span>,20,com.UCMobile/com.uc.browser.InnerUCMobile,NULL,NULL,NULL,268435456<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.176  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">6684</span> I wm_pause_activity: <span class="token punctuation">[</span><span class="token number">0,94051834</span>,com.UCMobile/.main.UCMobile,userLeaving<span class="token operator">=</span>true,resumeTopActivity<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.191  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">6684</span> I wm_finish_activity: <span class="token punctuation">[</span><span class="token number">0,94051834</span>,20,com.UCMobile/.main.UCMobile,app-request<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.194 <span class="token number">10245</span> <span class="token number">13316</span> <span class="token number">13316</span> I wm_on_create_called: <span class="token punctuation">[</span><span class="token number">0,94051834</span>,com.UCMobile.main.UCMobile,performCreate,171<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.266  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">3389</span> I wm_add_to_stopping: <span class="token punctuation">[</span><span class="token number">0,94051834</span>,com.UCMobile/.main.UCMobile,completeFinishing<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.269  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">3389</span> I wm_add_to_stopping: <span class="token punctuation">[</span><span class="token number">0,36426290</span>,com.miui.home/.launcher.Launcher,makeInvisible<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.273  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">3389</span> I wm_restart_activity: <span class="token punctuation">[</span><span class="token number">0,192420576</span>,20,com.UCMobile/com.uc.browser.InnerUCMobile<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.276  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">3389</span> I wm_set_resumed_activity: <span class="token punctuation">[</span><span class="token number">0</span>,com.UCMobile/com.uc.browser.InnerUCMobile,minimalResumeActivityLocked - onActivityStateChanged<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.283  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">1988</span> I wm_destroy_activity: <span class="token punctuation">[</span><span class="token number">0,94051834</span>,20,com.UCMobile/.main.UCMobile,finish-imm:idle<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.305  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">3389</span> I wm_requested_orientation: <span class="token punctuation">[</span><span class="token number">1</span>,com.UCMobile<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.373 <span class="token number">10245</span> <span class="token number">13316</span> <span class="token number">13316</span> I wm_on_create_called: <span class="token punctuation">[</span><span class="token number">0,192420576</span>,com.uc.browser.InnerUCMobile,performCreate,79<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.398 <span class="token number">10245</span> <span class="token number">13316</span> <span class="token number">13316</span> I wm_on_start_called: <span class="token punctuation">[</span><span class="token number">0,192420576</span>,com.uc.browser.InnerUCMobile,handleStartActivity,18<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.414 <span class="token number">10245</span> <span class="token number">13316</span> <span class="token number">13316</span> I wm_on_resume_called: <span class="token punctuation">[</span><span class="token number">0,192420576</span>,com.uc.browser.InnerUCMobile,RESUME_ACTIVITY,14<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.502 <span class="token number">10245</span> <span class="token number">13316</span> <span class="token number">13316</span> I wm_on_top_resumed_gained_called: <span class="token punctuation">[</span><span class="token number">192420576</span>,com.uc.browser.InnerUCMobile,topStateChangedWhenResumed<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.508 <span class="token number">10245</span> <span class="token number">13316</span> <span class="token number">13316</span> I wm_on_destroy_called: <span class="token punctuation">[</span><span class="token number">0,94051834</span>,com.UCMobile.main.UCMobile,performDestroy,6<span class="token punctuation">]</span>
03-07 <span class="token number">16</span>:19:40.663  <span class="token number">1000</span>  <span class="token number">1874</span>  <span class="token number">1985</span> I wm_activity_launch_time: <span class="token punctuation">[</span><span class="token number">0,192420576</span>,com.UCMobile/com.uc.browser.InnerUCMobile,1042<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>wm_activity_launch_time</code> 看到了一个时间，怎么确定这个时间是首页展示的时间。</p><p><img src="https://raw.githubusercontent.com/shug666/image/main/images049dba08ccb0f7f72793bd267f6caf73.png" alt=""></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">int</span> <span class="token function">calculateDelay</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestampNs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Shouldn&#39;t take more than 25 days to launch an app, so int is fine here.return (int) TimeUnit.NANOSECONDS.toMillis(timestampNs - mTransitionStartTimeNs);</span>
<span class="token punctuation">}</span>

<span class="token comment">//mTransitionStartTimeNs 在activitystarter.startResolvedActivity中赋值，即点击桌面图标的时候 （表示图标动画开启）？</span>
<span class="token comment">//这里可以确定</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://raw.githubusercontent.com/shug666/image/main/images26479e1aaea495cd5da54d31b2141df2.png" alt=""></p><p><img src="https://raw.githubusercontent.com/shug666/image/main/imagesc10b2efd1809c280f94803803eb14547.png" alt=""></p><p>在notifyWindowDrawn -&gt; done中的trace，可以侧面印证在 5：doFrame中绘制的UC首帧, 并且跟evets[ wm_activity_launch_time]统计的时间只差6ms</p><p><img src="https://raw.githubusercontent.com/shug666/image/main/images221bd4f20244443492e251cf1b4db043.png" alt=""></p><h2 id="方式三-am-start" tabindex="-1"><a class="header-anchor" href="#方式三-am-start" aria-hidden="true">#</a> 方式三: am start</h2><p><code>adb shell am start -W com.android.settings/.Settings$NetworkDashboardActivity</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Starting: Intent <span class="token punctuation">{</span> <span class="token assign-left variable">act</span><span class="token operator">=</span>android.intent.action.MAIN <span class="token assign-left variable">cat</span><span class="token operator">=</span><span class="token punctuation">[</span>android.intent.category.LAUNCHER<span class="token punctuation">]</span> <span class="token assign-left variable">cmp</span><span class="token operator">=</span>com.android.settings/.Settings <span class="token punctuation">}</span>
Status: ok
LaunchState: WARM
Activity: com.android.settings/.Settings<span class="token variable">$NetworkDashboardActivity</span>
TotalTime: <span class="token number">671</span>
WaitTime: <span class="token number">675</span>
Complete
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>https://blog.csdn.net/qq_31302233/article/details/142526353</p>`,28),r={href:"https://blog.csdn.net/congqingbin/article/details/129429201",target:"_blank",rel:"noopener noreferrer"};function m(d,k){const a=t("ExternalLinkIcon");return p(),o("div",null,[u,s("p",null,[n("本文转自 "),s("a",r,[n("https://blog.csdn.net/congqingbin/article/details/129429201"),c(a)]),n("，如有侵权，请联系删除。")])])}const v=e(l,[["render",m],["__file","yingyongqidonghaoshitongji.html.vue"]]);export{v as default};
