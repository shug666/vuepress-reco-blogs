import{_ as n,o as a,c as s,a as e}from"./app-e8f85126.js";const p={},o=e(`<h2 id="_1-整体框架介绍" tabindex="-1"><a class="header-anchor" href="#_1-整体框架介绍" aria-hidden="true">#</a> 1.整体框架介绍</h2><p><img src="https://raw.githubusercontent.com/shug666/image/main/images640.png" alt=""></p><ul><li>电源键亮灭屏流程从框架上分硬件层，驱动层，Java框架层和Natvie服务层；</li><li>整个流程分为两部分，一部分是电源按键事件传递流程，一部分是亮灭屏处理流程；</li><li>中间通过一个策略类来衔接，决定按键动作是做亮屏还是灭屏动作。</li></ul><h2 id="_2-电源键传递流程" tabindex="-1"><a class="header-anchor" href="#_2-电源键传递流程" aria-hidden="true">#</a> 2.电源键传递流程</h2><h3 id="内核空间电源键传递流程" tabindex="-1"><a class="header-anchor" href="#内核空间电源键传递流程" aria-hidden="true">#</a> 内核空间电源键传递流程</h3><p><img src="https://raw.githubusercontent.com/shug666/image/main/images250120-02.png" alt=""></p><p>各层的介绍如下：</p><ul><li>设备驱动层：将底层的硬件输入转化为统一事件形式，向核心层传递；</li><li>核心层：为驱动层提供输入设备注册与操作接口，通知事件处理层对事件进行处理；</li><li>事件处理层：主要是和用户空间交互，提供设备节点来给用户空间访问；</li><li>用户空间: 从事件处理层获得事件，进行进一步的事件分发和业务处理。</li></ul><p><img src="https://raw.githubusercontent.com/shug666/image/main/imagesscreenshot-20250120-161850.png" alt=""></p><p>电源键的处理流程是：</p><p>1）按键驱动初始化的时候首先通过<code>request_irq</code>进行中断的注册；</p><p>2）当电源键按下和抬起时候，发生中断，中断处理函数被执行，调用input接口<code>input_report_key</code>和<code>input\\_sync</code>来进行事件的上报；</p><p>3）事件通过核心层和事件层后，到达用户空间，这样用户空间的程序就可以通过<code>/dev/input</code>节点和<code>getEvents</code>获得按键事件。</p><h3 id="用户空间电源键传递流程" tabindex="-1"><a class="header-anchor" href="#用户空间电源键传递流程" aria-hidden="true">#</a> 用户空间电源键传递流程</h3><p><img src="https://raw.githubusercontent.com/shug666/image/main/images250120-03.png" alt=""></p><h2 id="phonewindowmanager" tabindex="-1"><a class="header-anchor" href="#phonewindowmanager" aria-hidden="true">#</a> PhoneWindowManager</h2><p>当power键灭屏时，会在PhoneWindowManager中处理按键事件后，调用到PMS的gotoSleep()进行灭屏处理，下面直接看看PhoneWindowManger中对Power键灭屏的处理以及和PMS的交互。</p><p>当power键灭屏时，Power事件分发从<code>interceptKeyBeforeDispatching-&gt;interceptKeyBeforeQueueing</code>开始</p><p>灭屏是按下电源键后抬起的时候触发，流程这块主要看看<code>interceptPowerKeyUp</code>，做了一些长按和多次点击判断后，正常短按点击会跑到<code>PhoneWindowManager#powerPress</code>函数方法中</p><p><strong>gotoSleep方法</strong></p><p><code>powerPress</code>进一步调用<code>sleepDefaultDisplayFromPowerButton -&gt; sleepDefaultDisplay</code> 方法，进而调用到PowerManagerService的gotoSleep()进行灭屏处理的</p><blockquote><p>gotoSleep方法的参数和PowerManager,PhoneWindowManager中的同名方法对应，需要注意的是第二个参数和第三个参数； 第二个参数：表示灭屏原因，在PowerManager中定义了一些常量值来表示； 第三个参数：是一个标识，用来表示是否直接进入灭屏，一般的灭屏流程，都会先进入Doze状态，然后才会进入Sleep状态，如果将flag设置为1，则将会直接进入Sleep状态</p></blockquote><p>接下来直接看PhoneWindowManger中对Power键灭屏的处理以及和PMS的交互。</p><p><strong>堆栈：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">06.214</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">29496</span><span class="token punctuation">)</span><span class="token operator">:</span> sleepDefaultDisplay <span class="token operator">-&gt;</span> 
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">06.214</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">29496</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Exception</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">06.214</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">29496</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>policy<span class="token punctuation">.</span></span>PhoneWindowManager</span><span class="token punctuation">.</span><span class="token function">sleepDefaultDisplay</span><span class="token punctuation">(</span><span class="token class-name">PhoneWindowManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1498</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">06.214</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">29496</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>policy<span class="token punctuation">.</span></span>PhoneWindowManager</span><span class="token punctuation">.</span><span class="token function">sleepDefaultDisplayFromPowerButton</span><span class="token punctuation">(</span><span class="token class-name">PhoneWindowManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1492</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">06.214</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">29496</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>policy<span class="token punctuation">.</span></span>PhoneWindowManager</span><span class="token punctuation">.</span><span class="token function">powerPress</span><span class="token punctuation">(</span><span class="token class-name">PhoneWindowManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1277</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">06.214</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">29496</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>policy<span class="token punctuation">.</span></span>PhoneWindowManager</span><span class="token punctuation">.</span>-$$<span class="token class-name">Nest</span>$<span class="token function">mpowerPress</span><span class="token punctuation">(</span><span class="token class-name">PhoneWindowManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">06.214</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">29496</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>policy<span class="token punctuation">.</span></span>PhoneWindowManager</span>$<span class="token class-name">PowerKeyRule</span><span class="token punctuation">.</span><span class="token function">onPress</span><span class="token punctuation">(</span><span class="token class-name">PhoneWindowManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3021</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">06.214</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">29496</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>policy<span class="token punctuation">.</span></span>SingleKeyGestureDetector</span>$<span class="token class-name">KeyHandler</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">SingleKeyGestureDetector</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">476</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="powermanagerservice" tabindex="-1"><a class="header-anchor" href="#powermanagerservice" aria-hidden="true">#</a> PowerManagerService</h2><p>在goToSleep()方法中，进行权限检查后调用<strong>goToSleepInternal</strong>方法。</p><p><code>private void goToSleepInternal(long eventTime, int reason, int flags, int uid)</code></p><p>在调用PM.goToSleep()灭屏时，在除指定flag为<code>PowerManager.GO_TO_SLEEP_FLAG_NO_DOZE</code>的情况外，都会首先进入Doze，再由Doze进入Sleep。</p><p>也就是调用的dozePowerGroupLocked方法</p><blockquote><p>在PMS中定义了四种屏幕状态：</p><p>Awake状态：表示唤醒状态 Dream状态：表示处于屏保状态 Doze状态：表示处于Doze状态 Asleep状态：表示处于休眠状态</p></blockquote><h2 id="powergroup" tabindex="-1"><a class="header-anchor" href="#powergroup" aria-hidden="true">#</a> PowerGroup</h2><p>dozeLocked方法中调用setWakefulnessLocked()方法用来设置wakefulness值，同时将会调用PowerManagerServices中onWakefulnessChangedLocked相关的逻辑，从而回调到PowerManagerService.java的回调监听onWakefulnessChangedLocked方法</p><p>onWakefulnessChangedLocked方法用来设置wakefulness值，将当前wakefulness设置为Doze状态，同时将会调用Notifier中wakefulness相关的逻辑</p><h2 id="notifier" tabindex="-1"><a class="header-anchor" href="#notifier" aria-hidden="true">#</a> Notifier</h2><p>PowerManagerServices的onWakefulnessChangedLocked同时将会调用Notifier中wakefulness相关的逻辑</p><p>Notifier是PMS模块中用于进行“通知”的一个组件类，比如发送亮灭屏广播就是它来负责。针对于灭屏场景</p><p>在这个方法中，首先根据wakefulness值判断了系统当前的交互状态，如果是处于Awake状态和Dream状态，则表示可交互；如果处于Doze和Asleep状态，则表示不可交互； 由于已经设置了wakefulness为DOZE状态，因此此时处于不可交互状态，接下来开始执行handleEarlyInteractiveChange()方法： 在这个方法中，将调用mPolicy.startedGoingToSleep(why)进行锁屏流程(Keyguard的绘制)。</p><p>接着<strong>回到了PhoneWindowManager</strong></p><p>在这个方法中，将调用mPolicy.startedGoingToSleep(why)进行锁屏流程(Keyguard的绘制)。</p><p>回到PMS中，在处理完WakeFulnes相关方法后，最主要的方法就是<strong>updatePowerStateLocked</strong>了，它是整个PMS的核心，在这里我们只看其灭屏时的一些处理。</p><p><strong>堆栈：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">22.677</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span> <span class="token number">4317</span><span class="token punctuation">)</span><span class="token operator">:</span> onWakefulnessChangedLocked <span class="token operator">-&gt;</span> 
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">22.677</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span> <span class="token number">4317</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Exception</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">22.677</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span> <span class="token number">4317</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span>$<span class="token class-name">PowerGroupWakefulnessChangeListener</span><span class="token punctuation">.</span><span class="token function">onWakefulnessChangedLocked</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">827</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">22.677</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span> <span class="token number">4317</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerGroup</span><span class="token punctuation">.</span><span class="token function">setWakefulnessLocked</span><span class="token punctuation">(</span><span class="token class-name">PowerGroup</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">152</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">22.677</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span> <span class="token number">4317</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerGroup</span><span class="token punctuation">.</span><span class="token function">dozeLocked</span><span class="token punctuation">(</span><span class="token class-name">PowerGroup</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">277</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">22.677</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span> <span class="token number">4317</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span><span class="token punctuation">.</span><span class="token function">dozePowerGroupLocked</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2500</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">22.677</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span> <span class="token number">4317</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span><span class="token punctuation">.</span><span class="token function">goToSleepInternal</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">8040</span><span class="token punctuation">)</span>java
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">22.677</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span> <span class="token number">4317</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span><span class="token punctuation">.</span>-$$<span class="token class-name">Nest</span>$<span class="token function">mgoToSleepInternal</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">59</span><span class="token operator">:</span><span class="token number">22.677</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span> <span class="token number">4317</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span>$<span class="token class-name">BinderService</span><span class="token punctuation">.</span><span class="token function">goToSleep</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6933</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="powermanagerservice-updatepowerstatelocked" tabindex="-1"><a class="header-anchor" href="#powermanagerservice-updatepowerstatelocked" aria-hidden="true">#</a> PowerManagerService#updatePowerStateLocked</h2><p>接下来我们看updatePowerStateLocked，<strong>在<code>updatePowerGroupsLocked</code>此方法里面处理上层亮灭屏亮度调整动画的的关键动作：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span> sendUpdatePowerStateLocked <span class="token operator">-&gt;</span> 
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Exception</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>display<span class="token punctuation">.</span></span>DisplayPowerController</span><span class="token punctuation">.</span><span class="token function">sendUpdatePowerStateLocked</span><span class="token punctuation">(</span><span class="token class-name">DisplayPowerController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1033</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>display<span class="token punctuation">.</span></span>DisplayPowerController</span><span class="token punctuation">.</span><span class="token function">requestPowerState</span><span class="token punctuation">(</span><span class="token class-name">DisplayPowerController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">862</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>display<span class="token punctuation">.</span></span>DisplayManagerService</span>$<span class="token class-name">LocalService</span><span class="token punctuation">.</span><span class="token function">requestPowerState</span><span class="token punctuation">(</span><span class="token class-name">DisplayManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5214</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerGroup</span><span class="token punctuation">.</span><span class="token function">updateLocked</span><span class="token punctuation">(</span><span class="token class-name">PowerGroup</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">496</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span><span class="token punctuation">.</span><span class="token function">updatePowerGroupsLocked</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">4461</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span><span class="token punctuation">.</span><span class="token function">updatePowerStateLocked</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2895</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span><span class="token punctuation">.</span><span class="token function">acquireWakeLockInternal</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1851</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span><span class="token punctuation">.</span>-$$<span class="token class-name">Nest</span>$<span class="token function">macquireWakeLockInternal</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>power<span class="token punctuation">.</span></span>PowerManagerService</span>$<span class="token class-name">BinderService</span><span class="token punctuation">.</span><span class="token function">acquireWakeLock</span><span class="token punctuation">(</span><span class="token class-name">PowerManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6741</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>PowerManager</span>$<span class="token class-name">WakeLock</span><span class="token punctuation">.</span><span class="token function">acquireLocked</span><span class="token punctuation">(</span><span class="token class-name">PowerManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3949</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>PowerManager</span>$<span class="token class-name">WakeLock</span><span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token class-name">PowerManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3914</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>dreams<span class="token punctuation">.</span></span>DreamManagerService</span><span class="token punctuation">.</span><span class="token function">startDozingInternal</span><span class="token punctuation">(</span><span class="token class-name">DreamManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">572</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>dreams<span class="token punctuation">.</span></span>DreamManagerService</span><span class="token punctuation">.</span>-$$<span class="token class-name">Nest</span>$<span class="token function">mstartDozingInternal</span><span class="token punctuation">(</span><span class="token class-name">DreamManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>dreams<span class="token punctuation">.</span></span>DreamManagerService</span>$<span class="token class-name">BinderService</span><span class="token punctuation">.</span><span class="token function">startDozing</span><span class="token punctuation">(</span><span class="token class-name">DreamManagerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1110</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>service<span class="token punctuation">.</span>dreams<span class="token punctuation">.</span></span>IDreamManager</span>$<span class="token class-name">Stub</span><span class="token punctuation">.</span><span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token class-name">IDreamManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">307</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Binder</span><span class="token punctuation">.</span><span class="token function">execTransactInternal</span><span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1510</span><span class="token punctuation">)</span>
<span class="token number">01</span><span class="token operator">-</span><span class="token number">20</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">48.800</span> <span class="token class-name">D</span><span class="token operator">/</span>shugan  <span class="token punctuation">(</span><span class="token number">15767</span><span class="token punctuation">)</span><span class="token operator">:</span>   at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Binder</span><span class="token punctuation">.</span><span class="token function">execTransact</span><span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1454</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="displaypowercontroller-displaypowerstate" tabindex="-1"><a class="header-anchor" href="#displaypowercontroller-displaypowerstate" aria-hidden="true">#</a> DisplayPowerController/DisplayPowerState</h2><p>具体调用<code>requestPowerState -&gt; sendUpdatePowerStateLocked -&gt; updatePowerState -&gt; updatePowerStateInternal</code></p><ol><li><code>updateDisplayPowerStateLocked</code>调用<code>requestPowerState</code>设置<code>mPendingRequestLocked</code>变量；</li><li>调用<code>sendUpdatePowerStateLocked</code>发送<code>MSG_UPDATE_POWER_STATE</code>消息，<code>MSG_UPDATE_POWER_STATE</code>的消息处理里面调用<code>updatePowerState</code>；</li><li><code>updatePowerState -&gt; updatePowerStateInternal</code>调用<code>animateScreenStateChange</code>；</li><li>根据状态判断后调用<code>setScreenState(Display.STATE_ON) -&gt; DisplayPowerController::setScreenState() -&gt; DisplayPowerState::setScreenState()</code>，通过<code>scheduleScreenUpdate</code>启动一个<code>mScreenUpdateRunnable</code>；</li><li><code>mScreenUpdateRunnable</code>里面调用<code>mPhotonicModulator.setState(mScreenState, brightnessState)</code>,</li><li>赋值<code>mPendingBacklight</code>变量后通知<code>PhotonicModulator</code>线程去处理，调用到<code>mBlanker.requestDisplayState</code>；</li><li><code>DisplayManagerService</code>在<code>initPowerManagement</code>初始化的时候会注册<code>requestDisplayState</code>的处理，具体处理步骤是: <code>requestDisplayState -&gt; requestDisplayStateInternal-&gt;updateDisplayStateLocked</code>；</li><li><code>LocalDisplayAdapter::requestDisplayStateLocked</code>调用背光的设置函数<code>setDisplayBrightness</code>。</li></ol><p>除了调用背光外，上层还会调用亮度过渡动画，下面两个参数是对应的亮屏/灭屏的动画速度</p><p><img src="https://raw.githubusercontent.com/shug666/image/main/imagesimage-20250120171349358.png" alt="image-20250120171349358"></p><h2 id="surfacecontrol" tabindex="-1"><a class="header-anchor" href="#surfacecontrol" aria-hidden="true">#</a> SurfaceControl</h2><p>至此SurfaceControl再通过native方法通过binder通信通知surfaceflinger设置背光。</p><p><img src="https://raw.githubusercontent.com/shug666/image/main/imagesimage-20250120165604041.png" alt="image-20250120165604041"></p><p>SurfaceFlinger通过调用Hal层的实现，操作内核背光节点，从而完成背光的设置。</p><h2 id="ai总结" tabindex="-1"><a class="header-anchor" href="#ai总结" aria-hidden="true">#</a> AI总结</h2><h3 id="整体框架" tabindex="-1"><a class="header-anchor" href="#整体框架" aria-hidden="true">#</a> 整体框架</h3><p>灭屏流程涉及多个层次，包括硬件层、驱动层、Java框架层和Native服务层。整个流程可以分为两部分：电源键事件传递流程和灭屏处理流程，两者通过策略类衔接。</p><h3 id="电源键传递流程" tabindex="-1"><a class="header-anchor" href="#电源键传递流程" aria-hidden="true">#</a> 电源键传递流程</h3><h4 id="_1-内核空间传递流程" tabindex="-1"><a class="header-anchor" href="#_1-内核空间传递流程" aria-hidden="true">#</a> 1.内核空间传递流程</h4><ol><li><strong>设备驱动层</strong>：将硬件输入转换为统一事件形式，通过<code>input_report_key</code>和<code>input_sync</code>上报事件。</li><li><strong>核心层</strong>：提供输入设备注册与操作接口，通知事件处理层。</li><li><strong>事件处理层</strong>：提供<code>/dev/input</code>设备节点，供用户空间访问。</li><li><strong>用户空间</strong>：通过<code>getEvents</code>获取事件，进行分发和处理。</li></ol><h4 id="_2-用户空间传递流程" tabindex="-1"><a class="header-anchor" href="#_2-用户空间传递流程" aria-hidden="true">#</a> 2.用户空间传递流程</h4><p>电源键事件在用户空间被捕获后，传递到<code>PhoneWindowManager</code>进行处理。</p><h3 id="_1-phonewindowmanager-处理" tabindex="-1"><a class="header-anchor" href="#_1-phonewindowmanager-处理" aria-hidden="true">#</a> 1.PhoneWindowManager 处理</h3><ol><li><strong>事件分发</strong>：电源键事件在<code>PhoneWindowManager</code>中被捕获，经过<code>interceptKeyBeforeDispatching</code>和<code>interceptKeyBeforeQueueing</code>处理。</li><li><strong>短按处理</strong>：短按电源键触发<code>interceptPowerKeyUp</code>，进一步调用<code>powerPress</code>方法。</li><li><strong>灭屏调用链</strong>：<code>powerPress</code>调用<code>sleepDefaultDisplayFromPowerButton</code>，再调用<code>sleepDefaultDisplay</code>，最终调用PowerManagerService的<code>gotoSleep()</code>方法。</li></ol><h3 id="_2-powermanagerservice-处理" tabindex="-1"><a class="header-anchor" href="#_2-powermanagerservice-处理" aria-hidden="true">#</a> 2.PowerManagerService 处理</h3><ol><li><strong>权限检查</strong>：<code>gotoSleep()</code>进行权限检查。</li><li><strong>进入Doze状态</strong>：调用<code>goToSleepInternal</code>，设置wakefulness为Doze状态。</li><li><strong>进入Sleep状态</strong>：在Doze状态基础上，进一步进入Sleep状态。</li></ol><h3 id="_3-powergroup-和-wakefulness-状态" tabindex="-1"><a class="header-anchor" href="#_3-powergroup-和-wakefulness-状态" aria-hidden="true">#</a> 3.PowerGroup 和 Wakefulness 状态</h3><ol><li><strong>设置wakefulness</strong>：在<code>PowerGroup</code>中设置wakefulness为Doze状态。</li><li><strong>通知变化</strong>：通过<code>Notifier</code>通知系统状态变化，包括发送灭屏广播。</li></ol><h3 id="_4-displaypowercontroller-处理" tabindex="-1"><a class="header-anchor" href="#_4-displaypowercontroller-处理" aria-hidden="true">#</a> 4.DisplayPowerController 处理</h3><ol><li><strong>亮度调整动画</strong>：在<code>updatePowerStateLocked</code>中处理屏幕亮度调整动画。</li><li><strong>背光设置</strong>：通过<code>DisplayPowerState</code>设置背光，最终通过SurfaceControl通知SurfaceFlinger。</li></ol><h3 id="_5-surfaceflinger-处理" tabindex="-1"><a class="header-anchor" href="#_5-surfaceflinger-处理" aria-hidden="true">#</a> 5.SurfaceFlinger 处理</h3><ol><li><strong>背光设置</strong>：SurfaceFlinger通过Hal层操作内核背光节点，完成背光设置。</li></ol><h3 id="_6-关键路径和组件" tabindex="-1"><a class="header-anchor" href="#_6-关键路径和组件" aria-hidden="true">#</a> 6.关键路径和组件</h3><ul><li><strong>电源键事件传递路径</strong>：硬件 -&gt; 驱动 -&gt; 内核 -&gt; 用户空间 -&gt; PhoneWindowManager</li><li><strong>灭屏处理路径</strong>：<code>PhoneWindowManager -&gt; PowerManagerService -&gt; PowerGroup -&gt; DisplayPowerController -&gt; SurfaceFlinger</code></li><li><strong>关键组件</strong>： <ul><li>PhoneWindowManager: 处理电源键事件</li><li>PowerManagerService: 管理电源状态，控制屏幕唤醒和休眠</li><li>DisplayPowerController: 控制屏幕亮度和状态</li><li>SurfaceFlinger: 管理显示输出，设置背光</li></ul></li></ul><p>参考链接https://mp.weixin.qq.com/s/_yY5QejF1Ds17DPStfJoqQ</p>`,76),t=[o];function c(l,r){return a(),s("div",null,t)}const k=n(p,[["render",c],["__file","Powerjianmiepingliucheng.html.vue"]]);export{k as default};
