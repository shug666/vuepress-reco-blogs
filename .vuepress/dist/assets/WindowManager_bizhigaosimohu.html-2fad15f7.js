import{_ as n,o as s,c as a,a as t}from"./app-e8f85126.js";const p={},e=t(`<h2 id="_1、高斯模糊应用场景" tabindex="-1"><a class="header-anchor" href="#_1、高斯模糊应用场景" aria-hidden="true">#</a> 1、高斯模糊应用场景</h2><p>状态栏下拉时候可以看到桌面的画面作为背景，但是这个时候桌面的画面却是被高斯模糊的，这样给人交互体验上就有一个很大提升，美观层度和主次分明，就像拍照时候的人物一样，会把背景等模糊，把人物作为重点。</p><h2 id="_2、高斯模糊实现方案" tabindex="-1"><a class="header-anchor" href="#_2、高斯模糊实现方案" aria-hidden="true">#</a> 2、高斯模糊实现方案</h2><ul><li>截图背景，转化成 bitmap 进行图像处理展示模糊后 bitmap</li><li>android高版本直接传递一个参数到 SurfaceFlinger，SurfaceFlinger 可以直接对图层进行模糊</li></ul><p><img src="https://raw.githubusercontent.com/shug666/image/main/imagesv2-614a8d94cfa328381c3e65d2e2a103e8_1440w.jpg" alt=""></p><p>**方案1：**截图这种属于最为常规的方案，以前都采用该方案，主要实现原理也很简单： 对背景截图 -&gt; 对截图bitmap进行高斯模糊图像处理 -&gt;把处理后的bitmap作为背景展示</p><blockquote><p>优点：方案简单，属于所有模糊等都是自己控制，控制灵活性大</p><p>缺点：因为截图，所以没办法搞成实时模糊，实现功能修改逻辑较多</p></blockquote><p>**方案2：**这个是新版本android才有的自带方法，它的实现原理，对某一个window进行flag的设置，如果设置了FLAG_BLUR_BEHIND，那么它后面的window层就会被设置成模糊，属于surfaceflinger层面实现了，在渲染时候layer处理，这个模糊属于实时的，即后面画面哪怕在动，高斯模糊也跟着动</p><blockquote><p>优点：属于系统提供的接口相关，简单设置即可以，不需要自己额外操作，可以实时模糊</p><p>缺点：因为操作对象是window，只是窗口下面的会被模糊，导致一些窗口切换场景可能会有bug</p></blockquote><h2 id="_3、重点介绍新方案2-flag-blur-behind-使用" tabindex="-1"><a class="header-anchor" href="#_3、重点介绍新方案2-flag-blur-behind-使用" aria-hidden="true">#</a> 3、重点介绍新方案2 FLAG_BLUR_BEHIND 使用</h2><p><code>frameworks/base/core/java/android/view/WindowManager.java</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/** Window flag: enable blur behind for this window. */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">FLAG_BLUR_BEHIND</span>        <span class="token operator">=</span> <span class="token number">0x00000004</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这个FLAG_BLUR_BEHIND属于LayoutParams</p><p>注释就是说FLAG_BLUR_BEHIND就会让在该window下面的window进行模糊 具体如果要使用： 其实就是对window的LayoutParams设置这个flag</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span><span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">FLAG_BLUR_BEHIND</span><span class="token punctuation">,</span>
                <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">FLAG_BLUR_BEHIND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>同时还有另一个方法setBlurBehindRadius</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBlurBehindRadius</span><span class="token punctuation">(</span><span class="token annotation punctuation">@IntRange</span><span class="token punctuation">(</span>from <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">int</span> blurBehindRadius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mBlurBehindRadius <span class="token operator">=</span> blurBehindRadius<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>大家都知道高斯模糊都有一个模糊滤镜，这代表模糊的程度，一般mBlurBehindRadius越大模糊层度越厉害。代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span><span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">FLAG_BLUR_BEHIND</span><span class="token punctuation">,</span>
                <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">FLAG_BLUR_BEHIND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBlurBehindRadius</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置大一点为400，与通控的模糊程度保持一致</span>
    <span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4、原理源码分析" tabindex="-1"><a class="header-anchor" href="#_4、原理源码分析" aria-hidden="true">#</a> 4、原理源码分析</h2><p>设置了FLAG_BLUR_BEHIND后，最后在WindowState会进行读取和相关业务处理： <code>frameworks/base/services/core/java/com/android/server/wm/WindowState.java</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldDrawBlurBehind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>mAttrs<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token constant">FLAG_BLUR_BEHIND</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
            <span class="token operator">&amp;&amp;</span> mWmService<span class="token punctuation">.</span>mBlurController<span class="token punctuation">.</span><span class="token function">getBlurEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后在applyDims方法中根据这个进行相关的执行：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyDims</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAnimatingExit <span class="token operator">&amp;&amp;</span> mAppDied<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mIsDimming <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">getDimmer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dimAbove</span><span class="token punctuation">(</span><span class="token function">getSyncTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_DIM_AMOUNT_DEAD_WINDOW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mAttrs<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token constant">FLAG_DIM_BEHIND</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">shouldDrawBlurBehind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token operator">&amp;&amp;</span> <span class="token function">isVisibleNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mHidden<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Only show the Dimmer when the following is satisfied:</span>
            <span class="token comment">// 1. The window has the flag FLAG_DIM_BEHIND or blur behind is requested</span>
            <span class="token comment">// 2. The WindowToken is not hidden so dims aren&#39;t shown when the window is exiting.</span>
            <span class="token comment">// 3. The WS is considered visible according to the isVisible() method</span>
            <span class="token comment">// 4. The WS is not hidden.</span>
            mIsDimming <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">float</span> dimAmount <span class="token operator">=</span> <span class="token punctuation">(</span>mAttrs<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token constant">FLAG_DIM_BEHIND</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">?</span> mAttrs<span class="token punctuation">.</span>dimAmount <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> blurRadius <span class="token operator">=</span> <span class="token function">shouldDrawBlurBehind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> mAttrs<span class="token punctuation">.</span><span class="token function">getBlurBehindRadius</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">getDimmer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dimBelow</span><span class="token punctuation">(</span><span class="token function">getSyncTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> dimAmount<span class="token punctuation">,</span> blurRadius<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面来看这个 getDimmer().dimBelow方法执行：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">dimBelow</span><span class="token punctuation">(</span><span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Transaction</span> t<span class="token punctuation">,</span> <span class="token class-name">WindowContainer</span> container<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span>
                  <span class="token keyword">int</span> blurRadius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dim</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> blurRadius<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用dim方法</span>
    <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dim</span><span class="token punctuation">(</span><span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Transaction</span> t<span class="token punctuation">,</span> <span class="token class-name">WindowContainer</span> container<span class="token punctuation">,</span> <span class="token keyword">int</span> relativeLayer<span class="token punctuation">,</span>
            <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> <span class="token keyword">int</span> blurRadius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">DimState</span> d <span class="token operator">=</span> <span class="token function">getDimState</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里比较关键需要创建对应EffectLayer</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// The dim method is called from WindowState.prepareSurfaces(), which is always called</span>
            <span class="token comment">// in the correct Z from lowest Z to highest. This ensures that the dim layer is always</span>
            <span class="token comment">// relative to the highest Z layer with a dim.</span>
            t<span class="token punctuation">.</span><span class="token function">setRelativeLayer</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>mDimLayer<span class="token punctuation">,</span> container<span class="token punctuation">.</span><span class="token function">getSurfaceControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> relativeLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">setLayer</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>mDimLayer<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        t<span class="token punctuation">.</span><span class="token function">setAlpha</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>mDimLayer<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setBackgroundBlurRadius</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>mDimLayer<span class="token punctuation">,</span> blurRadius<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//对这个图层进行BlurRadius设置</span>

        d<span class="token punctuation">.</span>mDimming <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里来重点看看getDimState看看是怎么创建的：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * Retrieve the DimState, creating one if it doesn&#39;t exist.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">DimState</span> <span class="token function">getDimState</span><span class="token punctuation">(</span><span class="token class-name">WindowContainer</span> container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDimState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">SurfaceControl</span> ctl <span class="token operator">=</span> <span class="token function">makeDimLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里又调用makeDimLayer创建</span>
                mDimState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DimState</span><span class="token punctuation">(</span>ctl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token doc-comment comment">/**
                 * See documentation on <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">dimAbove</span></span><span class="token punctuation">}</span> to understand lifecycle management of
                 * Dim&#39;s via state resetting for Dim&#39;s with containers.
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mDimState<span class="token punctuation">.</span>mDontReset <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Surface<span class="token punctuation">.</span>OutOfResourcesException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;OutOfResourcesException creating dim surface&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mLastRequestedDimContainer <span class="token operator">=</span> container<span class="token punctuation">;</span>
        <span class="token keyword">return</span> mDimState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token class-name">SurfaceControl</span> <span class="token function">makeDimLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mHost<span class="token punctuation">.</span><span class="token function">makeChildSurface</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>mHost<span class="token punctuation">.</span><span class="token function">getSurfaceControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//这里host就是我们activity的task</span>
                <span class="token punctuation">.</span><span class="token function">setColorLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//注意是这种类型的layer</span>
                <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;Dim Layer for - &quot;</span> <span class="token operator">+</span> mHost<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCallsite</span><span class="token punctuation">(</span><span class="token string">&quot;Dimmer.makeDimLayer&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面代码层面分析后，来看看SurfaceFlinger相关图层有啥变化</p><p><img src="https://raw.githubusercontent.com/shug666/image/main/imagesv2-00ae403d9bae3e476ee8a52e04d91522_1440w.jpg" alt=""></p>`,30),o=[e];function c(i,l){return s(),a("div",null,o)}const k=n(p,[["render",c],["__file","WindowManager_bizhigaosimohu.html.vue"]]);export{k as default};
