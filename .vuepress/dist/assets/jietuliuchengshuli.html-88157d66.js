import{_ as n,o as s,c as a,a as t}from"./app-e8f85126.js";const p={},e=t(`<p>Android 原生截屏方式为,power键和音量下键的组合键,那么想要分析截屏流程就从按键的处理流程开始往下进行分析</p><p>1. PhoneWindowManager -- Android按键分发</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">interceptKeyBeforeQueueing</span><span class="token punctuation">(</span><span class="token class-name">KeyEvent</span> event<span class="token punctuation">,</span> <span class="token keyword">int</span> policyFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token constant">KEYCODE_VOLUME_DOWN</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token constant">KEYCODE_VOLUME_UP</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token constant">KEYCODE_VOLUME_MUTE</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>keyCode <span class="token operator">==</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token constant">KEYCODE_VOLUME_DOWN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//音量键按下</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>down<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Any activity on the vol down button stops the ringer toggle shortcut</span>
                    <span class="token function">cancelPendingRingerToggleChordAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>interactive <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mScreenshotChordVolumeDownKeyTriggered
                            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token constant">FLAG_FALLBACK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//该值在后面的判断中会需要</span>
                        mScreenshotChordVolumeDownKeyTriggered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        mScreenshotChordVolumeDownKeyTime <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getDownTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mScreenshotChordVolumeDownKeyConsumed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token function">cancelPendingPowerKeyAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">interceptScreenshotChord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">interceptAccessibilityShortcutChord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mScreenshotChordVolumeDownKeyTriggered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">cancelPendingScreenshotChordAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">cancelPendingAccessibilityShortcutAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword">case</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token constant">KEYCODE_POWER</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token class-name">EventLogTags</span><span class="token punctuation">.</span><span class="token function">writeInterceptPower</span><span class="token punctuation">(</span>
                    <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token function">actionToString</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mPowerKeyHandled <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> mPowerKeyPressCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Any activity on the power button stops the accessibility shortcut</span>
            <span class="token function">cancelPendingAccessibilityShortcutAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">ACTION_PASS_TO_USER</span><span class="token punctuation">;</span>
            isWakeKey <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// wake-up will be handled separately</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>down<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//power键按下事件处理</span>
                <span class="token function">interceptPowerKeyDown</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> interactive<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">interceptPowerKeyUp</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> interactive<span class="token punctuation">,</span> canceled<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在PhoneWindowManager中处理power键的事件及音量下键的事件, 截图时Power键为按下状态,所以去看power键的按下事件处理</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">interceptPowerKeyDown</span><span class="token punctuation">(</span><span class="token class-name">KeyEvent</span> event<span class="token punctuation">,</span> <span class="token keyword">boolean</span> interactive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//锁屏电源键状态并且检测屏幕截图</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interactive <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mScreenshotChordPowerKeyTriggered
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token constant">FLAG_FALLBACK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//power键按下的标志</span>
                mScreenshotChordPowerKeyTriggered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">//获取 Power 键的触发时间</span>
                mScreenshotChordPowerKeyTime <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getDownTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//处理屏幕截图事件</span>
                <span class="token function">interceptScreenshotChord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">interceptRingerToggleChord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">interceptScreenshotChord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        mScreenshotChordEnabled 其值为mContext.getResources().getBoolean(com.android.internal.R.bool.config_enableScreenshotChord);
        mScreenshotChordVolumeDownKeyTriggered 音量下键按下时值为true
        mScreenshotChordPowerKeyTriggered  电源键按下时值为true
        mA11yShortcutChordVolumeUpKeyTriggered 音量上键抬起时为false , 按下时为true
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenshotChordEnabled
                <span class="token operator">&amp;&amp;</span> mScreenshotChordVolumeDownKeyTriggered <span class="token operator">&amp;&amp;</span> mScreenshotChordPowerKeyTriggered
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mA11yShortcutChordVolumeUpKeyTriggered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取当前时间</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//当前时间小于 音量下键按下时间 + 150ms</span>
            <span class="token comment">//当前时间小于 power键按下时间 + 150ms </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;=</span> mScreenshotChordVolumeDownKeyTime <span class="token operator">+</span> <span class="token constant">SCREENSHOT_CHORD_DEBOUNCE_DELAY_MILLIS</span>
                    <span class="token operator">&amp;&amp;</span> now <span class="token operator">&lt;=</span> mScreenshotChordPowerKeyTime
                            <span class="token operator">+</span> <span class="token constant">SCREENSHOT_CHORD_DEBOUNCE_DELAY_MILLIS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mScreenshotChordVolumeDownKeyConsumed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">cancelPendingPowerKeyAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//使用全屏截图--type</span>
                mScreenshotRunnable<span class="token punctuation">.</span><span class="token function">setScreenshotType</span><span class="token punctuation">(</span><span class="token constant">TAKE_SCREENSHOT_FULLSCREEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mScreenshotRunnable<span class="token punctuation">.</span><span class="token function">setScreenshotSource</span><span class="token punctuation">(</span><span class="token constant">SCREENSHOT_KEY_CHORD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//执行mScreenshotRunnable</span>
                mHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>mScreenshotRunnable<span class="token punctuation">,</span> <span class="token function">getScreenshotChordLongPressDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续查看ScreenshotRunnable, 此时会一步步向下调用,最终到SystemUI</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ScreenshotRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> mScreenshotType <span class="token operator">=</span> <span class="token constant">TAKE_SCREENSHOT_FULLSCREEN</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> mScreenshotSource <span class="token operator">=</span> <span class="token constant">SCREENSHOT_KEY_OTHER</span><span class="token punctuation">;</span>
    
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setScreenshotType</span><span class="token punctuation">(</span><span class="token keyword">int</span> screenshotType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mScreenshotType <span class="token operator">=</span> screenshotType<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setScreenshotSource</span><span class="token punctuation">(</span><span class="token keyword">int</span> screenshotSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mScreenshotSource <span class="token operator">=</span> screenshotSource<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDefaultDisplayPolicy<span class="token punctuation">.</span><span class="token function">takeScreenshot</span><span class="token punctuation">(</span>mScreenshotType<span class="token punctuation">,</span> mScreenshotSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
    <span class="token comment">//向下调用至DisplayPolicy.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">takeScreenshot</span><span class="token punctuation">(</span><span class="token keyword">int</span> screenshotType<span class="token punctuation">,</span> <span class="token keyword">int</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenshotHelper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mScreenshotHelper<span class="token punctuation">.</span><span class="token function">takeScreenshot</span><span class="token punctuation">(</span>screenshotType<span class="token punctuation">,</span>
                    <span class="token function">getStatusBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getStatusBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isVisibleLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">getNavigationBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getNavigationBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isVisibleLw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    source<span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* completionConsumer */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
    <span class="token comment">//继续向下至 ScreenshotHelper.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">takeScreenshot</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> screenshotType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasStatus<span class="token punctuation">,</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasNav<span class="token punctuation">,</span> <span class="token keyword">int</span> source<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Handler</span> handler<span class="token punctuation">,</span>
                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Uri</span><span class="token punctuation">&gt;</span></span> completionConsumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ScreenshotRequest</span> screenshotRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScreenshotRequest</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> hasStatus<span class="token punctuation">,</span> hasNav<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">takeScreenshot</span><span class="token punctuation">(</span>screenshotType<span class="token punctuation">,</span> <span class="token constant">SCREENSHOT_TIMEOUT_MS</span><span class="token punctuation">,</span> handler<span class="token punctuation">,</span> screenshotRequest<span class="token punctuation">,</span>
                    completionConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    <span class="token comment">//到了 Binder调用环节, 此为客户端, 服务端为SystemUI中的 TakeScreenshotService</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">takeScreenshot</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> screenshotType<span class="token punctuation">,</span> <span class="token keyword">long</span> timeoutMs<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Handler</span> handler<span class="token punctuation">,</span>
                <span class="token class-name">ScreenshotRequest</span> screenshotRequest<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Uri</span><span class="token punctuation">&gt;</span></span> completionConsumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mScreenshotLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">Runnable</span> mScreenshotTimeout <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mScreenshotLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenshotConnection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Timed out before getting screenshot capture response&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">resetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">notifyScreenshotError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>completionConsumer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        completionConsumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> screenshotType<span class="token punctuation">,</span> screenshotRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Handler</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">case</span> <span class="token constant">SCREENSHOT_MSG_URI</span><span class="token operator">:</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>completionConsumer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    completionConsumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Uri</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                handler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>mScreenshotTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token keyword">case</span> <span class="token constant">SCREENSHOT_MSG_PROCESS_COMPLETE</span><span class="token operator">:</span>
                                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mScreenshotLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token function">resetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span>replyTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Messenger</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenshotConnection <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mScreenshotService <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//一个标准的Service连接</span>
                    <span class="token comment">//config_screenshotServiceComponent == com.android.systemui/com.android.systemui.screenshot.TakeScreenshotService</span>
                    <span class="token keyword">final</span> <span class="token class-name">ComponentName</span> serviceComponent <span class="token operator">=</span> <span class="token class-name">ComponentName</span><span class="token punctuation">.</span><span class="token function">unflattenFromString</span><span class="token punctuation">(</span>
                            mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                                    <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span>R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>config_screenshotServiceComponent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token class-name">Intent</span> serviceIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    serviceIntent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>serviceComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ServiceConnection</span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token comment">//当Service连接成功之后</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span><span class="token class-name">ComponentName</span> name<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mScreenshotLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenshotConnection <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                mScreenshotService <span class="token operator">=</span> service<span class="token punctuation">;</span>
                                <span class="token class-name">Messenger</span> messenger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Messenger</span><span class="token punctuation">(</span>mScreenshotService<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                    messenger<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Couldn&#39;t take screenshot: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>completionConsumer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        completionConsumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token comment">//当Service断开连接时</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span><span class="token class-name">ComponentName</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mScreenshotLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenshotConnection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token function">resetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token comment">// only log an error if we&#39;re still within the timeout period</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">hasCallbacks</span><span class="token punctuation">(</span>mScreenshotTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        handler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>mScreenshotTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token function">notifyScreenshotError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token comment">//bindService</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">bindServiceAsUser</span><span class="token punctuation">(</span>serviceIntent<span class="token punctuation">,</span> conn<span class="token punctuation">,</span>
                            <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_AUTO_CREATE</span> <span class="token operator">|</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">BIND_FOREGROUND_SERVICE</span><span class="token punctuation">,</span>
                            <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token constant">CURRENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mScreenshotConnection <span class="token operator">=</span> conn<span class="token punctuation">;</span>
                        handler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>mScreenshotTimeout<span class="token punctuation">,</span> timeoutMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//如果已经连接则直接发送Message</span>
                    <span class="token class-name">Messenger</span> messenger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Messenger</span><span class="token punctuation">(</span>mScreenshotService<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        messenger<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Couldn&#39;t take screenshot: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>completionConsumer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            completionConsumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    handler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>mScreenshotTimeout<span class="token punctuation">,</span> timeoutMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>客户端通过向服务端发送message来将截屏任务交给service,由service处理后面的操作</p><p>TakeScreenshotService.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Handler</span> mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取客户端传的Messenger对象</span>
            <span class="token keyword">final</span> <span class="token class-name">Messenger</span> callback <span class="token operator">=</span> msg<span class="token punctuation">.</span>replyTo<span class="token punctuation">;</span>
            <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Uri</span><span class="token punctuation">&gt;</span></span> uriConsumer <span class="token operator">=</span> uri <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Message</span> reply <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">SCREENSHOT_MSG_URI</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//Messenger 双向通信，在服务端用远程客户端的 Messenger 对象给客户端发送信息</span>
                    callback<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token class-name">Runnable</span> onComplete <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Message</span> reply <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">SCREENSHOT_MSG_PROCESS_COMPLETE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    callback<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
            <span class="token comment">//判断用户的设备是否为解锁状态</span>
            <span class="token comment">//如果用户的存储被锁定，我们没有地方存储截图，所以跳过它，而不是显示一个误导性的动画和错误通知。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mUserManager<span class="token punctuation">.</span><span class="token function">isUserUnlocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Skipping screenshot because storage is locked!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> uriConsumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">post</span><span class="token punctuation">(</span>onComplete<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">ScreenshotHelper<span class="token punctuation">.</span>ScreenshotRequest</span> screenshotRequest <span class="token operator">=</span>
                    <span class="token punctuation">(</span><span class="token class-name">ScreenshotHelper<span class="token punctuation">.</span>ScreenshotRequest</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
            mUiEventLogger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">ScreenshotEvent</span><span class="token punctuation">.</span><span class="token function">getScreenshotSource</span><span class="token punctuation">(</span>screenshotRequest<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token class-name">WindowManager</span><span class="token punctuation">.</span><span class="token constant">TAKE_SCREENSHOT_FULLSCREEN</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>全屏截图
                    <span class="token comment">//我们在PhoneWindowManager传入的type为全屏截图,所以需要执行全屏截图流程</span>
                    mScreenshot<span class="token punctuation">.</span><span class="token function">takeScreenshotFullscreen</span><span class="token punctuation">(</span>uriConsumer<span class="token punctuation">,</span> onComplete<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">WindowManager</span><span class="token punctuation">.</span><span class="token constant">TAKE_SCREENSHOT_SELECTED_REGION</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>区域截图
                    mScreenshot<span class="token punctuation">.</span><span class="token function">takeScreenshotPartial</span><span class="token punctuation">(</span>uriConsumer<span class="token punctuation">,</span> onComplete<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">WindowManager</span><span class="token punctuation">.</span><span class="token constant">TAKE_SCREENSHOT_PROVIDED_IMAGE</span><span class="token operator">:</span>
                    <span class="token class-name">Bitmap</span> screenshot <span class="token operator">=</span> <span class="token class-name">BitmapUtil</span><span class="token punctuation">.</span><span class="token function">bundleToHardwareBitmap</span><span class="token punctuation">(</span>
                            screenshotRequest<span class="token punctuation">.</span><span class="token function">getBitmapBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Rect</span> screenBounds <span class="token operator">=</span> screenshotRequest<span class="token punctuation">.</span><span class="token function">getBoundsInScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Insets</span> insets <span class="token operator">=</span> screenshotRequest<span class="token punctuation">.</span><span class="token function">getInsets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> taskId <span class="token operator">=</span> screenshotRequest<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> userId <span class="token operator">=</span> screenshotRequest<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ComponentName</span> topComponent <span class="token operator">=</span> screenshotRequest<span class="token punctuation">.</span><span class="token function">getTopComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mScreenshot<span class="token punctuation">.</span><span class="token function">handleImageAsScreenshot</span><span class="token punctuation">(</span>screenshot<span class="token punctuation">,</span> screenBounds<span class="token punctuation">,</span> insets<span class="token punctuation">,</span>
                            taskId<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> topComponent<span class="token punctuation">,</span> uriConsumer<span class="token punctuation">,</span> onComplete<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Invalid screenshot option: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TakeScreenshotService调用GlobalScreenshot.java的takeScreenshotFullscreen</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//GlobalScreenshot.java 目前Google GitHub上的代码和MTK AndroidR 基线代码稍有差异,总体流程一致</span>
<span class="token keyword">void</span> <span class="token function">takeScreenshotFullscreen</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Uri</span><span class="token punctuation">&gt;</span></span> finisher<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> onComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mOnCompleteRunnable <span class="token operator">=</span> onComplete<span class="token punctuation">;</span>
    
        mDisplay<span class="token punctuation">.</span><span class="token function">getRealMetrics</span><span class="token punctuation">(</span>mDisplayMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">takeScreenshotInternal</span><span class="token punctuation">(</span>
                finisher<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mDisplayMetrics<span class="token punctuation">.</span>widthPixels<span class="token punctuation">,</span> mDisplayMetrics<span class="token punctuation">.</span>heightPixels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">takeScreenshotInternal</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Uri</span><span class="token punctuation">&gt;</span></span> finisher<span class="token punctuation">,</span> <span class="token class-name">Rect</span> crop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// copy the input Rect, since SurfaceControl.screenshot can mutate it</span>
            <span class="token class-name">Rect</span> screenRect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span>crop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> rot <span class="token operator">=</span> mDisplay<span class="token punctuation">.</span><span class="token function">getRotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> width <span class="token operator">=</span> crop<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> height <span class="token operator">=</span> crop<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//此处调用SurfaceControl.screenshot方法进行截屏, 此方法返回一个Bitmap</span>
            <span class="token function">saveScreenshot</span><span class="token punctuation">(</span><span class="token class-name">SurfaceControl</span><span class="token punctuation">.</span><span class="token function">screenshot</span><span class="token punctuation">(</span>crop<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> rot<span class="token punctuation">)</span><span class="token punctuation">,</span> finisher<span class="token punctuation">,</span> screenRect<span class="token punctuation">,</span>
                    <span class="token class-name">Insets</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>稍有差异,但截图流程一致</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveScreenshot</span><span class="token punctuation">(</span><span class="token class-name">Bitmap</span> screenshot<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Uri</span><span class="token punctuation">&gt;</span></span> finisher<span class="token punctuation">,</span> <span class="token class-name">Rect</span> screenRect<span class="token punctuation">,</span>
            <span class="token class-name">Insets</span> screenInsets<span class="token punctuation">,</span> <span class="token keyword">boolean</span> showFlash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenshotLayout<span class="token punctuation">.</span><span class="token function">isAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// if we didn&#39;t already dismiss for another reason</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mDismissAnimation <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mDismissAnimation<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mUiEventLogger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">ScreenshotEvent</span><span class="token punctuation">.</span><span class="token constant">SCREENSHOT_REENTERED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//此方法会清除上一次的截图信息--连续截图行为</span>
            <span class="token function">dismissScreenshot</span><span class="token punctuation">(</span><span class="token string">&quot;new screenshot requested&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mScreenBitmap <span class="token operator">=</span> screenshot<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenBitmap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果没有Bitmap则报告错误信息</span>
            mNotificationsController<span class="token punctuation">.</span><span class="token function">notifyScreenshotError</span><span class="token punctuation">(</span>
                    <span class="token class-name">R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>screenshot_failed_to_capture_text<span class="token punctuation">)</span><span class="token punctuation">;</span>
            finisher<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOnCompleteRunnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isUserSetupComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//用户设置尚未完成,不应该向用户展示 分享和编辑 , 只显示一个Toast并保存图片</span>
            <span class="token function">saveScreenshotAndToast</span><span class="token punctuation">(</span>finisher<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mScreenBitmap<span class="token punctuation">.</span><span class="token function">setHasAlpha</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mScreenBitmap<span class="token punctuation">.</span><span class="token function">prepareToDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">onConfigChanged</span><span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDismissAnimation <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mDismissAnimation<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDismissAnimation<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取焦点</span>
        <span class="token function">setWindowFocusable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//开始截图后的动画</span>
        <span class="token function">startAnimation</span><span class="token punctuation">(</span>finisher<span class="token punctuation">,</span> screenRect<span class="token punctuation">,</span> screenInsets<span class="token punctuation">,</span> showFlash<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>




<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Uri</span><span class="token punctuation">&gt;</span></span> finisher<span class="token punctuation">,</span> <span class="token class-name">Rect</span> screenRect<span class="token punctuation">,</span> <span class="token class-name">Insets</span> screenInsets<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> showFlash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mScreenshotHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// mScreenshotLayout是截屏的缩略图的父View</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mScreenshotLayout<span class="token punctuation">.</span><span class="token function">isAttachedToWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mWindowManager<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>mScreenshotLayout<span class="token punctuation">,</span> mWindowLayoutParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//动画相关的View</span>
            mScreenshotAnimatedView<span class="token punctuation">.</span><span class="token function">setImageDrawable</span><span class="token punctuation">(</span>
                    <span class="token function">createScreenDrawable</span><span class="token punctuation">(</span>mScreenBitmap<span class="token punctuation">,</span> screenInsets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setAnimatedViewSize</span><span class="token punctuation">(</span>screenRect<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> screenRect<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//动画开始执行的时候才显示</span>
            mScreenshotAnimatedView<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span><span class="token constant">GONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//缩略图显示的View,将native层返回的Bitmap加载到此View上</span>
            mScreenshotPreview<span class="token punctuation">.</span><span class="token function">setImageDrawable</span><span class="token punctuation">(</span><span class="token function">createScreenDrawable</span><span class="token punctuation">(</span>mScreenBitmap<span class="token punctuation">,</span> screenInsets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mScreenshotPreview<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span><span class="token constant">INVISIBLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mScreenshotHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                mScreenshotLayout<span class="token punctuation">.</span><span class="token function">getViewTreeObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addOnComputeInternalInsetsListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//创建动画</span>
                mScreenshotAnimation <span class="token operator">=</span>
                        <span class="token function">createScreenshotDropInAnimation</span><span class="token punctuation">(</span>screenRect<span class="token punctuation">,</span> showFlash<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//保存截图</span>
                <span class="token function">saveScreenshotInWorkerThread</span><span class="token punctuation">(</span>finisher<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ActionsReadyListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">void</span> <span class="token function">onActionsReady</span><span class="token punctuation">(</span><span class="token class-name">SavedImageData</span> imageData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">showUiOnActionsReady</span><span class="token punctuation">(</span>imageData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//播放相机拍照时的声音--截图使用此声音</span>
                mCameraSound<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token class-name">MediaActionSound</span><span class="token punctuation">.</span><span class="token constant">SHUTTER_CLICK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mScreenshotPreview<span class="token punctuation">.</span><span class="token function">setLayerType</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span><span class="token constant">LAYER_TYPE_HARDWARE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mScreenshotPreview<span class="token punctuation">.</span><span class="token function">buildLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//开始执行动画</span>
                mScreenshotAnimation<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//创建一个新的工作线程，并将截图保存到媒体存储中。</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveScreenshotInWorkerThread</span><span class="token punctuation">(</span>
            <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Uri</span><span class="token punctuation">&gt;</span></span> finisher<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ActionsReadyListener</span> actionsReadyListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SaveImageInBackgroundData</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SaveImageInBackgroundData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>image <span class="token operator">=</span> mScreenBitmap<span class="token punctuation">;</span> <span class="token comment">//native层返回的Bitmap</span>
        data<span class="token punctuation">.</span>finisher <span class="token operator">=</span> finisher<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>mActionsReadyListener <span class="token operator">=</span> actionsReadyListener<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSaveInBgTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// just log success/failure for the pre-existing screenshot</span>
            mSaveInBgTask<span class="token punctuation">.</span><span class="token function">setActionsReadyListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActionsReadyListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">void</span> <span class="token function">onActionsReady</span><span class="token punctuation">(</span><span class="token class-name">SavedImageData</span> imageData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">logSuccessOnActionsReady</span><span class="token punctuation">(</span>imageData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//截图的一些存储信息在SaveImageInBackgroundTask中构建</span>
        mSaveInBgTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SaveImageInBackgroundTask</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> mScreenshotSmartActions<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSaveInBgTask<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到此截图流程完毕,可以查看下截图的View的xml文件</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token class-name">FrameLayout</span>
    xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@+id/global_screenshot_frame&quot;</span>
    android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
    android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token class-name">ImageView</span>
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@+id/global_screenshot_actions_background&quot;</span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;@dimen/screenshot_bg_protection_height&quot;</span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
        android<span class="token operator">:</span>layout_gravity<span class="token operator">=</span><span class="token string">&quot;bottom&quot;</span>
        android<span class="token operator">:</span>alpha<span class="token operator">=</span><span class="token string">&quot;0.0&quot;</span>
        android<span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">&quot;@drawable/screenshot_actions_background_protection&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>截屏动画相关的<span class="token class-name">View</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token class-name">ImageView</span>
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@+id/global_screenshot_animated_view&quot;</span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;wrap_content&quot;</span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;wrap_content&quot;</span>
        android<span class="token operator">:</span>layout_gravity<span class="token operator">=</span><span class="token string">&quot;top|start&quot;</span>
        android<span class="token operator">:</span>visibility<span class="token operator">=</span><span class="token string">&quot;gone&quot;</span>
        android<span class="token operator">:</span>elevation<span class="token operator">=</span><span class="token string">&quot;@dimen/screenshot_preview_elevation&quot;</span>
        android<span class="token operator">:</span>background<span class="token operator">=</span><span class="token string">&quot;@drawable/screenshot_rounded_corners&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token class-name">ImageView</span>
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@+id/global_screenshot_flash&quot;</span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
        android<span class="token operator">:</span>visibility<span class="token operator">=</span><span class="token string">&quot;gone&quot;</span>
        android<span class="token operator">:</span>elevation<span class="token operator">=</span><span class="token string">&quot;@dimen/screenshot_preview_elevation&quot;</span>
        android<span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">&quot;@android:color/white&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token punctuation">.</span>screenshot<span class="token punctuation">.</span></span>ScreenshotSelectorView</span>
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@+id/global_screenshot_selector&quot;</span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
        android<span class="token operator">:</span>visibility<span class="token operator">=</span><span class="token string">&quot;gone&quot;</span>
        android<span class="token operator">:</span>pointerIcon<span class="token operator">=</span><span class="token string">&quot;crosshair&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 此处包含了一个layout<span class="token punctuation">,</span> 而缩略图的<span class="token class-name">View</span>就在此layout中 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>include layout<span class="token operator">=</span><span class="token string">&quot;@layout/global_screenshot_static&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 截屏右上角的关闭缩略图按钮 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token class-name">FrameLayout</span>
        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@+id/global_screenshot_dismiss_button&quot;</span>
        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;@dimen/screenshot_dismiss_button_tappable_size&quot;</span>
        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;@dimen/screenshot_dismiss_button_tappable_size&quot;</span>
        android<span class="token operator">:</span>elevation<span class="token operator">=</span><span class="token string">&quot;7dp&quot;</span>
        android<span class="token operator">:</span>visibility<span class="token operator">=</span><span class="token string">&quot;gone&quot;</span>
        android<span class="token operator">:</span>contentDescription<span class="token operator">=</span><span class="token string">&quot;@string/screenshot_dismiss_ui_description&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token class-name">ImageView</span>
            android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">&quot;@+id/global_screenshot_dismiss_image&quot;</span>
            android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
            android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">&quot;match_parent&quot;</span>
            android<span class="token operator">:</span>layout_margin<span class="token operator">=</span><span class="token string">&quot;@dimen/screenshot_dismiss_button_margin&quot;</span>
            android<span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">&quot;@drawable/screenshot_cancel&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token class-name">FrameLayout</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token class-name">FrameLayout</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16),o=[e];function c(l,i){return s(),a("div",null,o)}const k=n(p,[["render",c],["__file","jietuliuchengshuli.html.vue"]]);export{k as default};
