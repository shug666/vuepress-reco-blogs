import{_ as p,r as c,o,c as l,b as a,d as n,e as t,a as e}from"./app-e8f85126.js";const i={},u=e(`<blockquote><p>状态栏管理服务</p><p>下拉通知面板管理服务</p></blockquote><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>StatusBar即状态栏，也就是下拉通知栏和快速设置共同组成。StatusBarManagerService也就是通知栏和快速设置的管理服务</p><h2 id="statusbarmanagerservice启动过程" tabindex="-1"><a class="header-anchor" href="#statusbarmanagerservice启动过程" aria-hidden="true">#</a> StatusBarManagerService启动过程</h2><p>代码定义在文件<code>frameworks/base/services/java/com/android/server/SystemServer.java</code>中启动StatusBarManagerService的代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disableSystemUI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">&quot;StartStatusBarManagerService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        statusBar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusBarManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> wm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">STATUS_BAR_SERVICE</span><span class="token punctuation">,</span> statusBar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,6),r={href:"http://blog.csdn.net/myfriend0/article/details/55098173",target:"_blank",rel:"noopener noreferrer"},k={href:"http://blog.csdn.net/myfriend0/article/details/54972861",target:"_blank",rel:"noopener noreferrer"},d=e(`<p>StatusBarManagerService通过ServiceManager.addService()的方式启动，那么StatusBarManagerService将是实现了AIDL，本身支持Binder通信。如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatusBarManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IStatusBarService<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个类定义在文件<code>frameworks/base/services/core/java/com/android/server/statusbar/StatusBarManagerService.java</code>中。</p></blockquote><p>还有一点是值得注意的，在实例化StatusBarManagerService的时候，还添加了一个LocalServices，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">StatusBarManagerService</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">WindowManagerService</span> windowManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
    mWindowManager <span class="token operator">=</span> windowManager<span class="token punctuation">;</span>

    <span class="token class-name">LocalServices</span><span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token class-name">StatusBarManagerInternal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mInternalService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个方法定义在文件<code>frameworks/base/services/core/java/com/android/server/statusbar/StatusBarManagerService.java</code>中。</p></blockquote>`,6),v={href:"http://blog.csdn.net/myfriend0/article/details/55098173",target:"_blank",rel:"noopener noreferrer"},m=e(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Private API used by NotificationManagerService.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StatusBarManagerInternal</span> mInternalService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusBarManagerInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个变量定义在文件<code>frameworks/base/services/core/java/com/android/server/statusbar/StatusBarManagerService.java</code>中。</p></blockquote><h2 id="statusbarmanagerservice的上层接口" tabindex="-1"><a class="header-anchor" href="#statusbarmanagerservice的上层接口" aria-hidden="true">#</a> StatusBarManagerService的上层接口</h2>`,3),b={href:"http://blog.csdn.net/myfriend0/article/details/55210074",target:"_blank",rel:"noopener noreferrer"},g=e(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">StatusBarManager</span> statusBarManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatusBarManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">STATUS_BAR_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>getSystemService(Context.STATUS_BAR_SERVICE)的调用过程如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token function">registerService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">STATUS_BAR_SERVICE</span><span class="token punctuation">,</span> <span class="token class-name">StatusBarManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">CachedServiceFetcher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StatusBarManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">StatusBarManager</span> <span class="token function">createService</span><span class="token punctuation">(</span><span class="token class-name">ContextImpl</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StatusBarManager</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个方法定义在文件<code>frameworks/base/core/java/android/app/SystemServiceRegistry.java</code>中。</p></blockquote><p>registerService()中的第一个参数<code>Context.STATUS_BAR_SERVICE</code>刚好和StatusBarManagerService启动过程中的ServiceManager.addService()的第一参数<code>Context.STATUS_BAR_SERVICE</code>一致，所以<code>getSystemService(Context.STATUS_BAR_SERVICE)</code>所获取到的对象实例就是StatusBarManager。</p><h2 id="上层接口statusbarmanager概览" tabindex="-1"><a class="header-anchor" href="#上层接口statusbarmanager概览" aria-hidden="true">#</a> 上层接口StatusBarManager概览</h2><blockquote><p><strong>注意</strong>：StatusBarManager类不向外暴露，也就是说第三方APP无法使用这个类的功能。</p></blockquote><p>StatusBarManager定义如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatusBarManager</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * Collapse the notifications and settings panels.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">collapsePanels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * Disable some features in the status bar.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">disable</span><span class="token punctuation">(</span><span class="token keyword">int</span> what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * Expand the notifications panel.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">expandNotificationsPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * Expand the settings panel.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">expandSettingsPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * Expand the settings panel and open a subPanel, pass null to just open the settings panel.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">expandSettingsPanel</span><span class="token punctuation">(</span><span class="token class-name">String</span> subPanel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * 移除StatusBar的icon.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeIcon</span><span class="token punctuation">(</span><span class="token class-name">String</span> slot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
    * 设置StatusBar的icon.
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token class-name">String</span> slot<span class="token punctuation">,</span> <span class="token keyword">int</span> iconId<span class="token punctuation">,</span> <span class="token keyword">int</span> iconLevel<span class="token punctuation">,</span> <span class="token class-name">String</span> contentDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
    * 设置StatusBar的icon的可见性.
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setIconVisibility</span><span class="token punctuation">(</span><span class="token class-name">String</span> slot<span class="token punctuation">,</span> <span class="token keyword">boolean</span> visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个类定义在文件<code>frameworks/base/core/java/android/app/StatusBarManager.java</code>中。</p></blockquote><p>StatusBarManager提供的功能不多，从上面的代码的注释，基本可以了解StatusBarManager所能提供的功能。</p><h2 id="statusbarmanager的使用" tabindex="-1"><a class="header-anchor" href="#statusbarmanager的使用" aria-hidden="true">#</a> StatusBarManager的使用</h2><p>下面以expandSettingsPanel()和setIcon()为例，阐述这两个功能的实现过程。</p><p>demo的主要代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">StatusBarManager</span> mStatusBarManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取StatusBarManager对象实例</span>
        mStatusBarManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatusBarManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">STATUS_BAR_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buttonClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>btn1<span class="token operator">:</span>
                <span class="token comment">//展开快速设置面板</span>
                mStatusBarManager<span class="token punctuation">.</span><span class="token function">expandSettingsPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> <span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>btn2<span class="token operator">:</span>
                <span class="token comment">//设置时钟图标</span>
                mStatusBarManager<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token string">&quot;clock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>clock<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="深入实现过程" tabindex="-1"><a class="header-anchor" href="#深入实现过程" aria-hidden="true">#</a> 深入实现过程</h3><h4 id="展开面板的过程" tabindex="-1"><a class="header-anchor" href="#展开面板的过程" aria-hidden="true">#</a> 展开面板的过程</h4><p>在上文中我们已经知道，StatusBarManager是StatusBarManagerService上层接口的封装，因此，mStatusBarManager.expandSettingsPanel()实质调用的是StatusBarManagerService的expandSettingsPanel()方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">expandSettingsPanel</span><span class="token punctuation">(</span><span class="token class-name">String</span> subPanel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">enforceExpandStatusBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBar <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mBar<span class="token punctuation">.</span><span class="token function">animateExpandSettingsPanel</span><span class="token punctuation">(</span>subPanel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个方法定义在文件<code>frameworks/base/services/core/java/com/android/server/statusbar/StatusBarManagerService.java</code>中。</p></blockquote><p>首先是调用了enforceExpandStatusBar()方法，该方法会检测调用者是否有展开下拉面板的权限，因此，调用者需要在Manifest文件中声明<strong>权限android.permission.EXPAND_STATUS_BAR</strong>。</p><p>接着通过mBar调用了animateExpandSettingsPanel()方法，mBar是AIDL IStatusBar的实例，mBar在手机启动的时候启动SystemUI时被实例化，mBar的实质是IStatusBar的子类CommandQueue的实例，CommandQueue定制在文件</p>`,22),S=a("code",null,"frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/CommandQueue.java",-1),f={href:"http://blog.csdn.net/myfriend0/article/details/54972861",target:"_blank",rel:"noopener noreferrer"},y=e(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">animateExpandSettingsPanel</span><span class="token punctuation">(</span><span class="token class-name">String</span> subPanel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span><span class="token constant">MSG_EXPAND_SETTINGS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token constant">MSG_EXPAND_SETTINGS</span><span class="token punctuation">,</span> subPanel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个方法定义在文件<code>frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/CommandQueue.java</code>中。</p></blockquote><p>animateExpandSettingsPanel()只是发送了一个消息，继续跟踪如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">MSG_EXPAND_SETTINGS</span><span class="token operator">:</span>
                mCallbacks<span class="token punctuation">.</span><span class="token function">animateExpandSettingsPanel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个方法定义在文件<code>frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/CommandQueue.java</code>中。</p></blockquote>`,5),h={href:"http://blog.csdn.net/myfriend0/article/details/54972861",target:"_blank",rel:"noopener noreferrer"},w=e(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">animateExpandSettingsPanel</span><span class="token punctuation">(</span><span class="token class-name">String</span> subPanel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subPanel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mQSPanel<span class="token punctuation">.</span><span class="token function">openDetails</span><span class="token punctuation">(</span>subPanel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mNotificationPanel<span class="token punctuation">.</span><span class="token function">expandWithQs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token function">postStartTracing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个方法定义在文件<code>frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBar.java</code>中。</p></blockquote><p>这里调用了mNotificationPanel的expandWithQs()方法，mNotificationPanel是NotificationPanelView的实例对象，NotificationPanelView是View的间接子类，也就是通知面板。到此，本文就不再往下跟踪这个过程了，已经超出本文所要阐述的内容。</p><h4 id="设置statusbar-icon的过程" tabindex="-1"><a class="header-anchor" href="#设置statusbar-icon的过程" aria-hidden="true">#</a> 设置StatusBar Icon的过程</h4><p>StatusBarManager的setIcon()方法和展开面板的类似，在StatusBarManagerService中定义如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token class-name">String</span> slot<span class="token punctuation">,</span> <span class="token class-name">String</span> iconPackage<span class="token punctuation">,</span> <span class="token keyword">int</span> iconId<span class="token punctuation">,</span> <span class="token keyword">int</span> iconLevel<span class="token punctuation">,</span>
            <span class="token class-name">String</span> contentDescription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">enforceStatusBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mIcons<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StatusBarIcon</span> icon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusBarIcon</span><span class="token punctuation">(</span>iconPackage<span class="token punctuation">,</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token constant">SYSTEM</span><span class="token punctuation">,</span> iconId<span class="token punctuation">,</span>
                iconLevel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> contentDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Slog.d(TAG, &quot;setIcon slot=&quot; + slot + &quot; index=&quot; + index + &quot; icon=&quot; + icon);</span>
        mIcons<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> icon<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBar <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mBar<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> icon<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个方法定义在文件<code>frameworks/base/services/core/java/com/android/server/statusbar/StatusBarManagerService.java</code>中。</p></blockquote><p>和展开面板类似，首先调用enforceStatusBar()检测调用者是否有对应的权限，这里需要检测的<strong>权限是android.permission.STATUS_BAR。</strong></p><p>接着把相关的数据封装到StatusBarIcon对象中，在某些设备中，不允许自定义Status Bar Icon，也就是说参数slot必须要配置在config.xml文件中，如下：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string-array</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>config_statusBarIcons<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">xliff:</span>g</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>@string/status_bar_rotate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">xliff:</span>g</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">xliff:</span>g</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>@string/status_bar_headset<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">xliff:</span>g</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
        ......
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">xliff:</span>g</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>@string/status_bar_data_connection<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">xliff:</span>g</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">xliff:</span>g</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>@string/status_bar_phone_evdo_signal<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">xliff:</span>g</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">xliff:</span>g</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>@string/status_bar_phone_signal<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">xliff:</span>g</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">xliff:</span>g</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>@string/status_bar_clock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">xliff:</span>g</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string-array</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这些数据定义在文件<code>frameworks/base/core/res/res/values/config.xml</code>中。</p></blockquote><p>也就是说，在某些设备，参数slot的值必须匹配上面数组中的某个item的值，才能正常显示在状态栏中。继续往下看，mBar.setIcon()，和展开面板一样，mBar.setIcon()的定义如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token class-name">String</span> slot<span class="token punctuation">,</span> <span class="token class-name">StatusBarIcon</span> icon<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mIconController<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> icon<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个方法定义在文件<code>frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBar.java</code>中。</p></blockquote><p>这里通过mIconController继续调用了setIcon()方法。到此，本文就不再往下阐述这个过程了。</p><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h3><p>本文介绍了StatusBarManagerService以及其上层接口StatusBarManager的使用，但是，StatusBarManager对于第三方APP却没有公开这个接口。本文以展开设置面板和设置状态栏图标为例，详细阐述了从上层接口StatusBarManager到SystemUI的过程。除StatusBarManager外，StatusBarManagerService是持有SystemUI的远程句柄mBar，所以系统还有其它需要和SystemUI“打交道”的功能，也会通过StatusBarManagerService。</p>`,17),B={href:"https://blog.csdn.net/myfriend0/article/details/60758265",target:"_blank",rel:"noopener noreferrer"};function x(_,M){const s=c("ExternalLinkIcon");return o(),l("div",null,[u,a("blockquote",null,[a("p",null,[n("在文章《"),a("a",r,[n("Android系统之System Server大纲"),t(s)]),n(" 》一文中的服务启动过程可知")])]),a("p",null,[n("如上面的代码，启动StatusBarManagerService是由条件disableSystemUI来控制的，如果关闭SystemUI，那么将不会启动StatusBarManagerService。StatusBar是SystemUI组成的一部分，读者对SystemUI不熟悉的可以参阅文章《 "),a("a",k,[n("SystemUI架构分析"),t(s)]),n("》。")]),d,a("p",null,[n("在文章《"),a("a",v,[n("Android系统之System Server大纲"),t(s)]),n(" 》一文中有提到LocalServices的服务的特征特点，LocalServices是进程内调用的服务，那么StatusBarManagerInternal也就是在system_process进程中使用，StatusBarManagerInternal定义如下：")]),m,a("p",null,[n("在文章《"),a("a",b,[n("Android System Server大纲之VibratorService"),t(s)]),n("》一文中有详细参数了如果去获取一个系统服务的上层接口，以及查看获取到的上层接口的本质。获取StatusBarManagerService的上层接口代码：")]),g,a("p",null,[S,n("中。读者如果不了解这个过程，可以参阅文章《"),a("a",f,[n("SystemUI架构分析"),t(s)]),n(" 》。animateExpandSettingsPanel()的实现如下：")]),y,a("p",null,[n("在处理消息的地方通过mCallbacks又调用了animateExpandSettingsPanel()，mCallbacks实质是PhoneStatusBar的实例，读者如果不了解这个过程，可以参阅文章《"),a("a",h,[n("SystemUI架构分析"),t(s)]),n(" 》。因此mCallbacks.animateExpandSettingsPanel()的定义如下：")]),w,a("p",null,[n("本文转自 "),a("a",B,[n("https://blog.csdn.net/myfriend0/article/details/60758265"),t(s)]),n("，如有侵权，请联系删除。")])])}const j=p(i,[["render",x],["__file","System_ServerdagangzhiStatusBarManagerService.html.vue"]]);export{j as default};
