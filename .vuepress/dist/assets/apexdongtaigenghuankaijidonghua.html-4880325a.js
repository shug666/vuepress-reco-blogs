import{_ as i,r as o,o as p,c as l,b as n,d as a,e,a as t}from"./app-52856ff7.js";const c={},d=t('<h2 id="环境" tabindex="-1"><a class="header-anchor" href="#环境" aria-hidden="true">#</a> 环境</h2><p>环境：Ubuntu20.04</p><p>Android版本：Android12 AOSP</p><h2 id="内容介绍" tabindex="-1"><a class="header-anchor" href="#内容介绍" aria-hidden="true">#</a> 内容介绍</h2><p>通过使用Android10的一个新内容<strong>apex</strong>文件来实现动态替换系统开机动画，apex文件是以**.apex**后缀结尾，可以不用root权限来通过adb命令安装这个文件后就可以替换开机动画。</p><h2 id="apex文件" tabindex="-1"><a class="header-anchor" href="#apex文件" aria-hidden="true">#</a> APEX文件</h2><h3 id="apex-格式" tabindex="-1"><a class="header-anchor" href="#apex-格式" aria-hidden="true">#</a> APEX 格式</h3><p>APEX 文件的格式如下图<br><img src="https://raw.githubusercontent.com/shug666/image/main/imagesfb0d5f38cc8d4a55999dee2c1fa21923.png" alt="请添加图片描述"></p><p>APEX文件中有四个文件，它们分别是</p><ul><li><p><code>apex_manifest.json</code>：这个文件里有软件的包名称和版本信息，可以用来标识文件。</p></li><li><p><code>AndroidManifest.xml</code>：这个文件允许 APEX 文件使用与 APK 相关的工具和基础架构，例如 ADB、PackageManager 和软件包安装程序应用等。这个文件还包含软件包名称和版本信息。</p></li><li><p><code>apex_payload.img</code>：是由 dm-verity 支持的 ext4 文件系统映像。该映像通过环回设备在运行时装载。常规文件包含在 <strong>apex_payload.img</strong> 文件中。</p></li><li><p><code>apex_pubkey</code>：是用于为文件系统映像签名的公钥。在运行时，此密钥可确保使用为内置分区中的相同 APEX 签名的同一实体为已下载的 APEX 签名。</p></li></ul><p>这个文件结构是编译后生成的apex文件结构，而生成apex文件的步骤在下面。</p>',11),r={href:"https://source.android.google.cn/docs/core/ota/apex",target:"_blank",rel:"noopener noreferrer"},u=t(`<h2 id="构建-apex" tabindex="-1"><a class="header-anchor" href="#构建-apex" aria-hidden="true">#</a> 构建 APEX</h2><p>构建APEX文件需要我们编写<strong>Android.bp</strong>、<strong>apex_manifest.json</strong>、<strong>AndroidManifest.xml</strong>和<strong>file_contexts</strong>这四个文件，并且还需要生成签名文件。</p><p>下面以一个名叫<code>com.android.bootanimation</code>的APEX应用包为例介绍怎样构建APEX应用包</p><h3 id="_1、创建工程目录" tabindex="-1"><a class="header-anchor" href="#_1、创建工程目录" aria-hidden="true">#</a> 1、创建工程目录</h3><p>首先新建一个名叫<code>bootanimation</code>的文件夹，然后在<code>bootanimation</code>文件夹下新建一个<code>apex</code>文件夹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> bootanimation/apex
<span class="token builtin class-name">cd</span> bootanimation/apex
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>我这里是将<code>bootanimation/apex</code>目录放到源码根目录<code>system/</code>目录下</p><ul><li>这个可以自己选择存放路径，只有是在源码根目录下就行</li></ul><h3 id="_2、创建-androidmanifest-xml-文件" tabindex="-1"><a class="header-anchor" href="#_2、创建-androidmanifest-xml-文件" aria-hidden="true">#</a> 2、创建 AndroidManifest.xml 文件</h3><p>在<code>bootanimation/apex</code>目录下创建<code>AndroidManifest.xml</code>文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">touch</span> AndroidManifest.xml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>打开<code>AndroidManifest.xml</code>文件，编写内容</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.android.com/apk/res/android<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.android.bootanimation<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- APEX does not have classes.dex --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span> <span class="token attr-name"><span class="token namespace">android:</span>hasCode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3、创建-apex-manifest-json-文件" tabindex="-1"><a class="header-anchor" href="#_3、创建-apex-manifest-json-文件" aria-hidden="true">#</a> 3、创建 apex_manifest.json 文件</h3><p>在<code>bootanimation/apex</code>目录下创建<code>apex_manifest.json</code>文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">touch</span> apex_manifest.json
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>打开<code>apex_manifest.json</code>文件，编写内容</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;com.android.bootanimation&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>这里说明一下，如果编译成功了，启动设备使用<strong>adb</strong>命令查看设备<code>apex/</code> 目录，如果出现了 <code>com.android.bootanimation</code>、<code>com.android.bootanimation@1</code>这两个文件就代表成功了，<code>@1</code>就表示我们的apex文件版本号信息。</li></ul><h3 id="_4、添加-file-context-文件" tabindex="-1"><a class="header-anchor" href="#_4、添加-file-context-文件" aria-hidden="true">#</a> 4、添加 file_context 文件</h3><p>先创建一个file_context文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">touch</span> com.haley.demo-file_contexts
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>将创建的<code>com.haley.demo-file_contexts</code>文件放在源码目录<code>/system/sepolicy/apex/</code>里面。</p><p>文件内容为</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token target symbol">(/.*)?                u</span><span class="token punctuation">:</span>object_r<span class="token punctuation">:</span>system_file<span class="token punctuation">:</span>s0
<span class="token target symbol">/lib(64)?(/.*)        u</span><span class="token punctuation">:</span>object_r<span class="token punctuation">:</span>system_lib_file<span class="token punctuation">:</span>s0
<span class="token target symbol">/bin/mediaswcodec     u</span><span class="token punctuation">:</span>object_r<span class="token punctuation">:</span>mediaswcodec_exec<span class="token punctuation">:</span>s0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5、创建-android-bp-文件" tabindex="-1"><a class="header-anchor" href="#_5、创建-android-bp-文件" aria-hidden="true">#</a> 5、创建 Android.bp 文件</h3><p>在编写Android.bp文件之前首先来简要介绍下这个文件</p><p>Android.bp 文件中的模块以<code>模块类型</code>开头，然后是一组格式属性：<code>name: value</code>。例如：</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code>prebuilt_etc <span class="token punctuation">{</span>
<span class="token target symbol">  name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation_etc&quot;</span>,
<span class="token target symbol">  src</span><span class="token punctuation">:</span> <span class="token string">&quot;bootanimation.zip&quot;</span>,
<span class="token target symbol">  filename</span><span class="token punctuation">:</span> <span class="token string">&quot;bootanimation.zip&quot;</span>,
<span class="token target symbol">  //installable</span><span class="token punctuation">:</span> true,
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中每个模块都必须具有 <code>name</code> 属性，并且相应值在所有 <code>name</code> 文件中必须是唯一的，仅有两个例外情况是命名空间和预构建模块中的 <code>Android.bp</code> 属性值，这两个值可能会重复。</p><p>如果指定了模块类型（在代码块的开头），就需要设定该模块的<code>name</code> 。此设置会为模块命名，生成的 APEX 将与模块名称相同，不过带有 <code>.apex</code> 后缀。下面这个例子中生成的apex文件名字为<code>com.android.bootanimation.apex</code>。并且我们定义了模块后都需要在apex模块对应的属性中导入进来，这样那些定义了的模块才能生效，如下：</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code>// apex模块
apex <span class="token punctuation">{</span>
<span class="token target symbol">    name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation&quot;</span>,
<span class="token target symbol">    prebuilts</span><span class="token punctuation">:</span> [<span class="token string">&quot;com.android.bootanimation_etc&quot;</span>],  // 我们定义的prebuilt_etc模块，以名字导入
<span class="token target symbol">    manifest</span><span class="token punctuation">:</span> <span class="token string">&quot;apex_manifest.json&quot;</span>,  // 导入apex_manifest.json文件
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Android.bp</code>文件的编写</p><p>（1）<code>Android.bp</code>文件</p><p>在<code>bootanimation/apex</code>目录下创建<code>Android.bp</code>文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">touch</span> Android.bp
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>（2）打开<code>Android.bp</code>文件，编写内容</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code>// 预设一些APEX值
apex_defaults <span class="token punctuation">{</span>
<span class="token target symbol">    name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation_defaults&quot;</span>,
<span class="token target symbol">    //updatable</span><span class="token punctuation">:</span> true,
<span class="token target symbol">    min_sdk_version</span><span class="token punctuation">:</span> <span class="token string">&quot;31&quot;</span>,

    // 使用自定义AndroidManifest.xml文件
<span class="token target symbol">    androidManifest</span><span class="token punctuation">:</span> <span class="token string">&quot;:com.android.bootanimation-androidManifest&quot;</span>,

    // 预设file_contexts文件
<span class="token target symbol">    file_contexts</span><span class="token punctuation">:</span> <span class="token string">&quot;:com.android.bootanimation-file_contexts&quot;</span>,

    // 共享签名信息，并设置certificate属性为系统签名
<span class="token target symbol">    key</span><span class="token punctuation">:</span> <span class="token string">&quot;apex.bootanimation.key&quot;</span>,
<span class="token target symbol">    certificate</span><span class="token punctuation">:</span> <span class="token string">&quot;platform&quot;</span>,
    
    // 预设我们自己预构建的模块
<span class="token target symbol">    prebuilts</span><span class="token punctuation">:</span> [<span class="token string">&quot;com.android.bootanimation_etc&quot;</span>],
<span class="token punctuation">}</span>

// AndroidManifest.xml模块
filegroup <span class="token punctuation">{</span>
<span class="token target symbol">    name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation_androidManifest&quot;</span>,
<span class="token target symbol">    srcs</span><span class="token punctuation">:</span> [<span class="token string">&quot;AndroidManifest.xml&quot;</span>],
<span class="token punctuation">}</span>

// vbmeta 签名文件模块
apex_key <span class="token punctuation">{</span>
<span class="token target symbol">    name</span><span class="token punctuation">:</span> <span class="token string">&quot;apex.bootanimation.key&quot;</span>,
<span class="token target symbol">    public_key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation.avbpubkey&quot;</span>,
<span class="token target symbol">    private_key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation.pem&quot;</span>,
<span class="token punctuation">}</span>

// 预构建资源模块
prebuilt_etc <span class="token punctuation">{</span>
<span class="token target symbol">  name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation_etc&quot;</span>,
<span class="token target symbol">  src</span><span class="token punctuation">:</span> <span class="token string">&quot;bootanimation.zip&quot;</span>,
<span class="token target symbol">  filename</span><span class="token punctuation">:</span> <span class="token string">&quot;bootanimation.zip&quot;</span>,
<span class="token target symbol">  //installable</span><span class="token punctuation">:</span> true,
<span class="token punctuation">}</span>

// apex模块
apex <span class="token punctuation">{</span>
<span class="token target symbol">    name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation&quot;</span>,
<span class="token target symbol">    defaults</span><span class="token punctuation">:</span> [<span class="token string">&quot;com.android.bootanimation_defaults&quot;</span>],
<span class="token target symbol">    manifest</span><span class="token punctuation">:</span> <span class="token string">&quot;apex_manifest.json&quot;</span>,
<span class="token target symbol">    updatable</span><span class="token punctuation">:</span> true, //可更新
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6、进行-vbmeta-签名" tabindex="-1"><a class="header-anchor" href="#_6、进行-vbmeta-签名" aria-hidden="true">#</a> 6、进行 vbmeta 签名</h3><p>以我们构建的<code>com.android.bootanimation</code>为例</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">source</span> build/envsetup.sh
lunch <span class="token number">12</span>     <span class="token comment"># lunch 自己的系统</span>
<span class="token builtin class-name">cd</span> bootanimation/apex <span class="token comment"># 进入apex文件目录</span>
openssl genrsa <span class="token parameter variable">-out</span> com.android.bootanimation.pem <span class="token number">4096</span>  <span class="token comment"># 执行后会生成com.android.bootanimation.pem文件</span>

avbtool extract_public_key <span class="token parameter variable">--key</span> com.android.bootanimation.pem <span class="token parameter variable">--output</span> com.android.bootanimation.avbpubkey  <span class="token comment"># 执行后会生成com.android.bootanimation.avbpubkey文件</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>签名注意 apex_key 的 name 要和 <strong>.key</strong>、<strong>.avbpubkey</strong> <em>命名要一致。</em></p></li><li><p>在执行第二条命令前我们需要先在源码根目录下导入 <code>source build/envsetup.sh</code> 环境并且<code>lunch</code>我们的Android系统后才能成功执行</p></li><li><p>执行完成后将生成的两个签名文件放入<code>bootanimation/apex</code>目录下，最好是在这个目录下执行命令</p></li></ul><p>签名完成后我们需要在<code>Android.bp</code>文件中添加签名模块，上面<strong>Android.bp</strong>文件中已添加，没有添加就加入即可，语句如下：</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code>// in Android.bp
apex_key <span class="token punctuation">{</span>
<span class="token target symbol">    name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation.key&quot;</span>,
<span class="token target symbol">    public_key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation.avbpubkey&quot;</span>,
<span class="token target symbol">    private_key</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation.pem&quot;</span>,
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7、进行-zip-签名" tabindex="-1"><a class="header-anchor" href="#_7、进行-zip-签名" aria-hidden="true">#</a> 7、进行 ZIP 签名</h3><p>因为APEX类似于APK，所以我们可以使用为 APK 签名的方式为 APEX 签名。这里一个需要为 APEX 进行两次签；一次针对迷你文件系统（<code>apex_payload.img</code> 文件），另一次针对整个文件。</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token target symbol">certificate</span><span class="token punctuation">:</span> <span class="token string">&quot;platform&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>这里具体签名方法我还不知道怎样操作，我的做法是在<code>Android.bp</code>中添加 <strong>certificate</strong> 属性来对APEX进行系统签名，已在<strong>Android.bp</strong>文件添加即可跳过</li></ul><h3 id="_8、加入我们的动画资源包" tabindex="-1"><a class="header-anchor" href="#_8、加入我们的动画资源包" aria-hidden="true">#</a> 8、加入我们的动画资源包</h3><p>将动画包 <strong>bootanimation.zip</strong> 添加到<code>bootanimation/apex</code>目录下</p><p>在Android.bp文件中添加预构建模块，语句如下：</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code>// 预构建资源模块
prebuilt_etc <span class="token punctuation">{</span>
<span class="token target symbol">  name</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation_etc&quot;</span>,
<span class="token target symbol">  src</span><span class="token punctuation">:</span> <span class="token string">&quot;bootanimation.zip&quot;</span>,
<span class="token target symbol">  filename</span><span class="token punctuation">:</span> <span class="token string">&quot;bootanimation.zip&quot;</span>,
<span class="token target symbol">  //installable</span><span class="token punctuation">:</span> true,
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>已在Android.bp文件中添加则不需要再添加</li></ul><h3 id="_9、单独编译-apex-生成-apex-包" tabindex="-1"><a class="header-anchor" href="#_9、单独编译-apex-生成-apex-包" aria-hidden="true">#</a> 9、单独编译 apex 生成 apex 包</h3><p>开始编译我们自己的<code>apex</code>模块</p><p>进入源码根目录，导入环境后单独编译我们的<code>bootanimation/apex</code>目录</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">source</span> build/envsetup.sh

mmm bootanimation/apex <span class="token comment"># 这个路径以自己的实际路径为准</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>注意这里我们只是生成apex包，如果需要先将apex包内置进系统，则这步可直接跳过进行下一步即可</li></ul><p>编译 apex 模块时，会在 <code>out/soong/.intermediates/device/generic/haley/apex/test</code> 生成 apex 的临时文件。编译成功后拷贝到 <code>out/target/product/generic_car_x86/system/apex</code> 目录下。</p><p>需要说明一点的是如果系统中没有安装对应的apex应用，那我们通过adb安装apex包时会报以下错误</p><div class="language-basic line-numbers-mode" data-ext="basic"><pre class="language-basic"><code><span class="token keyword">Error</span> [<span class="token number">1</span>] [apexd verification failed <span class="token punctuation">:</span> No preinstalled apex found <span class="token keyword">for</span> package <span class="token keyword">com</span>.android.bootanimation]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这个是系统为了安全原因， 不允许安装新应用， 只可以更新。 解决方案是可以将我们的 <strong>apex</strong> 加入到系统环境中， 添加到 device 目录的makefile 中，下面我们就介绍怎样添加。</p><h3 id="_10、系统预装-apex" tabindex="-1"><a class="header-anchor" href="#_10、系统预装-apex" aria-hidden="true">#</a> 10、系统预装 apex</h3><p>我们将我们的包名添加到系统环境中，我们在源码根目录下找到文件<code>/build/make/target/product/base_system.mk</code>，在<code>base_system.mk</code>文件这个位置中加入我们的包名称</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Base modules and settings for the system partition.</span>
PRODUCT_PACKAGES <span class="token operator">+=</span> <span class="token punctuation">\\</span>
    apex <span class="token punctuation">\\</span>
    com.android.bootanimation <span class="token punctuation">\\</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后我们进入源码根目录，导入环境后开始整编源码</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">source</span> build/envsetup.sh <span class="token comment"># 导入环境</span>
lunch   <span class="token comment"># 选择系统，选择自己的系统</span>
<span class="token function">make</span> <span class="token parameter variable">-j6</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> build.log  <span class="token comment"># 编译并输出编译日志</span>
<span class="token function">make</span> snod  <span class="token comment"># 快速打包生成最新的system.img文件，如果上一步已经生成最新的镜像文件则这一步可以不用</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>这里需要提到的是我们在将包名加入到环境中时最好是不要修改<code>/build</code>这个目录下的文件，这个是系统最基本的一个配置目录。我们一般是在 <code>/device</code> 目录进行修改</p></li><li><p>这里我添加到<code>/build</code>目录的原因是我没有在<code>/device</code> 目录下找到对应的一个配置文件，后面如果在<code>/device</code> 目录中找到了对应的配置文件则进行相应调整即可</p></li><li><p>一般在<code>device/rockchip/CPU_TYPE/device.mk</code>文件里添加</p></li></ul><h2 id="安装apex" tabindex="-1"><a class="header-anchor" href="#安装apex" aria-hidden="true">#</a> 安装APEX</h2><p>现在在设备中已经有了预装的apex应用，下面就可以进行安装和更新制作的apex应用了，需要到<code>out/target/product/generic_car_x86/system/apex</code>目录里面找到生成的apex包</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>adb <span class="token function">install</span> apex_file_name  <span class="token comment">#  apex_file_name就是我们的apex包的路径</span>
adb <span class="token function">reboot</span>  <span class="token comment"># 重启设备</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果需要卸载安装的最新版本的apex包则需要删除设备<code>/data/apex/active</code>目录下对应版本的包</p><h2 id="使用-apex" tabindex="-1"><a class="header-anchor" href="#使用-apex" aria-hidden="true">#</a> 使用 APEX</h2><p>重新启动后，APEX 会装载到 <code>/apex/&lt;apex_name&gt;@&lt;version&gt;</code> 目录中。可以同时装载同一 APEX 的多个版本。在装载路径中，对应于最新版本的路径绑定装载到 <code>/apex/&lt;apex_name&gt;</code>。</p><p>客户端可以使用绑定装载路径从 APEX 读取或执行文件。</p><p>通常可按如下方式使用 APEX：</p><ol><li><p>OEM 或 ODM 会在设备出厂时在 <code>/system/apex</code> 下预加载 APEX。</p></li><li><p>通过 <code>/apex/&lt;apex_name&gt;/</code> 路径访问 APEX 中的文件。</p></li><li><p>在 <code>/data/apex</code> 中安装 APEX 的更新后版本后，该路径将在重新启动后指向新的 APEX。</p></li></ol><p>这是Android官网文档上的原话，如需了解详细情况，可以去官网上看看。</p><h2 id="更新apex" tabindex="-1"><a class="header-anchor" href="#更新apex" aria-hidden="true">#</a> 更新APEX</h2><p>更新<strong>apex</strong>包时需要新的资源包和更新<strong>json</strong>文件和<strong>xml</strong>文件里的版本号，还需要在<strong>bp</strong>文件中加入<code>updatable: true</code>语句来让apex包可更新</p><p>（1）在json文件中修改<code>&quot;version&quot;: 1</code>语句后面的数字，比如现在版本号为1，将版本号改为2</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;com.android.bootanimation&quot;</span>,
  <span class="token string">&quot;version&quot;</span><span class="token punctuation">:</span> 2
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）修改完成后将更新好的资源包放在对应位置重新编译模块就可。</p><h2 id="卸载apex" tabindex="-1"><a class="header-anchor" href="#卸载apex" aria-hidden="true">#</a> 卸载APEX</h2><p>目前我卸载apex更新包的方法还不知道，我的做法是通过删除设备<code>data/apex/active/</code> 目录下安装的对应版本的apex包，具体操作是：</p><p>链接设备后开启<strong>root</strong>权限，然后删除<code>data/apex/active/</code>目录下对应的文件后重启设备</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>adb root  <span class="token comment"># 打开root权限</span>
adb shell  <span class="token comment"># 进入设备目录</span>
<span class="token function">rm</span> data/apex/active/com.android.bootanimation@6  <span class="token comment"># 删除对应文件</span>
adb <span class="token function">reboot</span>  <span class="token comment"># 重启设备</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="配置系统以支持-apex-更新" tabindex="-1"><a class="header-anchor" href="#配置系统以支持-apex-更新" aria-hidden="true">#</a> 配置系统以支持 APEX 更新</h2><p>将以下系统属性设置为 <code>true</code> 以支持 APEX 文件更新。</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token target symbol">&lt;device.mk&gt;</span><span class="token punctuation">:</span>

PRODUCT_PROPERTY_OVERRIDES <span class="token operator">+=</span> ro.apex.updatable<span class="token operator">=</span>true

<span class="token target symbol">BoardConfig.mk</span><span class="token punctuation">:</span>
TARGET_FLATTEN_APEX <span class="token operator">:=</span> false
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者仅设置</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token target symbol">&lt;device.mk&gt;</span><span class="token punctuation">:</span>

<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">call</span> inherit-product, <span class="token variable">$</span><span class="token punctuation">(</span>SRC_TARGET_DIR<span class="token punctuation">)</span>/product/updatable_apex.mk<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>device.mk</strong>的路径为 <code>device/rockchip/CPU_TYPE/device.mk</code></li></ul><h2 id="问题记录" tabindex="-1"><a class="header-anchor" href="#问题记录" aria-hidden="true">#</a> 问题记录</h2><p>adb 安装apex出错</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token target symbol">ai@lai-lai</span><span class="token punctuation">:</span>~/Android_12_AOSP$ adb install /home/lai/Android_12_AOSP/out/target/product/generic_car_x86/system/apex/com.android.bootanimation.apex
Performing Streamed Install
<span class="token target symbol">adb</span><span class="token punctuation">:</span> failed to install /home/lai/Android_12_AOSP/out/target/product/generic_car_x86/system/apex/com.android.bootanimation.apex<span class="token punctuation">:</span> Error [1] [apexd verification failed <span class="token punctuation">:</span> No preinstalled apex found for package com.android.bootanimation]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设备中没有预先安装apex包，系统是不能安装新的apex包的</p><p>制作新的apex包有问题</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>尝试更新apex包里面的动画包，每次重新编译都是以前的动画包，就好像没有效果。做法是将我源码目录下的动画包替换成另一个动画包然后重新编译的，然后生成的新的apex包没有变化
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>需要在Android.bp文件中加上<code>updatable: true,</code>让apex包可以更新，并且需要更改apex_manifest.json</p><p>在板子上安装apex包出错</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token target symbol">lai@lai-lai</span><span class="token punctuation">:</span>~$ adb install /home/lai/文档/开关机动画资源/自制/apex包/v2/com.android.bootanimation.apex
Performing Streamed Install
<span class="token target symbol">adb</span><span class="token punctuation">:</span> failed to install /home/lai/文档/开关机动画资源/自制/apex包/v2/com.android.bootanimation.apex<span class="token punctuation">:</span> 
Exception occurred while executing <span class="token string">&#39;install&#39;</span><span class="token punctuation">:</span>
java.lang<span class="token builtin-target builtin">.IllegalArgumentException</span><span class="token punctuation">:</span> This device doesn&#39;t support the installation of APEX files
  at com.android.server.pm<span class="token builtin-target builtin">.PackageInstallerService.createSessionInternal(PackageInstallerService.java</span><span class="token punctuation">:</span>643<span class="token punctuation">)</span>
  at com.android.server.pm<span class="token builtin-target builtin">.PackageInstallerService.createSession(PackageInstallerService.java</span><span class="token punctuation">:</span>519<span class="token punctuation">)</span>
  at com.android.server.pm<span class="token builtin-target builtin">.PackageManagerShellCommand.doCreateSession(PackageManagerShellCommand.java</span><span class="token punctuation">:</span>3161<span class="token punctuation">)</span>
  at com.android.server.pm<span class="token builtin-target builtin">.PackageManagerShellCommand.doRunInstall(PackageManagerShellCommand.java</span><span class="token punctuation">:</span>1343<span class="token punctuation">)</span>
  at com.android.server.pm<span class="token builtin-target builtin">.PackageManagerShellCommand.runInstall(PackageManagerShellCommand.java</span><span class="token punctuation">:</span>1305<span class="token punctuation">)</span>
  at com.android.server.pm<span class="token builtin-target builtin">.PackageManagerShellCommand.onCommand(PackageManagerShellCommand.java</span><span class="token punctuation">:</span>193<span class="token punctuation">)</span>
  at com.android.modules.utils<span class="token builtin-target builtin">.BasicShellCommandHandler.exec(BasicShellCommandHandler.java</span><span class="token punctuation">:</span>97<span class="token punctuation">)</span>
  at android.os<span class="token builtin-target builtin">.ShellCommand.exec(ShellCommand.java</span><span class="token punctuation">:</span>38<span class="token punctuation">)</span>
  at com.android.server.pm<span class="token builtin-target builtin">.PackageManagerService.onShellCommand(PackageManagerService.java</span><span class="token punctuation">:</span>24932<span class="token punctuation">)</span>
  at android.os<span class="token builtin-target builtin">.Binder.shellCommand(Binder.java</span><span class="token punctuation">:</span>950<span class="token punctuation">)</span>
  at android.os<span class="token builtin-target builtin">.Binder.onTransact(Binder.java</span><span class="token punctuation">:</span>834<span class="token punctuation">)</span>
  at android.content.pm<span class="token builtin-target builtin">.IPackageManager$Stub.onTransact(IPackageManager.java</span><span class="token punctuation">:</span>4891<span class="token punctuation">)</span>
  at com.android.server.pm<span class="token builtin-target builtin">.PackageManagerService.onTransact(PackageManagerService.java</span><span class="token punctuation">:</span>8890<span class="token punctuation">)</span>
  at android.os<span class="token builtin-target builtin">.Binder.execTransactInternal(Binder.java</span><span class="token punctuation">:</span>1184<span class="token punctuation">)</span>
  at android.os<span class="token builtin-target builtin">.Binder.execTransact(Binder.java</span><span class="token punctuation">:</span>1143<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>问题：设备不支持安装APEX文件</p><p>需要修改系统配置以支持apex包的更新</p><p>通过搜索项目源码目录里<code>This device doesn&#39;t support the installation of APEX files</code>这条语句搜到了下面内容</p><p>执行语句</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">grep</span> <span class="token string">&quot;This device doesn&#39;t support the installation of APEX files&quot;</span> ./ <span class="token parameter variable">-rn</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>搜索到的内容</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">.</span>/frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>pm<span class="token operator">/</span><span class="token class-name">PackageInstallerService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">644</span><span class="token operator">:</span>                    <span class="token string">&quot;This device doesn&#39;t support the installation of APEX files&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span>/cts<span class="token operator">/</span>hostsidetests<span class="token operator">/</span>stagedinstall<span class="token operator">/</span>app<span class="token operator">/</span>src<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>tests<span class="token operator">/</span>stagedinstall<span class="token operator">/</span><span class="token class-name">StagedInstallTest</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">724</span><span class="token operator">:</span>                <span class="token string">&quot;This device doesn&#39;t support the installation of APEX files&quot;</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token target symbol">lai@lai-lai</span><span class="token punctuation">:</span>~/git/gt-cockpit-rk3588$ adb install /home/lai/文档/开关机动画资源/ 自制/apex包/v3/com.android.bootanimation.apex
Performing Streamed Install
<span class="token target symbol">adb</span><span class="token punctuation">:</span> failed to install /home/lai/文档/开关机动画资源/自制/apex包/v3/com.android.bootanimation.apex<span class="token punctuation">:</span> Error [1] [APK-container signature of APEX package com.android.bootanimation with version 0 and path /data/app-staging/session_870137356/base.apex is not compatible with the one currently installed on device]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,110),m={href:"https://blog.csdn.net/etrospect/article/details/128582957#t13",target:"_blank",rel:"noopener noreferrer"};function v(b,k){const s=o("ExternalLinkIcon");return p(),l("div",null,[d,n("p",null,[a("附上官网文档链接："),n("a",r,[a("APEX 文件格式"),e(s)])]),u,n("p",null,[a("本文转自 "),n("a",m,[a("https://blog.csdn.net/etrospect/article/details/128582957#t13"),e(s)]),a("，如有侵权，请联系删除。")])])}const h=i(c,[["render",v],["__file","apexdongtaigenghuankaijidonghua.html.vue"]]);export{h as default};
